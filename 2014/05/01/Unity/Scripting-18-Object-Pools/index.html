<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Unity对象池(Object Pools) | 吐司片的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="One issue was brought to my attention in the comment by broxxar. As mentioned in this thread http://forum.unity3d.com/threads/unityengine-object-name-allocates-for-each-access.237380/ and as I saw it">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity对象池(Object Pools)">
<meta property="og:url" content="http://tospan.me/2014/05/01/Unity/Scripting-18-Object-Pools/index.html">
<meta property="og:site_name" content="吐司片的博客">
<meta property="og:description" content="One issue was brought to my attention in the comment by broxxar. As mentioned in this thread http://forum.unity3d.com/threads/unityengine-object-name-allocates-for-each-access.237380/ and as I saw it">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/object-pools-tutorial-image.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/counter-assets.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/counter-object.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/counter-scene.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/cube-prefab.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/stuff-prefabs.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/spawner.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/spawn.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/velocity.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/tower-of-stuff.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/ring.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/much-stuff.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/kill-zone.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/tag.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/killed-spawn.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/PositiveRichHatchetfish.mp4">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/spawn-time-range.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/scale-range.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/random-velocity-range.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/angular-velocity-range.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/randomized-stuff.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/MiniatureDefenselessGeese.mp4">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/material.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/ring-materials.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/colored-stuff.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/sphere.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/WeightyBronzeFawn.mp4">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/profiler.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/cross.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/cross-preview.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/array-with-cross.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/fountain-with-cross.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/caltrop.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/caltrop-preview.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/array-with-caltrop.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/fountain-with-caltrops.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/profiling-finding-objects.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/pool-instances.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/scene-switcher.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/button.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/scenes.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/wrong-lighting.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/EsteemedWarmheartedLadybird.mp4">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/QueasyPessimisticDugong.mp4">
<meta property="og:updated_time" content="2017-02-07T09:09:23.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unity对象池(Object Pools)">
<meta name="twitter:description" content="One issue was brought to my attention in the comment by broxxar. As mentioned in this thread http://forum.unity3d.com/threads/unityengine-object-name-allocates-for-each-access.237380/ and as I saw it">
<meta name="twitter:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/object-pools-tutorial-image.jpg">
  
    <link rel="alternate" href="/atom.xml" title="吐司片的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  

</head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">吐司片的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Work hard, play hard.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://tospan.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Unity/Scripting-18-Object-Pools" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/01/Unity/Scripting-18-Object-Pools/" class="article-date">
  <time datetime="2014-05-01T09:09:23.000Z" itemprop="datePublished">2014-05-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Unity/">Unity</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Unity对象池(Object Pools)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>One issue was brought to my attention in the comment by broxxar. As mentioned in this thread <a href="http://forum.unity3d.com/threads/unityengine-object-name-allocates-for-each-access.237380/" target="_blank" rel="external">http://forum.unity3d.com/threads/unityengine-object-name-allocates-for-each-access.237380/</a> and as I saw it in the profiler, the call gameObject.name creates an allocation of 40B each call.I will later come up with a new version that avoid that problem.<br>Most games tend to make heavy use of short-lived objects. The first reflex of any programmer is to create a new object when needed and get rid of needed when done with it. Problem is that creating is slow and releasing may lead to a garbage collection which is also slow. One solution would be reuse identical items to avoid those two problems or at least to minimize them.</p>
<p>In this article we will keep it short and simple so you can start using it right on. Later on, we may add some more features.</p>
<a id="more"></a>
<h2 id="What-is-a-pool"><a href="#What-is-a-pool" class="headerlink" title="What is a pool?"></a>What is a pool?</h2><p>In our case a pool is just a like a bag in which we store items/objects. Before we start implementing, let’s take a minute to think how and why. Our pool should be a class most obviously, no wonder about that. this class should not be inherited to avoid any wrong doing with the existing code. Finally, there should be only one of it since we want to have all items in one bag and accessible from anywhere. This latest statement is personal and could be argued. One could say that one pool could be for a certain type of object and then other types should have their own pool. Up to you. We will make one to rule them all.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">ObjectPool</span> </div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ObjectPool instance = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ObjectPool Instance </div><div class="line">    &#123;</div><div class="line">        <span class="keyword">get</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (instance==<span class="literal">null</span>)</div><div class="line">            &#123;</div><div class="line">                instance = <span class="keyword">new</span> ObjectPool();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> instance;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>) </span></div><div class="line">    &#123;</div><div class="line">         instance = <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ObjectPool</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The class is sealed to avoid any sub class (one could argue to make it static), it has a basic singleton pattern and an explicit private constructor as we do not want the user to call many constructor. The Reset method is just there to set the instance to null, the GC will do the rest.</p>
<h2 id="The-interface"><a href="#The-interface" class="headerlink" title="The interface"></a>The interface</h2><p>Next, we should consider the interface of the class. In this case, we will not create an actual interface, we will simply make some methods public allowing the user to interact with the class. Just like an interface.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">AddToPool</span>(<span class="params">GameObject prefab, <span class="keyword">int</span> count, Transform parent = <span class="literal">null</span></span>) </span>&#123; &#125;</div><div class="line"><span class="function"><span class="keyword">public</span> GameObject <span class="title">PopFromPool</span>(<span class="params"><span class="keyword">string</span> prefabName, <span class="keyword">bool</span> forceInstantiate = <span class="literal">false</span>, </span></span></div><div class="line">    <span class="keyword">bool</span> instantiateIfNone = <span class="literal">false</span>, Transform container = <span class="literal">null</span>) &#123; <span class="keyword">return</span> <span class="literal">null</span>;&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> GameObject <span class="title">PopFromPool</span>(<span class="params">GameObject prefab, <span class="keyword">bool</span> forceInstantiate = <span class="literal">false</span>, </span></span></div><div class="line">    <span class="keyword">bool</span> instantiateIfNone = <span class="literal">false</span>, Transform container = <span class="literal">null</span>)&#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PushToPool</span>(<span class="params"> <span class="keyword">ref</span> GameObject obj, <span class="keyword">bool</span> retainObject = <span class="literal">true</span>, </span></span></div><div class="line">    Transform parent = <span class="literal">null</span>) &#123; &#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReleaseItems</span>(<span class="params">GameObject prefab, <span class="keyword">bool</span> destroyObject = <span class="literal">false</span></span>) </span>&#123; &#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReleasePool</span>(<span class="params"></span>) </span>&#123; &#125;</div></pre></td></tr></table></figure>
<p>Each method represents a moment of the lifecycle of the object.</p>
<ol>
<li>Creation -&gt; AddToPool</li>
<li>Usage -&gt; PopFromPool</li>
<li>End of usage -&gt; PushToPool</li>
<li>Destruction -&gt; ReleaseItems</li>
<li>Get rid of the pool -&gt; ReleasePool</li>
</ol>
<p>The pool is generic, not that it uses generic code but that it returns the highest level of abstraction in Unity, a GameObject reference. The reason is that we use prefab to determine the items so it would make sense to fetch the matching item instead of looking for a type of script. It also makes sense that grabbing a specific game object indirectly means grabbing a set of scripts that it contains.</p>
<h2 id="The-concept"><a href="#The-concept" class="headerlink" title="The concept"></a>The concept</h2><p>So the concept is simple, we want that providing a certain information, we are given a corresponding item. Somehow, we could say we give a key and we want a value. So the appropriate data collection to be used should be a dictionary since it is just what it does. Then via our interface, we add items to the dictionary, get items from it or reassigned items to it.</p>
<p>Our pool should not only be one key for one value so the best case is a dictionary with a prefab as key and a list of instantiated objects of that prefab as the value.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Dictionary&lt;<span class="keyword">string</span>, Queue&lt;GameObject&gt;&gt; container = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Queue&lt;GameObject&gt;&gt;();</div><div class="line"><span class="keyword">private</span> Dictionary&lt;<span class="keyword">string</span>, GameObject&gt; prefabContainer = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, GameObject&gt;();</div></pre></td></tr></table></figure>
<p>Using a dictionary enables the fact we can extend freely the amount of key without constantly checking for a size.<br>Our dictionary will take a string as key and is linked to a Queue of GameObject instances.</p>
<p>The prefabContainer will store our prefab references so that we can add new items if needed later on in the project.</p>
<h2 id="Adding-items"><a href="#Adding-items" class="headerlink" title="Adding items"></a>Adding items</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">AddToPool</span>(<span class="params">GameObject prefab, <span class="keyword">int</span> count, Transform parent = <span class="literal">null</span></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(prefab == <span class="literal">null</span> || count &lt;= <span class="number">0</span>)&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line">    <span class="keyword">string</span> name = prefab.name;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.prefabContainer.ContainsKey(name) == <span class="literal">false</span>) </div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.prefabContainer.Add(name, prefab);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.prefabContainer[name] == <span class="literal">null</span>) </div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.prefabContainer[name] = prefab;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count ; i++)</div><div class="line">    &#123;</div><div class="line">        GameObject obj = PopFromPool(name, <span class="literal">true</span>);</div><div class="line">        PushToPool(<span class="keyword">ref</span> obj, <span class="literal">true</span>, parent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The method returns bool to make sure it all went fine. It takes three parameters, the first one is the prefab we want to instantiate, some bullets for instance. The second parameter indicates how many we wantto begin with (this can be changed later on). The last parameter is not compulsory and is set to null by default. It allows to keep a neat scene hierarchy by storing items under a specific game object. So you may add an empty game object to your scene and call it BulletContainer. Then pass the transform of that object to the method and all newly created bullet will go under it.</p>
<p>First, we do a couple of checks to make sure the call is not done wrong, we make sure the prefab is registered in the prefabContainer, then start a loop to create each object. So far, nothing special since the method we are using are not yet implemented. The method can be used in the Awake or Start of some manager script.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[SerializeField] <span class="keyword">private</span> GameObject bulletPrefab = <span class="literal">null</span>;</div><div class="line">[SerializeField] <span class="keyword">private</span> Transform bulletContainer = <span class="literal">null</span>;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    ObjectPool.Instance.AddToPool(<span class="keyword">this</span>.bulletPrefab, <span class="number">20</span>, <span class="keyword">this</span>.bulletContainer);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Getting-to-create"><a href="#Getting-to-create" class="headerlink" title="Getting to create"></a>Getting to create</h2><p>The first method we used in AddToPool may seem awkward since it tries to get from the pool while we are trying to add into the pool. Let’s look at the implementation.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> GameObject <span class="title">PopFromPool</span>(<span class="params">GameObject prefab, <span class="keyword">bool</span> forceInstantiate = <span class="literal">false</span>, </span></span></div><div class="line">    <span class="keyword">bool</span> instantiateIfNone = <span class="literal">false</span>, Transform container = <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(prefab == <span class="literal">null</span>) &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</div><div class="line">    <span class="keyword">return</span> PopFromPool(prefab.name, forceInstantiate);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> GameObject <span class="title">PopFromPool</span>(<span class="params"><span class="keyword">string</span> prefabName, <span class="keyword">bool</span> forceInstantiate = <span class="literal">false</span>, </span></span></div><div class="line">    <span class="keyword">bool</span> instantiateIfNone = <span class="literal">false</span>, Transform container = <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (prefabName == <span class="literal">null</span>|| <span class="keyword">this</span>.prefabContainer.ContainsKey(prefabName) == <span class="literal">false</span>) </div><div class="line">    &#123; </div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span>; </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (forceInstantiate == <span class="literal">true</span>) &#123; <span class="keyword">return</span> CreateObject(prefabName, container); &#125;</div><div class="line">    GameObject obj = <span class="literal">null</span>;</div><div class="line">    Queue&lt;GameObject&gt; queue = FindInContainer(prefabName);</div><div class="line">    <span class="keyword">if</span> (queue.Count &gt; <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        obj = queue.Dequeue();</div><div class="line">        obj.transform.parent = container;</div><div class="line">        obj.SetActive(<span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (obj == <span class="literal">null</span> &amp;&amp; instantiateIfNone == <span class="literal">true</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> CreateObject(prefabName, container);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The method returns a GameObject reference and takes the prefab as first parameter a boolean indicating whether we want to force the instantiation or not, then whether we want to create if we did not find any available item and finally a container transform. All those parameters are just there to be used in specific situation so they can be left as default. It is all up to the situation to define whether they are useful or not. You may consider the latest one for instance to be useless, it may be most of the time.</p>
<p>The first method is used when we have the reference to the prefab (probably in a manager), the second method will use the name of the prefab so a string will do, no need for a prefab reference.</p>
<p>Again, we first check if we got all we need. If we have forceInstantiate as true, it means we are simply creating a new object. Comes a call for a new method we will look at in a moment. This method returns a Queue<gameobject> reference. and if the collection is not empty, we dequeue an item out of it. In the case the queue was not empty but we did not get anything out (a reference may be null) or the queue was empty, it will get to the next stage where we check if the instantiateIfNone is set. Then we create a new instance.</gameobject></p>
<p>You may wonder the difference between forceInstantiate and instantiateIfNone. The first is used when you want a new object whatever happens, at start or you are just adding new items to the level. Even though you have a full Queue, you would still get a new item. The second only creates if something went wrong or the Queue was empty. This comes for instance when you have been shooting all the bullets and you do not want to remain empty on a new shot of your player.</p>
<p>Next, let’s look at the FindInContainer method:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Queue&lt;GameObject&gt; <span class="title">FindInContainer</span>(<span class="params"><span class="keyword">string</span> prefabName</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.container.ContainsKey(prefabName) == <span class="literal">false</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.container.Add(prefabName, <span class="keyword">new</span> Queue&lt;GameObject&gt;());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.container[prefabName];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The FindInContainer is private since the user does not need it. Our container is the dictionary we already created. The purpose is just to get a reference to the Queue corresponding to the prefab (the prefab name in our case). Nothing too fancy here. Let’s move on.</p>
<p>And now the CreateObject method:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> GameObject <span class="title">CreateObject</span>(<span class="params"><span class="keyword">string</span> prefabName, Transform container</span>)</span></div><div class="line">&#123;</div><div class="line">    GameObject obj = (GameObject)Object.Instantiate(prefabContainer[prefabName]);</div><div class="line">    obj.name = prefabName;</div><div class="line">    obj.transform.parent = container;</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This method does not do anything you should not understand by yourself.</p>
<h2 id="Give-back-what-you-are-given"><a href="#Give-back-what-you-are-given" class="headerlink" title="Give back what you are given"></a>Give back what you are given</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PushToPool</span>(<span class="params"> <span class="keyword">ref</span> GameObject obj, <span class="keyword">bool</span> retainObject = <span class="literal">true</span>, Transform parent = <span class="literal">null</span></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(obj == <span class="literal">null</span>) &#123; <span class="keyword">return</span>; &#125;</div><div class="line">    <span class="keyword">if</span>(retainObject == <span class="literal">false</span>)</div><div class="line">    &#123;</div><div class="line">        Object.Destroy(obj);</div><div class="line">        obj = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(parent != <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        obj.transform.parent = parent;</div><div class="line">    &#125;</div><div class="line">    Queue&lt;GameObject&gt; queue = FindInContainer(obj.name);</div><div class="line">    queue.Enqueue(obj);</div><div class="line">    obj.SetActive(<span class="literal">false</span>);</div><div class="line">    obj = <span class="literal">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The method returns void and takes three parameters. The first is a ref to a GameObject, second defines if we want to keep the object, the latest is the container to assign the object. This is quite simple to understand here, the only problem could come from the ref parameter. Why would we want that? Think about your own code in which you would use this one:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Some code and something happened with a bullet object</span></div><div class="line">    GameObject obj = GetThatBulletReference();</div><div class="line">    <span class="comment">// Doing some stuff with obj reference</span></div><div class="line">    <span class="keyword">if</span>(condition == <span class="literal">true</span>)&#123; <span class="comment">// Any reason</span></div><div class="line">    PushToPool(<span class="keyword">ref</span> obj,<span class="literal">false</span>, containerTransform);</div><div class="line">    <span class="keyword">else</span>&#123; <span class="comment">// other&#125;</span></div><div class="line">    <span class="comment">// More code with obj =&gt; Wrong</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In this code, based on a condition, the bullet is returned to the pool. But the code keeps on using the bullet later on regardless if it is still in use or not. Obviously, this code is wrong and may never happen but it is just for the sake of demonstration. Back to our code, it seems we still have a reference to our bullet object despite the fact it is back in the pool and deactivated. Using the ref keyword, it means we have access to the reference outside the method and we can set to null. As a result, we cannot modify the dead object since we have no link to it anymore.</p>
<p>In our method, the obj reference is at 0x0055 and contains the value 0x00AA where the bullet object is stored. When we call the PushToPool method, the parameter is given 0x0055 instead of 0x00AA, so we can control the obj reference directly. In the method it is set to null, so out of PushToPool, the obj reference inside MyMethod is null.</p>
<p>If you decide not to retain the item in the pool, then it gets destroyed. Now you may ask “What if we want to keep it without setting it in the pool?” well, do so. Just don’t call the method (I know some of you will think of that despite being obvious).</p>
<h2 id="Clean-up-after-yourself"><a href="#Clean-up-after-yourself" class="headerlink" title="Clean up after yourself"></a>Clean up after yourself</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReleaseItems</span>(<span class="params">GameObject prefab, <span class="keyword">bool</span> destroyObject = <span class="literal">false</span></span>)</span></div><div class="line">&#123;</div><div class="line">     <span class="keyword">if</span>( prefab == <span class="literal">null</span>)&#123; <span class="keyword">return</span>; &#125;</div><div class="line">     Queue&lt;GameObject&gt; queue = FindInContainer(prefab.name);</div><div class="line">     <span class="keyword">if</span> (queue == <span class="literal">null</span>)  &#123; <span class="keyword">return</span>; &#125;</div><div class="line">     <span class="keyword">while</span> (queue.Count &gt; <span class="number">0</span>) </div><div class="line">     &#123;</div><div class="line">         GameObject obj = queue.Dequeue();</div><div class="line">         <span class="keyword">if</span> (destroyObject == <span class="literal">true</span>) </div><div class="line">         &#123;</div><div class="line">              Object.Destroy(obj);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReleasePool</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> kvp <span class="keyword">in</span> <span class="keyword">this</span>.container)</div><div class="line">    &#123;</div><div class="line">        Queue&lt;GameObject&gt; queue = kvp.Value;</div><div class="line">        <span class="keyword">while</span>(queue.Count &gt; <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            GameObject obj = queue.Dequeue();</div><div class="line">            Object.Destroy(obj);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.container = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">this</span>.container = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Queue&lt;GameObject&gt;&gt;();</div><div class="line">    <span class="keyword">this</span>.prefabContainer.Clear();</div><div class="line">    <span class="keyword">this</span>.prefabContainer = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">this</span>.prefabContainer = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>,GameObject&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We are finally getting to the end, so ReleaseItems is somehow similar to PushToPool with retain as false. The only major difference is the fact that all items of a kind will be destroyed witht that method. Considers you want to get rid of all kind of bullets, use this one. ReleasePool does what it says, it empties the pool and set it ready for a new round.</p>
<h2 id="Practical-case"><a href="#Practical-case" class="headerlink" title="Practical case"></a>Practical case</h2><p>To sum it up first let’s wrap the whole code and then use it quickly in an example. Please do keep in mind, there may have been some details you may find wrong, just let me know and I can explain my decision and maybe (I doubt it though) admit I could be wrong and improve the code.</p>
<p>Here it is:</p>
<p><a href="https://github.com/fafase/unity-utilities/blob/master/Scripts/ObjectPoolString.cs" target="_blank" rel="external">github-mark@1200x630</a></p>
<p>And a simplified use case:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[SerializeField] <span class="keyword">private</span> GameObject enemyPrefab = <span class="literal">null</span>;</div><div class="line">[SerializeField] <span class="keyword">private</span> GameObject bulletPrefab = <span class="literal">null</span>;</div><div class="line">[SerializeField] <span class="keyword">private</span> Transform enemyContainer = <span class="literal">null</span>;</div><div class="line">[SerializeField] <span class="keyword">private</span> Transform weaponContainer = <span class="literal">null</span>;</div><div class="line"><span class="comment">// This needs to match the prefab name </span></div><div class="line"><span class="comment">// I just made it simple here </span></div><div class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">string</span> PrefabName = <span class="string">"bulletPrefab"</span>; </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    ObjectPool.Instance.AddToPool(<span class="keyword">this</span>.enemyPrefab, <span class="number">10</span> , <span class="keyword">this</span>.enemyContainer);</div><div class="line">    ObjectPool.Instance.AddToPool(<span class="keyword">this</span>.bulletPrefab, <span class="number">100</span>, <span class="keyword">this</span>.weaponContainer);</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Shoot</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">     <span class="comment">// Using the prefab name</span></div><div class="line">     <span class="keyword">var</span> obj = ObjectPool.Instance.PopFromPool(PrefabName, <span class="literal">false</span>, <span class="literal">true</span>, <span class="keyword">this</span>.transform);</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Hit</span>(<span class="params">GameObject bullet</span>)</span></div><div class="line">&#123;</div><div class="line">    ObjectPool.Instance.PushToPool(<span class="keyword">ref</span> bulletPrefab, <span class="keyword">ref</span> bullet, bulletContainer);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Following the previous article on object pool, some legit comments came up concerning memory allocation.</p>
<h2 id="The-issue"><a href="#The-issue" class="headerlink" title="The issue"></a>The issue</h2><p>When coding, it is required to find the most efficient code, that is the fastest way to solve a problem (fastest is not necessarily shortest). But sometimes in order to get fast, we hit some other trouble. In the previous article, the code could be considered fast (to some extents), but one line would be problematic. It happens that Unity runs some internal code when using</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gameObject.name;</div></pre></td></tr></table></figure>
<p>Despite the fact that name is just a property, Unity runs some deeper code that generates some memory allocation. Exactly, it seems to allocate 40B for each call.</p>
<p>The call happening during the creation of the object is no issue since it happens only once in the object lifetime, the problematic was during the pushing back in the pool:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PushToPool</span>(<span class="params"> <span class="keyword">ref</span> GameObject obj, <span class="keyword">bool</span> retainObject = <span class="literal">true</span>, Transform parent = <span class="literal">null</span></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(obj == <span class="literal">null</span>) &#123; <span class="keyword">return</span>; &#125;</div><div class="line">    <span class="keyword">if</span>(retainObject == <span class="literal">false</span>)</div><div class="line">    &#123;</div><div class="line">        Object.Destroy(obj);</div><div class="line">        obj = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(parent != <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        obj.transform.parent = parent;</div><div class="line">    &#125;</div><div class="line">    Queue&lt;GameObject&gt; queue = FindInContainer(obj.name);</div><div class="line">    queue.Enqueue(obj);</div><div class="line">    obj.SetActive(<span class="literal">false</span>);</div><div class="line">    obj = <span class="literal">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The FindInContainer method uses the name of the prefab as parameter and that is where it goes wrong.</p>
<p>So we need to figure out a way to get the prefab without using the name.</p>
<h2 id="Getting-a-solution"><a href="#Getting-a-solution" class="headerlink" title="Getting a solution"></a>Getting a solution</h2><p>The solution is simple, instead of storing the prefab in a dictionary (string,prefab), we will add a component to the pooled object. That component will contain only one item, a reference to the prefab.</p>
<p>This way, we save the allocation generated by the call to .name. On the other hand, we have a bigger constant memory usage since the component will be stored in memory for the whole object lifetime. Also, we lose that tiny efficiency as well on the call to the component to get the prefab.</p>
<p>As you can see, one problem could not entirely be solved without adding something else. This is one of the main programming paradigm, finding the balance between efficiency, memory allocation and memory usage.</p>
<h2 id="The-new-interface"><a href="#The-new-interface" class="headerlink" title="The new interface"></a>The new interface</h2><p>If you read the other object pooling article, you will see that this one is fairly similar but shorter. I would recommend to start with it first and back to this one.</p>
<p>The new interface is nothing more than a storage for a prefab reference and an init method:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IPoolObject</span> : <span class="title">MonoBehaviour</span></div><div class="line">&#123;</div><div class="line">   GameObject Prefab&#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">Init</span>(<span class="params"></span>)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This is added to any component on an object that should be pooled. The compiler will then asked to implement the method and property. The Init method is there to reset the values on a pooled  component. If nothing should be done, just leave the method implementation empty. You can use to reset health, ammo or else.</p>
<h2 id="The-pool"><a href="#The-pool" class="headerlink" title="The pool"></a>The pool</h2><p>The class containing the pool is about to start just like the other article, so I wont repeat myself and just paste the code:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">ObjectPool</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ObjectPool instance = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ObjectPool Instance</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">get</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (instance == <span class="literal">null</span>)</div><div class="line">            &#123;</div><div class="line">                instance = <span class="keyword">new</span> ObjectPool();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> instance;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        instance = <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ObjectPool</span>(<span class="params"></span>) </span>&#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here goes the interface of our pool (interface as in public interface not actual interface, well,…):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">AddToPool</span>(<span class="params">GameObject prefab, <span class="keyword">int</span> count, Transform parent = <span class="literal">null</span></span>) </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line"><span class="function"><span class="keyword">public</span> GameObject <span class="title">PopFromPool</span>(<span class="params">GameObject prefab, <span class="keyword">bool</span> forceInstantiate = <span class="literal">false</span>,</span></span></div><div class="line">        <span class="keyword">bool</span> instantiateIfNone = <span class="literal">false</span>, Transform container = <span class="literal">null</span>) &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PushToPool</span>(<span class="params"><span class="keyword">ref</span> GameObject obj, <span class="keyword">bool</span> retainObject = <span class="literal">true</span>, Transform parent = <span class="literal">null</span></span>) </span>&#123; &#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReleaseItems</span>(<span class="params">GameObject prefab, <span class="keyword">bool</span> destroyObject = <span class="literal">false</span></span>) </span>&#123; &#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReleasePool</span>(<span class="params"></span>) </span>&#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>There is no more overload of the AddToPool method and we got rid of all string iterations.</p>
<h2 id="Creating-items"><a href="#Creating-items" class="headerlink" title="Creating items"></a>Creating items</h2><p>The first method we want to call is the AddToPool method which will create our items.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">AddToPool</span>(<span class="params">GameObject prefab, <span class="keyword">int</span> count, Transform parent = <span class="literal">null</span></span>) </span></div><div class="line">&#123;</div><div class="line">   <span class="keyword">if</span> (prefab == <span class="literal">null</span> || count &lt;= <span class="number">0</span>) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line">   <span class="keyword">string</span> name = prefab.name;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</div><div class="line">   &#123;</div><div class="line">       GameObject obj = PopFromPool(prefab, <span class="literal">true</span>);</div><div class="line">       PushToPool(<span class="keyword">ref</span> obj, <span class="literal">true</span>, parent);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The method just runs a loop to create all needed items. As soon as they get created, they also get pushed back to the pool. The return value is only there to inform it all went fine.<br>There is not much fancy happening so let’s move on.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> GameObject <span class="title">PopFromPool</span>(<span class="params">GameObject prefab, <span class="keyword">bool</span> forceInstantiate = <span class="literal">false</span>,</span></span></div><div class="line">    <span class="keyword">bool</span> instantiateIfNone = <span class="literal">false</span>, Transform container = <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (forceInstantiate == <span class="literal">true</span>) &#123; <span class="keyword">return</span> CreateObject(prefab, container); &#125;</div><div class="line">    GameObject obj = <span class="literal">null</span>;</div><div class="line">    Queue&lt;GameObject&gt; queue = FindInContainer(prefab);</div><div class="line">    <span class="keyword">if</span> (queue.Count &gt; <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        obj = queue.Dequeue();</div><div class="line">        obj.transform.parent = container;</div><div class="line">        obj.SetActive(<span class="literal">true</span>);</div><div class="line">        IPoolObject poolObject =  (IPoolObject)obj.GetComponent(<span class="keyword">typeof</span>(IPoolObject));</div><div class="line">        poolObject.Init();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (obj == <span class="literal">null</span> &amp;&amp; instantiateIfNone == <span class="literal">true</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> CreateObject(prefab, container);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>So if you read the previous article, you should notice some changes here. There is no usage of any string name and all happens with prefab reference. Mostly, we create the object and return it if it is forced. If we forced the creation, we mean to use it right away so there is no need to push it to the pool. In our initial run, we have to push it back manually. The FindInContainer receives a prefab reference and returns a queue of GameObject (if found). Then we dequeue from the queue, set as active, set the parent and return. If something went wrong with the queue, we try a new creation and return it. Notice how we get the interface and call the method. First off, we know that the object contains the interface so there is no need to check, then we call the Init method regardless of the object we are dealing with. The bonus of interfaces is that you don’t need to know what you are dealing with as long as it is a IPoolObject.</p>
<p>NOTE: I use the non-generic version of GetComponent with interfaces as it used to be that Unity would not support it. Unity5 seems to have fixed that issue and you can freely use your interface in generic methods. For those of you still using Unity4.x, I can’t guarantee that generic will work so use the shown version.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Dictionary&lt;GameObject, Queue&lt;GameObject&gt;&gt;container = <span class="keyword">new</span> Dictionary&lt;GameObject, Queue&lt;GameObject&gt;&gt;();</div><div class="line"><span class="function"><span class="keyword">private</span> Queue&lt;GameObject&gt; <span class="title">FindInContainer</span>(<span class="params">GameObject prefab</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (container.ContainsKey(prefab) == <span class="literal">false</span>)</div><div class="line">    &#123;</div><div class="line">        container.Add(prefab, <span class="keyword">new</span> Queue&lt;GameObject&gt;());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> container[prefab];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The FindInContainer method adds the prefab to the dictionary with a new queue of GameObject and returns a reference to that queue.</p>
<h2 id="Creating-the-object"><a href="#Creating-the-object" class="headerlink" title="Creating the object"></a>Creating the object</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> GameObject <span class="title">CreateObject</span>(<span class="params">GameObject prefab, Transform container</span>)</span></div><div class="line">&#123;</div><div class="line">    IPoolObject poolObjectPrefab = (IPoolObject)prefab.GetComponent(<span class="keyword">typeof</span>(IPoolObject));</div><div class="line">    <span class="keyword">if</span>(poolObjectPrefab== <span class="literal">null</span>)&#123;Debug.Log (<span class="string">"Wrong type of object"</span>); <span class="keyword">return</span> <span class="literal">null</span>;&#125;</div><div class="line">     </div><div class="line">    GameObject obj = (GameObject)Object.Instantiate(prefab);</div><div class="line">    IPoolObject poolObject = (IPoolObject)obj.GetComponent(<span class="keyword">typeof</span>(IPoolObject));</div><div class="line">    obj.name = prefab.name;</div><div class="line">    poolObject.Prefab = prefab;</div><div class="line">    obj.transform.parent = container; </div><div class="line">    <span class="keyword">return</span> obj   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The first part is to make sure the prefab that was passed contains a script that implemented the interface. Then it is just instantiating the object and setting some info. Mainly, we are also passing the current prefab to the prefab reference in the IPoolObject interface.</p>
<h2 id="Returning-the-item-to-the-pool"><a href="#Returning-the-item-to-the-pool" class="headerlink" title="Returning the item to the pool"></a>Returning the item to the pool</h2><p>Consider a bullet you have been taking out of the pool, it just hit an enemy player. Thanks to the collision callback (or any other means you may be using), you have a reference to the bullet:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnCollisionEnter</span>(<span class="params">Collision col</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(col.collider.tag == <span class="string">"Bullet"</span>)&#123;</div><div class="line">        GameObject bulletRef = col.collider.gameObject;</div><div class="line">        PushToPool(<span class="keyword">ref</span> bulletRef, <span class="literal">true</span>, someContainer.transform);</div><div class="line">        <span class="comment">// bulletRef is nullified in the method, you cannot use it anymore!!</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Using that reference, we can push the item back in pool:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PushToPool</span>(<span class="params"><span class="keyword">ref</span> GameObject obj, <span class="keyword">bool</span> retainObject = <span class="literal">true</span>, Transform parent = <span class="literal">null</span></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123; <span class="keyword">return</span>; &#125;</div><div class="line">    <span class="keyword">if</span> (retainObject == <span class="literal">false</span>)</div><div class="line">    &#123;</div><div class="line">        Object.Destroy(obj);</div><div class="line">        obj = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (parent != <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        obj.transform.parent = parent;</div><div class="line">    &#125;</div><div class="line">    IPoolObject poolObject = (IPoolObject)obj.GetComponent(<span class="keyword">typeof</span>(IPoolObject));</div><div class="line">    GameObject prefab = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">if</span>(poolObject == <span class="literal">null</span>)&#123; <span class="keyword">return</span>;&#125;</div><div class="line">    prefab = poolObject.Prefab; </div><div class="line">    Queue&lt;GameObject&gt; queue = FindInContainer(prefab);</div><div class="line">    queue.Enqueue(obj);</div><div class="line">    obj.SetActive(<span class="literal">false</span>);</div><div class="line">    obj = <span class="literal">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We are passing the reference to the GameObject as ref, which means we get a reference to the reference and not to the object directly. This means we can modify the passed reference from within the method. This way we affect bulletRef in OnCollisionEnter. Without ref, the compiler would be copying the value stored in bulletRef and we would be working with that local copy, but we would not have any access to bulletRef itself. We want to make sure that bulletRef becomes unusable after the item has been pooled back. This prevents the consumer of the ObjectPool to push back and then continue using the bullet reference.</p>
<p>Back to the method implementation, if we set to not retain the item, it gets destroyed.</p>
<p>We parent to the container that has been defined and then we fetch the component containing the reference to the prefab. We make sure the object contains the component. If it fails, the method simply returns, it could (or should) inform further with returning false/null. Then we get the queue corresponding and enqueue the item. Finally we set the reference to null so that the item is no more usable outside.</p>
<h2 id="Cleaning"><a href="#Cleaning" class="headerlink" title="Cleaning"></a>Cleaning</h2><p>The cleaning of the pool is similar to the ones in the other article, except for the fact that only one container is remaining.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReleaseItems</span>(<span class="params">GameObject prefab, <span class="keyword">bool</span> destroyObject = <span class="literal">false</span></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (prefab == <span class="literal">null</span>) &#123; <span class="keyword">return</span>; &#125;</div><div class="line">    Queue&lt;GameObject&gt; queue = FindInContainer(prefab);</div><div class="line">    <span class="keyword">if</span> (queue == <span class="literal">null</span>) &#123; <span class="keyword">return</span>; &#125;</div><div class="line">    <span class="keyword">while</span> (queue.Count &gt; <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        GameObject obj = queue.Dequeue();</div><div class="line">        <span class="keyword">if</span> (destroyObject == <span class="literal">true</span>)</div><div class="line">        &#123;</div><div class="line">            Object.Destroy(obj);</div><div class="line">        &#125;</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReleasePool</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> kvp <span class="keyword">in</span> container)</div><div class="line">    &#123;</div><div class="line">        Queue&lt;GameObject&gt; queue = kvp.Value;</div><div class="line">        <span class="keyword">while</span> (queue.Count &gt; <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            GameObject obj = queue.Dequeue();</div><div class="line">            Object.Destroy(obj);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    container = <span class="literal">null</span>;</div><div class="line">    container = <span class="keyword">new</span> Dictionary&lt;GameObject, Queue&lt;GameObject&gt;&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The first ReleaseItems is used to get rid of a type of items, while ReleasePool is clearing the whole pool.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This is it for the second version. We got rid of the memory allocation (at least I could not see any in the profiler). Obviously, there is a little more done under the hood but that should not affect the runtime. Also, the Init method got added which enables a nice reset feature.</p>
<p>Any comments, go ahead (only positif ones will make it through moderation).</p>
<p>Find the script on the link below.</p>
<p><a href="https://github.com/fafase/unity-utilities/blob/master/Scripts/ObjectPool.cs" target="_blank" rel="external">github-mark@1200x630</a></p>
<h2 id="原文链接"><a href="#原文链接" class="headerlink" title="原文链接"></a>原文链接</h2><ul>
<li><a href="https://unitygem.wordpress.com/object-pooling/" target="_blank" rel="external">Object pooling</a></li>
<li><a href="https://unitygem.wordpress.com/object-pooling-v2/" target="_blank" rel="external">Object polling v2</a></li>
</ul>
<p>另外，原文的评论也很赞！</p>
<hr>
<p>另外一篇</p>
<p>Object Pools Keeping Things Alive</p>
<ul>
<li>Create a fountain of stuff with physics.</li>
<li>Make objects poolable.</li>
<li>Add functionality to prefabs.</li>
<li>Generate pools on demand.</li>
<li>Survive recompiles and scene transitions.</li>
</ul>
<p>This tutorial is about objects pools. What are they, how do they work, and are they useful?</p>
<p>The tutorial follows Frames per Second. We will be spawning objects in a similar way, and the FPS counter is useful to measure performance.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/object-pools-tutorial-image.jpg" alt="Create pools to feed your fountain"></p>
<!--more-->
<h2 id="Spawning-Lots-of-Stuff"><a href="#Spawning-Lots-of-Stuff" class="headerlink" title="Spawning Lots of Stuff"></a>Spawning Lots of Stuff</h2><p>Object pools are a tool to reuse objects, which is relevant when you are creating and destroying lots of them. So we should begin by spawning lots of objects. And to measure performance, we can reuse the frame rate counter from the previous tutorial. You can grab just the counter bits and delete everything else. It is easiest if you open its scene, turn the counter object into a prefab, and then use that in a new scene for this tutorial.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/counter-assets.png" alt="Reusing the frame rate counter:assets"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/counter-object.png" alt="Reusing the frame rate counter:object"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/counter-scene.png" alt="Reusing the frame rate counter:scene"></p>
<p>So we need stuff to spawn. And to make it interesting, let’s make it physics stuff. We can start with a very simple component for that, similar to the nucleon of the previous tutorial.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line">[RequireComponent(<span class="keyword">typeof</span>(Rigidbody))]</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Stuff</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line"></div><div class="line">	Rigidbody body;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span> (<span class="params"></span>) </span>&#123;</div><div class="line">		body = GetComponent&lt;Rigidbody&gt;();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Create a standard cube and sphere, and add this component to both of them. Then turn them into prefabs.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/cube-prefab.png" alt="cube prefab"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/stuff-prefabs.png" alt="stuff prefabs"></p>
<p>The next thing we need is a spawner of stuff, much like the nucleon spawner.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StuffSpawner</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">float</span> timeBetweenSpawns;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> Stuff[] stuffPrefabs;</div><div class="line"></div><div class="line">	<span class="keyword">float</span> timeSinceLastSpawn;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span> (<span class="params"></span>) </span>&#123;</div><div class="line">		timeSinceLastSpawn += Time.deltaTime;</div><div class="line">		<span class="keyword">if</span> (timeSinceLastSpawn &gt;= timeBetweenSpawns) &#123;</div><div class="line">			timeSinceLastSpawn -= timeBetweenSpawns;</div><div class="line">			SpawnStuff();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">SpawnStuff</span> (<span class="params"></span>) </span>&#123;</div><div class="line">		Stuff prefab = stuffPrefabs[Random.Range(<span class="number">0</span>, stuffPrefabs.Length)];</div><div class="line">		Stuff spawn = Instantiate&lt;Stuff&gt;(prefab);</div><div class="line">		spawn.transform.localPosition = transform.position;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Create an object with this component. Set the time between spawns to something small, like 0.1. Then put references to the cube and sphere prefabs in the stuff array.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/spawner.png" alt="spawner"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/spawn.png" alt="spawn"><br>A spawner of stuff to spawn stuff.</p>
<p>Now we have a spawner that create cubes and spheres at one point. It doesn’t look like much. If we give the spawner access to the stuff’s body, it can give them a starting velocity. So turn Stuff.body into a property.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Rigidbody Body &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Awake</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	Body = GetComponent&lt;Rigidbody&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Let’s add a configurable velocity to StuffSpawner, which it will use to give its spawns an initial upward momentum.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">float</span> velocity;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">SpawnStuff</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	Stuff prefab = stuffPrefabs[Random.Range(<span class="number">0</span>, stuffPrefabs.Length)];</div><div class="line">	Stuff spawn = Instantiate&lt;Stuff&gt;(prefab);</div><div class="line">	spawn.transform.localPosition = transform.position;</div><div class="line">	spawn.Body.velocity = transform.up * velocity;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/velocity.png" alt="velocity"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/tower-of-stuff.png" alt="a tower of spawn"><br>Building a tower of stuff, bottom-up.</p>
<p>Now we get a neat rising tower of stuff, which quickly collapses, then rises again. If you tilt the spawner, then it will start to look more like a natural flow of stuff. In fact, if we were to put multiple spawners in a ring, it will start to resemble an elaborate fountain. Let’s create a component to do just that.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StuffSpawnerRing</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> numberOfSpawners;</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> <span class="keyword">float</span> radius, tiltAngle;</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> StuffSpawner spawnerPrefab;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span> (<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numberOfSpawners; i++) &#123;</div><div class="line">			CreateSpawner(i);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>To position the spawners, it is easiest to create a rotater object for each. That way we can deal with the placement and rotations in isolation.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CreateSpawner</span> (<span class="params"><span class="keyword">int</span> index</span>) </span>&#123;</div><div class="line">	Transform rotater = <span class="keyword">new</span> GameObject(<span class="string">"Rotater"</span>).transform;</div><div class="line">	rotater.SetParent(transform, <span class="literal">false</span>);</div><div class="line">	rotater.localRotation =</div><div class="line">		Quaternion.Euler(<span class="number">0</span>f, index * <span class="number">360</span>f / numberOfSpawners, <span class="number">0</span>f);</div><div class="line"></div><div class="line">	StuffSpawner spawner = Instantiate&lt;StuffSpawner&gt;(spawnerPrefab);</div><div class="line">	spawner.transform.SetParent(rotater, <span class="literal">false</span>);</div><div class="line">	spawner.transform.localPosition = <span class="keyword">new</span> Vector3(<span class="number">0</span>f, <span class="number">0</span>f, radius);</div><div class="line">	spawner.transform.localRotation = Quaternion.Euler(tiltAngle, <span class="number">0</span>f, <span class="number">0</span>f);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now turn the spawner into a prefab and make a new spawner ring object.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/ring.png" alt="ring"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/much-stuff.png" alt="Definitely a lot of stuff."></p>
<p>We now have a fountain of stuff that just keeps on spawning more, resulting in an endless column of falling objects. To prevent our app from choking, we have to get rid of all this stuff at some point. We can do so by introducing a kill zone. All stuff that enters this zone should be destroyed.</p>
<p>Create an object with a box collider marked as a trigger, set it to a very large size, and place it somewhere below the fountain. Then give it a Kill Zone tag so we know its function. This tag doesn’t exist, you’ll have to add it yourself, which you can do via the Add Tag… option in the tag selector. Note that tags will not be included when importing a unitypackage file, you’ll have to add them to your project so they show up correctly.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/kill-zone.png" alt="kill zone"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/tag.png" alt="A kill zone tag"></p>
<p>Now Stuff can respond to entering a trigger by checking whether it is now in a kill zone, and if so terminate itself.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnTriggerEnter</span> (<span class="params">Collider enteredCollider</span>) </span>&#123;</div><div class="line">	<span class="keyword">if</span> (enteredCollider.CompareTag(<span class="string">"Kill Zone"</span>)) &#123;</div><div class="line">		Destroy(gameObject);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/killed-spawn.png" alt=""><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/PositiveRichHatchetfish.mp4" alt="Stuff gets terminated"></p>
<blockquote>
<p>Why use a tag?<br>Comparing tags is quick and our kill zone doesn’t need to do anything, so it doesn’t need a component of its own.</p>
</blockquote>
<h2 id="Adding-Variation"><a href="#Adding-Variation" class="headerlink" title="Adding Variation"></a>Adding Variation</h2><p>We have our fountain, but it’s rather orderly. It could use some more randomness. We can do this by replacing fixed values with random values that fall inside some range. Because we can do this with multiple values, let’s make a convenient structure for it.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line">[System.Serializable]</div><div class="line"><span class="keyword">public</span> <span class="keyword">struct</span> FloatRange &#123;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">float</span> min, max;</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> <span class="keyword">float</span> RandomInRange &#123;</div><div class="line">		<span class="keyword">get</span> &#123;</div><div class="line">			<span class="keyword">return</span> Random.Range(min, max);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now we can mess up the timing of StuffSpawner.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> FloatRange timeBetweenSpawns;</div><div class="line"></div><div class="line"><span class="keyword">float</span> currentSpawnDelay;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	timeSinceLastSpawn += Time.deltaTime;</div><div class="line">	<span class="keyword">if</span> (timeSinceLastSpawn &gt;= currentSpawnDelay) &#123;</div><div class="line">		timeSinceLastSpawn -= currentSpawnDelay;</div><div class="line">		currentSpawnDelay = timeBetweenSpawns.RandomInRange;</div><div class="line">		SpawnStuff();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/spawn-time-range.png" alt="Irregular spawning"></p>
<p>Why not randomize the stuff’s scale and rotation as well?</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> FloatRange timeBetweenSpawns, scale;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">SpawnStuff</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	Stuff prefab = stuffPrefabs[Random.Range(<span class="number">0</span>, stuffPrefabs.Length)];</div><div class="line">	Stuff spawn = Instantiate&lt;Stuff&gt;(prefab);</div><div class="line">	</div><div class="line">	spawn.transform.localPosition = transform.position;</div><div class="line">	spawn.transform.localScale = Vector3.one * scale.RandomInRange;</div><div class="line">	spawn.transform.localRotation = Random.rotation;</div><div class="line">	</div><div class="line">	spawn.Body.velocity = transform.up * velocity;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/scale-range.png" alt="The little things also count"></p>
<p>We can also vary the velocity, but let’s make this a 3D randomization. We leave the base velocity unchanged, but also add a random velocity in an arbitrary direction.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> FloatRange timeBetweenSpawns, scale, randomVelocity;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">SpawnStuff</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	…</div><div class="line">	</div><div class="line">	spawn.Body.velocity = transform.up * velocity +</div><div class="line">		Random.onUnitSphere * randomVelocity.RandomInRange;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/random-velocity-range.png" alt="Extra random velocity"></p>
<p>And as physics allows for angular momentum as well, add a random angular velocity too. Keep in mind that the physics engine limits this velocity to keep the simulation stable. The default maximum is 7.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">SpawnStuff</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	…</div><div class="line"></div><div class="line">	spawn.Body.velocity = transform.up * velocity +</div><div class="line">		Random.onUnitSphere * randomVelocity.RandomInRange;</div><div class="line">	spawn.Body.angularVelocity =</div><div class="line">		Random.onUnitSphere * angularVelocity.RandomInRange;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/angular-velocity-range.png" alt="angular velocity"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/randomized-stuff.png" alt="randomized"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/MiniatureDefenselessGeese.mp4" alt="stuff"></p>
<p>Adding some initial spin.</p>
<p>Our fountain of stuff is looking a lot more lively by now. Adding some color would make it even more interesting to watch. We could have spawners select randomly from multiple materials, but let’s just give each spawner one material to work with.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Material stuffMaterial;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">SpawnStuff</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	…</div><div class="line">	</div><div class="line">	spawn.GetComponent&lt;MeshRenderer&gt;().material = stuffMaterial;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/material.png" alt="Configurable material"></p>
<blockquote>
<p>Why materials and not just colors?<br>Assigning colors to the stuff’s material would result in each instance getting its own material. This way all materials remain shared.</p>
</blockquote>
<p>Of course we won’t just use one material. Instead, create a bunch and let StuffSpawnerRing cycle through them while it creates the spawners.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Material[] stuffMaterials;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CreateSpawner</span> (<span class="params"><span class="keyword">int</span> index</span>) </span>&#123;</div><div class="line">	…</div><div class="line"></div><div class="line">	spawner.stuffMaterial = stuffMaterials[index % stuffMaterials.Length];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>What does % do?<br>x % y computes the remainder of x divided by y. So we get repeating sequences going from 0 to stuffMaterials.Length - 1.</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/ring-materials.png" alt="materials"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/colored-stuff.png" alt="A colored fountain of stuff"></p>
<p>Our scene will look even more lively if the stuff has something to interact with besides itself. So add a large sphere at the center of the scene. I gave it a uniform scale of 15 and also increased the stuff’s velocity to 17 so it has a better chance to land on top of the sphere.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/sphere.png" alt=""><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/WeightyBronzeFawn.mp4" alt=""><br>More interesting physics interactions.</p>
<p>Now stuff can bounce around a bit and maybe spend some time on the sphere, before it inevitable ends up in the kill zone. You can add more obstacles to the scene, but the longer you delay stuff from getting to a kill zone, the more work the physics engine has to do.</p>
<h2 id="Making-Heavier-Stuff"><a href="#Making-Heavier-Stuff" class="headerlink" title="Making Heavier Stuff"></a>Making Heavier Stuff</h2><p>Ok, so we’re spawing stuff. How’s the performance of our app? Check the profiler and see what’s going on. Make a build and profile that as well, so you see how it runs as a standalone app. As builds performs better than playing in the editor, you could increase the number of spawners to 30 or higher, depending your your machine.</p>
<p>You will see continuous memory allocation and maybe garbage collection runs, which is not surprising. You could see anywhere from a hundred to a thousand bytes being allocated each frame, depending on randomness and the frame rate that your app is running at.</p>
<p>Is this memory allocation significant to warrant special attention? On desktops most likely not. Rendering and physics keep the machine busy, our scripts barely register on the profiler graph.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/profiler.png" alt="Our code – the blue line – is not a bottleneck in this case"></p>
<p>Of course this picture might change for other devices. Mobiles and consoles typically have less and slower memory than desktops and laptops. You can end up with frequent garbage collection runs, which can wreak havoc on your app’s frame rate. But you have to try and measure it before you can be sure.</p>
<p>For a desktop app, our current approach of simply creating and destroying objects as needed seems perfectly fine. There’s no need to add complexity to our app trying to solve a non-exiting problem. But maybe our objects are just too simple? What if our stuff was more complex?</p>
<p>We need bigger stuff! Fox example, a cross made from cubes. Create three cubes, make them children of an empty game object, and set their scales to the three possible permutations of (0.5, 0.5, 2.5). Then add a Stuff component to the root object and turn the whole thing into a prefab. I set its mass to 3 because it’s a larger object than the other stuff.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/cross.png" alt="cross"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/cross-preview.png" alt="Cross prefab preview"></p>
<p>Add this new type of stuff to the spawner prefab’s array so it will be included in the fountain.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/array-with-cross.png" alt="Cubes, spheres, and crosses"></p>
<p>Entering play mode right now will give us trouble when trying to assigning materials. Our assumption that stuff objects always have a MeshRenderer is no longer true. So let’s move the responsibility of setting the material to Stuff itself. Internally, it can collect all renderers inside itself when it awakens. Then it can forward material assignments to them all when needed.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">MeshRenderer[] meshRenderers;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetMaterial</span> (<span class="params">Material m</span>) </span>&#123;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; meshRenderers.Length; i++) &#123;</div><div class="line">		meshRenderers[i].material = m;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Awake</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	Body = GetComponent&lt;Rigidbody&gt;();</div><div class="line">	meshRenderers = GetComponentsInChildren&lt;MeshRenderer&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now StuffSpawner just has to invoke this method.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">SpawnStuff</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	…</div><div class="line"></div><div class="line">	spawn.SetMaterial(stuffMaterial);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/fountain-with-cross.png" alt="More complex stuff in the fountain"></p>
<p>What about we add caltrops as well? A caltrop consists of four legs that point away from each other. You can put capsules inside those legs to visualize them, with a Y offset of 0.5. The first leg points upwards. The second has rotation (70.52878, 180, 180). The other two have the same X and Z rotation, but their Y rotation should be 300 and 60.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/caltrop.png" alt="caltrops"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/caltrop-preview.png" alt="Caltrop prefab preview"></p>
<p>Add the caltrop to the spawner’s stuff prefab array as well. You can increase the probability of an option being chosen by adding it more than once.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/array-with-caltrop.png" alt="prefabs"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/fountain-with-caltrops.png" alt=" A messy fountain fountain"><br>.</p>
<p>How’s our app’s performance now? We’re getting more memory allocations, but it is still not an issue for a desktop app. The physics calculations are much more important. Something drastic is needed to make the creation of stuff matter. For example, add the following line a few times to Stuff.Awake.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FindObjectsOfType&lt;Stuff&gt;();</div></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/profiling-finding-objects.png" alt="This warrants attention"></p>
<p>That did it. Object creation is now significant for our desktop app. Invoking FindObjectsOfType just five times per stuff generates roughly 200KB of memory allocations per frame for me. But this is a ridiculous scenario. Object pooling isn’t the solution for this, getting rid of those FindObjectsOfType invocations is. And have a chat with whoever thought it a good idea to put that code there.</p>
<h2 id="Pooling-Objects"><a href="#Pooling-Objects" class="headerlink" title="Pooling Objects"></a>Pooling Objects</h2><p>Suppose that we do want to use object pooling. How would we do that? We reuse objects by not destroying them, but instead deactivating them and placing them in a buffer. That’s our pool. Then whenever we need a new object, we can reactivate one from the pool. If none are available, we create a new object as usual.</p>
<p>Let’s create a component for these objects. It needs to know which pool it belongs to, so it can return to it when needed. And just in case it ends up without a pool, it should destroy itself instead.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PooledObject</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> ObjectPool Pool &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReturnToPool</span> (<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span> (Pool) &#123;</div><div class="line">			Pool.AddObject(<span class="keyword">this</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			Destroy(gameObject);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now we can turn Stuff into a pooled object and have it return to its pool when entering a kill zone.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Stuff</span> : <span class="title">PooledObject</span> &#123;</div><div class="line">	</div><div class="line">	…</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnTriggerEnter</span> (<span class="params">Collider enteredCollider</span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span> (enteredCollider.CompareTag(<span class="string">"Kill Zone"</span>)) &#123;</div><div class="line">			ReturnToPool();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Of course we now need an <code>ObjectPool</code> component. It should be possible to get an object from it and return objects to it. For now, let’s just have it create and destroy objects the old-fashioned way and worry about actual reuse later.</p>
<p>While we are here though, let’s use the pool as the parent for everything that it creates, so those objects don’t clutter the root of the hierarchy.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ObjectPool</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line"></div><div class="line">	PooledObject prefab;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> PooledObject <span class="title">GetObject</span> (<span class="params"></span>) </span>&#123;</div><div class="line">		PooledObject obj = Instantiate&lt;PooledObject&gt;(prefab);</div><div class="line">		obj.transform.SetParent(transform, <span class="literal">false</span>);</div><div class="line">		obj.Pool = <span class="keyword">this</span>;</div><div class="line">		<span class="keyword">return</span> obj;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddObject</span> (<span class="params">PooledObject o</span>) </span>&#123;</div><div class="line">		Object.Destroy(o.gameObject) ;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Next, we have to change <code>StuffSpawner</code> so it uses a pool to create stuff, instead of instantiating new stuff all the time. How can we do this? It has to somehow get hold of a pool for each prefab. And we don’t want duplicate pools, so all spawners should share them.</p>
<p>It would be very convenient if we could directly get a pooled instance from a prefab, without having to worry about the pools themselves. So let’s pretend that we can.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">SpawnStuff</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	Stuff prefab = stuffPrefabs[Random.Range(<span class="number">0</span>, stuffPrefabs.Length)];</div><div class="line">	Stuff spawn = prefab.GetPooledInstance&lt;Stuff&gt;();</div><div class="line"></div><div class="line">	…</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Of course prefabs don’t have this functionality, so we have to add it ourselves. What we are actually doing here is simply invoking a method of PooledObject. This object just happens to be a prefab, not an object in a scene.</p>
<blockquote>
<p>You can interact with prefabs?<br>Yes. They are object instances, just like scene objects. But they’re not part of the scene hierarchy. They are assets, which means that all changes to them in the editor will be permanent. Just like when you’d adjust a shared material, for example.</p>
</blockquote>
<p>It is now up to the PooledObject component to take care of the pools. First, we need to give it the required method, which is a generic method, like Instantiate.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> T GetPooledInstance&lt;T&gt; () <span class="keyword">where</span> T : PooledObject &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>How does a generic method work?<br>They work like regular methods, except that they are also like a template. Instead of a concrete type, you use a placeholder, typically named T. You can then invoke this method with any type. The compiler will make sure that method versions for each requested type are available.</p>
<p>The where keyword after the method header is used to constrain the types that are allowed to be used with this method. In our case, we only support PooledObject and its subclasses.</p>
</blockquote>
<p>All this method needs to do is get an object from some pool instance that belongs to this prefab, cast it to the required type, and return it.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> T GetPooledInstance&lt;T&gt; () <span class="keyword">where</span> T : PooledObject &#123;</div><div class="line">	<span class="keyword">return</span> (T)poolInstanceForPrefab.GetObject();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Of course we need to keep track of poolInstanceForPrefab, so it becomes a field of PooledObject. Note that we’ll use this field to reference an object in the scene, even though a prefab is an asset and not part of any scene. So we cannot save it as part of the prefab, thus we have to make it non-serializable.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[System.NonSerialized]</div><div class="line">ObjectPool poolInstanceForPrefab;</div></pre></td></tr></table></figure>
<blockquote>
<p>What happens when you serialize it?<br>Unity will try to save the pool instance as part of the prefab asset, but will fail. If the field were public, it would show up in the inspector as a type mismatch while in play mode, and as missing otherwise.</p>
<p>Note that all PooledObject instances have this field. It’s just prefabs that should make use of it.</p>
</blockquote>
<p>Finally, how do we actually get a reference to the correct pool? We’ll ask the ObjectPool class for one when necessary, via a static method.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[System.NonSerialized]</div><div class="line">ObjectPool poolInstanceForPrefab;</div><div class="line"></div><div class="line"><span class="keyword">public</span> T GetPooledInstance&lt;T&gt; () <span class="keyword">where</span> T : PooledObject &#123;</div><div class="line">	<span class="keyword">if</span> (!poolInstanceForPrefab) &#123;</div><div class="line">		poolInstanceForPrefab = ObjectPool.GetPool(<span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> (T)poolInstanceForPrefab.GetObject();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>So off we go to ObjectPool and add the required method.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ObjectPool <span class="title">GetPool</span> (<span class="params">PooledObject prefab</span>) </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>At this point we still don’t have an actual object pool instance. That’s all right, because until this method gets invoked we had no need for one anyway. So this is the right place to create a pool instance.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ObjectPool <span class="title">GetPool</span> (<span class="params">PooledObject prefab</span>) </span>&#123;</div><div class="line">	GameObject obj = <span class="keyword">new</span> GameObject(prefab.name + <span class="string">" Pool"</span>);</div><div class="line">	ObjectPool pool = obj.AddComponent&lt;ObjectPool&gt;();</div><div class="line">	pool.prefab = prefab;</div><div class="line">	<span class="keyword">return</span> pool;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Pools should now appear in play mode, one for each prefab, each neatly containing their own stuff.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/pool-instances.png" alt="Tidy pools"></p>
<p>Unfortunately, duplicate pools will be created each time Unity recompiles the scripts while in play mode. While this isn’t an issue for builds, it is annoying when working in the editor. This happens because PooledObject.poolInstanceForPrefab doesn’t survive a recompile, as we indicated that it should not be serialized. We can work around this by having ObjectPool.GetPool check whether a pool with the same name already exists.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ObjectPool <span class="title">GetPool</span> (<span class="params">PooledObject prefab</span>) </span>&#123;</div><div class="line">	GameObject obj;</div><div class="line">	ObjectPool pool;</div><div class="line">	<span class="keyword">if</span> (Application.isEditor) &#123;</div><div class="line">		obj = GameObject.Find(prefab.name + <span class="string">" Pool"</span>);</div><div class="line">		<span class="keyword">if</span> (obj) &#123;</div><div class="line">			pool = obj.GetComponent&lt;ObjectPool&gt;();</div><div class="line">			<span class="keyword">if</span> (pool) &#123;</div><div class="line">				<span class="keyword">return</span> pool;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	obj = <span class="keyword">new</span> GameObject(prefab.name + <span class="string">" Pool"</span>);</div><div class="line">	pool = obj.AddComponent&lt;ObjectPool&gt;();</div><div class="line">	pool.prefab = prefab;</div><div class="line">	<span class="keyword">return</span> pool;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>With that problem solved, let’s make ObjectPool actually reuse objects. We can do this with a simple list. We add objects to this list as they return to the pool, and take the last one out of the list whenever a new object is required.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">List&lt;PooledObject&gt; availableObjects = <span class="keyword">new</span> List&lt;PooledObject&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> PooledObject <span class="title">GetObject</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	PooledObject obj;</div><div class="line">	<span class="keyword">int</span> lastAvailableIndex = availableObjects.Count - <span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span> (lastAvailableIndex &gt;= <span class="number">0</span>) &#123;</div><div class="line">		obj = availableObjects[lastAvailableIndex];</div><div class="line">		availableObjects.RemoveAt(lastAvailableIndex);</div><div class="line">		obj.gameObject.SetActive(<span class="literal">true</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		obj = Instantiate&lt;PooledObject&gt;(prefab);</div><div class="line">		obj.transform.SetParent(transform, <span class="literal">false</span>);</div><div class="line">		obj.Pool = <span class="keyword">this</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> obj;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddObject</span> (<span class="params">PooledObject obj</span>) </span>&#123;</div><div class="line">	obj.gameObject.SetActive(<span class="literal">false</span>);</div><div class="line">	availableObjects.Add(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Why take the last object out of the list?<br>Lists internally use an array. Removing an item from the list requires all items after it to shift one index forward to fill the gap. This gets more expensive the longer the list gets. Removing the first item of the list is the worst case. Removing the last item from the list is the best case, because there are no items after it that need to be shifted.</p>
<p>We could have also used a stack, but those aren’t serialized by Unity so wouldn’t survive a recompile.</p>
</blockquote>
<p>Suddenly, we have no more constant memory allocations! New stuff is only created when a pool is empty, which will only happen occasionally once the initial burst of object creation is over.</p>
<p>So, does this improve performance? For desktop apps it most likely won’t make a difference whether you use the pools or not. In my case the performance is identical. In other cases, it might be a big help. It might even result in worse performance. You’ll have to try to find out.</p>
<h2 id="Pooling-Across-Scenes"><a href="#Pooling-Across-Scenes" class="headerlink" title="Pooling Across Scenes"></a>Pooling Across Scenes</h2><p>What would happen to our pools if we were to load a different scene? Everything should be destroyed, right? Let’s find out.</p>
<p>A very simple way to change scenes is with a little component that switches between consecutive scenes, wrapping back to the first scene when needed.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SceneSwitcher</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SwitchScene</span> (<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">int</span> nextLevel = (Application.loadedLevel + <span class="number">1</span>) % Application.levelCount;</div><div class="line">		Application.LoadLevel(nextLevel);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Add a button to the canvas and add this component to it, then hook up its method to the On Click event. Also add an event system to the scene via GameObject / UI / Event System, if don’t have one already.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/scene-switcher.png" alt="scene switcher"><br><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/button.png" alt="Scene switch button"></p>
<p>Now we need more scenes. Save and duplicate the current scene. Then change something in the duplicate so you can tell them apart, like replacing the sphere with a cube. Add both these scenes to the build, via File / Build Settings… and using the Add Current button while being inside the scene that you want to add.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/scenes.png" alt="Including two scenes in the build"></p>
<p>The scene switcher is now functional. However, when you try it in the editor Unity might screw up the lighting after loading another scene. This is a problem with the editor only, builds are fine. You can work around this problem by disabling Continuous Baking via Window / Lighting and manually baking each scene once, even when you’re not using any baked lighting.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/wrong-lighting.png" alt=""><br>Lighting screws up after switching scenes in play mode.</p>
<p>Indeed, switching scenes destroys everything from the old scene, including the pools. As the stuff prefabs have lost their pools, they will simply request new ones and start fresh.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/EsteemedWarmheartedLadybird.mp4" alt="Switching Scenes"></p>
<p>But maybe we can keep the pools alive? They’re all about preventing object destruction and creation, and scene transitions do just that. We can keep them alive by instructing Unity to not destroy our ObjectPool instances when a new scene is loaded.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ObjectPool <span class="title">GetPool</span> (<span class="params">PooledObject prefab</span>) </span>&#123;</div><div class="line">	…</div><div class="line">	</div><div class="line">	obj = <span class="keyword">new</span> GameObject(prefab.name + <span class="string">" Pool"</span>);</div><div class="line">	DontDestroyOnLoad(obj);</div><div class="line">	pool = obj.AddComponent&lt;ObjectPool&gt;();</div><div class="line">	pool.prefab = prefab;</div><div class="line">	<span class="keyword">return</span> pool;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Our pools now survive scene transitions, and so do all their child objects. So all our stuff remains exactly where it is, which means that our fountain’s flow is no longer interrupted. Of course changes to the scene can cause some funny physics reactions.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/QueasyPessimisticDugong.mp4" alt="Not destroying pools keeps the flow intact"></p>
<p>Ideally, we would return all stuff to their pools when loading a new scene, instead of either destroying them or keeping them active. Fortunately, we can do this by adding the OnLevelWasLoaded event method to Stuff.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnLevelWasLoaded</span> (<span class="params"></span>) </span>&#123;</div><div class="line">	ReturnToPool();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>That’s it! You have created an object pool system that is easy to use and survives both recompiles and scene transitions. Of course this is not the only way to pool objects. You could tweak it to instantiate a whole bunch of objects when a pool is created, or limit the maximum instances per pool, or make other adjustments that fit your use case. Or use an entirely different approach. The most important thing is that you understand what object pooling is, what it can be used for, and when it might or might not solve your problems.</p>
<h2 id="原文链接-1"><a href="#原文链接-1" class="headerlink" title="原文链接"></a>原文链接</h2><p><a href="http://catlikecoding.com/unity/tutorials/object-pools/" target="_blank" rel="external">Object Pools </a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tospan.me/2014/05/01/Unity/Scripting-18-Object-Pools/" data-id="cizhorep5005l1gvwygb6p865" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Scripting/">Scripting</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unity/">Unity</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/08/01/Algorithms_Basics/00-Algorithms-Basics/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          C#算法与数据结构（零）：前期准备
        
      </div>
    </a>
  
  
    <a href="/2014/04/25/Unity/Scripting-17-Refelection/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">C Sharp Refelection</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithms/">Algorithms</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Game-Development/">Game Development</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Game-Programming-Patterns/">Game Programming Patterns</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unity/">Unity</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unity-Tutorials/">Unity Tutorials</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/default/">default</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithms/">Algorithms</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Basics/">Basics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Data-Structure/">Data Structure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Games/">Games</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Geometry/">Geometry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linear-Algebra/">Linear Algebra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mathematics/">Mathematics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Numerical-Analysis/">Numerical Analysis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Patterns/">Patterns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scripting/">Scripting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/default/">default</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Algorithms/" style="font-size: 17.5px;">Algorithms</a> <a href="/tags/Basics/" style="font-size: 12.5px;">Basics</a> <a href="/tags/C/" style="font-size: 12.5px;">C#</a> <a href="/tags/Data-Structure/" style="font-size: 16.25px;">Data Structure</a> <a href="/tags/Games/" style="font-size: 10px;">Games</a> <a href="/tags/Geometry/" style="font-size: 11.25px;">Geometry</a> <a href="/tags/Linear-Algebra/" style="font-size: 13.75px;">Linear Algebra</a> <a href="/tags/Math/" style="font-size: 12.5px;">Math</a> <a href="/tags/Mathematics/" style="font-size: 12.5px;">Mathematics</a> <a href="/tags/Numerical-Analysis/" style="font-size: 10px;">Numerical Analysis</a> <a href="/tags/Patterns/" style="font-size: 15px;">Patterns</a> <a href="/tags/Scripting/" style="font-size: 18.75px;">Scripting</a> <a href="/tags/Unity/" style="font-size: 20px;">Unity</a> <a href="/tags/default/" style="font-size: 11.25px;">default</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/23/Unity-Multiplayer-And-Networking/">Unity Multiplayer And Networking</a>
          </li>
        
          <li>
            <a href="/2017/02/23/Unity-Physics/">Unity Physics</a>
          </li>
        
          <li>
            <a href="/2017/02/10/Game-Development/">游戏开发</a>
          </li>
        
          <li>
            <a href="/2017/02/08/Unity/Scripting-Quick-Benchmark/">Unity 简单基准测试</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity/Patterns-FSM/">游戏编程设计模式:有限状态机(FSM)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 To Span<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>