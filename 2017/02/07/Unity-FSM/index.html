<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Unity FSM | 吐司片的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="The following article will introduce a basic state machine (or finite state machine FSM). The point here being to introduce some programming topics that are needed to develop a more advanced FSM witho">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity FSM">
<meta property="og:url" content="http://tospan.me/2017/02/07/Unity-FSM/index.html">
<meta property="og:site_name" content="吐司片的博客">
<meta property="og:description" content="The following article will introduce a basic state machine (or finite state machine FSM). The point here being to introduce some programming topics that are needed to develop a more advanced FSM witho">
<meta property="og:image" content="http://tospan.me/../_images/unity/states.png">
<meta property="og:image" content="http://tospan.me/../_images/unity/fsm-1.png">
<meta property="og:image" content="http://tospan.me/../_images/unity/j-alves-impossible-gears.png">
<meta property="og:updated_time" content="2017-02-07T09:37:36.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unity FSM">
<meta name="twitter:description" content="The following article will introduce a basic state machine (or finite state machine FSM). The point here being to introduce some programming topics that are needed to develop a more advanced FSM witho">
<meta name="twitter:image" content="http://tospan.me/../_images/unity/states.png">
  
    <link rel="alternate" href="/atom.xml" title="吐司片的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">吐司片的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Work hard, play hard.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Søk"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://tospan.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Unity-FSM" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/07/Unity-FSM/" class="article-date">
  <time datetime="2017-02-07T09:37:36.000Z" itemprop="datePublished">2017-02-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/default/">default</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Unity FSM
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The following article will introduce a basic state machine (or finite state machine FSM). The point here being to introduce some programming topics that are needed to develop a more advanced FSM without going to deep into it and losing the reader.</p>
<p>The article will cover the basic of a FSM, explaining the basic required for the tool. It will cover the definition of a FSM and talk about delegate and reflection. Those last two often bring confusion so we’ll try to clarify them.</p>
<p>Create a new script and name it StateMachine, go to the link below and copy paste the content onto your new script.</p>
<a id="more"></a>
<p><a href="https://github.com/fafase/unity-utilities/raw/master/Scripts/StateMachineA" target="_blank" rel="external">github-mark@1200x630</a></p>
<h2 id="Basic-of-FSM"><a href="#Basic-of-FSM" class="headerlink" title="Basic of FSM"></a>Basic of FSM</h2><p>So, how to define a FSM? Well, any program is likely to contain some method like this:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ControlMethod</span>(<span class="params"><span class="keyword">int</span> currentState</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">switch</span>(currentState)&#123;</div><div class="line">        <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">            Action0();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">            Action1();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">            Action2();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            ActionError();</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This is already a FSM. It has define actions for the appropriate state. So from there, it could be possible to create a more robust and maintainable situation via a class that would handle the process.</p>
<p>When we write a if-statement, we allow the program to be in either one of the two states. The more conditions, the more complex the machine becomes and more states we allow. It is also possible to set the program in two different states at a time though it is not recommended and more likely one main and one inner state. The problem is that as you add more states, it also becomes harder to debug and maintain, particularly for a sole developer.</p>
<p>So the idea lies in the term finite meaning limited. When building a FSM, we define its limits in each state so that we don’t end up running two states at a time. This way we keep full control since only one method is run. Think of it like the Update method you are already familiar with, but there would be one for each state.<br>Let’s try to visualize a common FSM we deal with every day (if you are no amish):</p>
<p>|——|————————–|<br>|Mode  |    Remote Control Functions|<br>|——|————————–|<br>|Off     | Only the power button has any function.|<br>|      | Pressing power moves the TV into the On state.|<br>|—– |—————————|<br>|On       | Pressing the power button moves the TV to the Off state.<br>         Pressing channel buttons changes the programme being received.<br>         Pressing the up/down buttons surfs through the channels.<br>         Pressing the menu button moves the TV to the Menu state.<br>|——|—————————|<br>| Menu |    * Pressing the power button moves the TV to the Off state.</p>
<pre><code>* Pressing the up/down buttons moves through the menu.
* Pressing the menu button moves the TV to the On state.
</code></pre><p>|——|—————————|</p>
<p>The logic contained in each state would probably be extended but nonetheless, we are given the user interface. We can also clearly see the limitations of the program and some functions are only available in some specific states.</p>
<p>It is also recommended to start your FSM on the paper, thinking what states and what transitions. There are some tools out there to help you with that, some free, some not.Draw.io is one I use every now and then (free).<br><img src="../_images/unity/states.png" alt="States"></p>
<p>The picture above indicates each state of the object and the conditions triggering a transition. Those conditions can be checked in update or via an event system. For instance, “Hit?” is a condition triggered by collision with a projectile (or any kind of weapon)<br>subtracting health and performing a check. If it is less than 0, it transits to “Dying”. On the other hand, the “Player/Enemy Approaches” bubble would require some kind of Update to be performed regularly.</p>
<h2 id="Creating-the-FSM"><a href="#Creating-the-FSM" class="headerlink" title="Creating the FSM"></a>Creating the FSM</h2><p>The first step is to create the class, no surprise if we call it StateMachine and it could inherit from MonoBehaviour. Avoid StateMachineBehaviour as it is already used by UnityEngine (or create a namespace but well…).</p>
<p>It is not necessary to have the MonoBehaviour in the StateMachine but it will simplify a bit but just so you know, it could definitely be a non MB.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StateMachine</span>:<span class="title">MonoBehaviour</span></div><div class="line">&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Next, we are talking about state and machine so we can consider the machine to be the class and we need a state. Let’s create an inner class for that.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StateMachine</span>:<span class="title">MonoBehaviour</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">class</span> <span class="title">State</span>&#123;</div><div class="line">        <span class="keyword">public</span> Enum name = <span class="literal">null</span>;</div><div class="line"> </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">State</span>(<span class="params">Enum name</span>)</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Our class is not public so we cannot screw with it from outside the StateMachine class. It only contains an enum and a constructor for now. The enum is there because we will define our state using an enumeration. We could also use strings, same same but different. Don’t forget the System namespace.</p>
<p>We should define what a state is at the point. So far it is a name only. What we want is that the machine has a pointer (a reference) to the current state and it runs its update. Also, for each changing of state, we want to run an entry and an exit method.<br>So we need three method pointer aka delegate.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StateMachine</span>:<span class="title">MonoBehaviour</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">class</span> <span class="title">State</span>&#123;</div><div class="line">        <span class="keyword">public</span> Enum name = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">public</span> Action updateMethod = () =&amp;gt; &#123; &#125;;</div><div class="line">        <span class="keyword">public</span> Action&amp;lt;Enum&amp;gt; enterMethod = (state) =&amp;gt; &#123; &#125;;</div><div class="line">        <span class="keyword">public</span> Action&amp;lt;Enum&amp;gt; exitMethod = (state) =&amp;gt; &#123; &#125;;</div><div class="line"> </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">State</span>(<span class="params">Enum name</span>)</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>All items are public since we need them in the machine, the first is a basic Action delegate, the two others will receive a parameter of type Enum.</p>
<h2 id="Why-delegate"><a href="#Why-delegate" class="headerlink" title="Why delegate?"></a>Why delegate?</h2><p>Back in C/C++, a delegate was a function pointer.<br>A method MyMethod would require to be passed another method as parameter so that second method can be called from within. The programmer defines a method pointer and a method address is passed to it. The pointer then contains the address and can jump to that address and find the actual method. Ok this is confusing and I won’t explain much of the C/C++ version <a href="http://www.cprogramming.com/tutorial/function-pointers.html" target="_blank" rel="external">function pointer</a>.</p>
<p>Now in C#, the .NET developer pushed the concept one step further. In C/C++, the pointer was a 4bytes variable (in 32bit) meant to receive the address of a method matching its signature. In C#, a delegate is a class and it contains all kind of methods.</p>
<p>The original way still in use:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">MyDelegateDeclaration</span>(<span class="params"></span>)</span>;</div><div class="line"><span class="keyword">public</span> MyDelegateDeclaration myDelegateInstance = <span class="literal">null</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    myDelegateInstance = MyMethod;</div><div class="line">    myDelegateInstance();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span>&#123; Debug.Log(&amp;quot;Hell...oh World...&amp;quot;);&#125;</div></pre></td></tr></table></figure>
<p>The first line declares the delegate in a similar pattern you would declare a new class. First comes the access modifier, then the delegate keyword indicating we are using a special type of class declaration. Comes next the return type, your own naming and the parameter list. This is the signature of methods the delegate can be assigned. In our example, MyMethod returns void and has no parameter so it does match the signature of the delegate.</p>
<p>Second line is the object creation. We now have a reference called myDelegateInstance which is an object of type MyDelegateDeclaration. We can create many object of type MyDelegateDeclaration. We cannot reuse MyDelegateDeclaration for a different type of delegate (just like you cannot reuse a class name)</p>
<p>In the Start, we assign the MyMethod to it. Notice that the () are missing. This is because we do not want to assign the return value (which is void here) by calling the method but instead we want to pass the address and it is done as such (this is equivalent to &Method; in C++). The next line is the invoke of the delegate as we use the parenthesis meaning we are not trying to use the address but the content of the delegate. In this case, it will point towards MyMethod and will print “Hell! Oh World…”. Since a delegate is an object, it can also be null.</p>
<p>The new way:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Action myDelegateInstance = <span class="literal">null</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    myDelegateInstance = MyMethod;</div><div class="line">    <span class="keyword">if</span>(myDelegateInstance != <span class="literal">null</span>)&#123;</div><div class="line">        myDelegateInstance();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This is the generic way and was introduced later in the .NET framework. It works the exact same way as the previous since it is basically a wrapping of the delegate creation. As it is generic, the parameter list is also different and if a return value is needed, Func is used. I would recommend to look at the msdn for more info so that we can move along folks.</p>
<h2 id="Starting-with-our-Machine"><a href="#Starting-with-our-Machine" class="headerlink" title="Starting with our Machine"></a>Starting with our Machine</h2><p>The idea is that our machine will store a collection of state and will transfer from the current state to the required state. In this version of the FSM, there will not be any constrains so any state can jump to any other state.</p>
<p>The first new feature is the current state of the machine. Basically, this is a reference to a state. We also want to be able to retrieve that state from outside the FSM</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StateMachine</span>:<span class="title">MonoBehaviour</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">class</span> <span class="title">State</span>&#123; <span class="comment">// Code &#125;</span></div><div class="line"> </div><div class="line">    <span class="keyword">private</span> State currentState = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">public</span> Enum CurrentState &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.currentState.name; &#125; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The currentState is private and a getter is implemented. You could redefine that property if you feel more relevant to return a string for instance.</p>
<p>Now let’s initialised, shall we?</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">bool</span> initialized = <span class="literal">false</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">bool</span> debugMode = <span class="literal">false</span>;</div><div class="line"><span class="keyword">private</span> Dictionary &amp;lt; Enum, State &amp;gt; states;</div><div class="line"><span class="keyword">private</span> Action OnUpdate = ( ) =&amp;gt; &#123; &#125;;</div><div class="line"> </div><div class="line"><span class="keyword">protected</span> <span class="keyword">void</span> InitializeStateMachine&amp;lt;T&amp;gt;(Enum initialState, <span class="keyword">bool</span> debug)</div><div class="line">&#123;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.initialized == <span class="literal">true</span>)</div><div class="line">   &#123;</div><div class="line">       Debug.LogError(&amp;quot;The StateMachine component <span class="keyword">on</span> &amp;quot; + <span class="keyword">this</span>.GetType().ToString() + &amp;quot; <span class="keyword">is</span> already initialized.&amp;quot;);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">this</span>.initialized = <span class="literal">true</span>;</div><div class="line"> </div><div class="line">   <span class="keyword">var</span> values = Enum.GetValues(<span class="keyword">typeof</span>(T));</div><div class="line">   <span class="keyword">this</span>.states = <span class="keyword">new</span> Dictionary&amp;lt;Enum, State&amp;gt;();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &amp;lt; values.Length; i++)</div><div class="line">   &#123;</div><div class="line">      <span class="keyword">this</span>.initialized = <span class="keyword">this</span>.CreateNewState((Enum)values.GetValue(i));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">this</span>.currentState = <span class="keyword">this</span>.states[initialState];</div><div class="line">   <span class="keyword">this</span>.inTransition = <span class="literal">false</span>;</div><div class="line">   <span class="keyword">this</span>.debugMode = debug;</div><div class="line"> </div><div class="line">   <span class="keyword">this</span>.currentState.enterMethod(currentState.name);</div><div class="line">   <span class="keyword">this</span>.OnUpdate = <span class="keyword">this</span>.currentState.updateMethod;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Ok, quite a bunch of things added here. First, the method is generic and should be passed an enum as generic parameter. We will see soon how to do that. The initialized variable prevents many initializations if by mistake you would call that method many times.</p>
<p>The debugMode variable will allow us to print info on the console if the mode is on. The states dictionary creates a map between enum and state so that we can pass an enum and get the matching state fast. Finally, the OnUpdate delegate is the machine delegate pointing to the current update method. It is just a shortcut to the update in the current state.</p>
<p>In the method now, first we check if already initialized and set it if not yet. Then, we grab all members of the enumeration that was passed and create the dictionary.<br>The for loop iterates all enum values and create a new state (method is coming next). The method returns true if all fine and false if something wrong. This is stored in the initialized variable so that if something went wrong, you cannot use the FSM in a wrong way you would not be expecting.</p>
<p>Next, we set the debugMode and call the enterMethod on the currentState and set the OnUpdate with the update of the currentState.<br>Notice the parameter on the enterMethod, this is because the method is expecting to be passed the previous state but as we are starting, there is no previous state, so we pass the current one.</p>
<p>This is how you would use it in a simplified example:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyClassExample</span> : <span class="title">StateMachine</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        InitializeStateMachine &amp;lt;MyClassState&amp;gt; (MyClassState.Start, <span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> MyClassState&#123; Start, Move, Run, Die &#125;</div></pre></td></tr></table></figure>
<p>And nothing else. At this point, the FSM has registered four states. Let’s jump to the creation of those states.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">CreateNewState</span>(<span class="params">Enum newstate</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.Initialized() == <span class="literal">false</span>) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.states.ContainsKey(newstate) == <span class="literal">true</span>)</div><div class="line">    &#123;</div><div class="line">        Debug.Log(newstate + &amp;quot; <span class="keyword">is</span> already registered <span class="keyword">in</span> &amp;quot; + <span class="keyword">this</span>.GetType().ToString());</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    State s = <span class="keyword">new</span> State(newstate);</div><div class="line">    Type type = <span class="keyword">this</span>.GetType();</div><div class="line">    s.enterMethod = StateTest.GetMethodInfo&amp;lt;Action&amp;lt;Enum&amp;gt;&amp;gt; (<span class="keyword">this</span>, type, &amp;quot;Enter&amp;quot; + newstate, DoNothingEnterExit);</div><div class="line">    s.updateMethod = StateTest.GetMethodInfo &amp;lt;Action&amp;gt; (<span class="keyword">this</span>, type, &amp;quot;Update&amp;quot; + newstate, DoNothingUpdate);</div><div class="line">    s.exitMethod = StateTest.GetMethodInfo &amp;lt;Action&amp;lt;Enum&amp;gt;&amp;gt;  (<span class="keyword">this</span>, type, &amp;quot;Exit&amp;quot; + newstate, DoNothingEnterExit);</div><div class="line"> </div><div class="line">    <span class="keyword">this</span>.states.Add(newstate, s);</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The beginning of the method holds no secret. We then create a new State object. We pass the type of our class into a type reference. What you need to understand there is that the value of the type will not be StateMachine but the calling class. In our example, type would contain info about MyClassExample, since the this pointer points to an object of that type.</p>
<p>Then comes three calls to GetMethodInfoInheritance (coming soon). That method returns a reference to a method that is passed to the delegates of the State object we created. The purpose of that method is that if a specific method is found on the class then a delegate is created towards that method. We will need reflection for this. Think of the Awake/Start/Update/… of a MonoBehaviour, Unity needs to check if you implemented those methods in the script so that it can call them, we will do the same with our own method naming.</p>
<p>Once done, we add the state to the dictionary so that we can fetch a state by enum. This is it for this one.</p>
<h2 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h2><p>The purpose of reflection is to provide inner information on a type, an assembly or any meta data. In our case, we want to know if a class was implemented with methods that would carry specific names.</p>
<p>Consider you want to know if a class contains the method Start, there we go:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Type ourType = <span class="keyword">this</span>.GetType();</div><div class="line">MethodInfo methodInfo = ourType.GetMethod(&amp;quot;Start&amp;quot;, BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance);</div><div class="line"><span class="keyword">if</span>(methodInfo != <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line">    Debug.Log(&amp;quot;The given type contains a Start method&amp;quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You will need an extra namespace:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System.Reflection;</div></pre></td></tr></table></figure>
<p>And tadaaa. This is it. So again, no magic, if you know what you need and you look for the appropriate method, you get it. In our case, we want to look for a method so we use GetMethod. Then, we need to feed the correct parameters. We want a Start method that is public or private and an instance (non-static), this is done with the second parameter.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance</div></pre></td></tr></table></figure>
<p>This performs a OR operation creating a bit value that will contain all three settings.</p>
<p>If the compiler finds a match in the <a href="https://msdn.microsoft.com/en-us/library/1w45z383(v=vs.110" target="_blank" rel="external">assembly manifest</a>.aspx) (the file containing all the program info), it returns an information summary else you get null. The baseType reference is of type Type. It is in no way linked to the object it came from. In our example, we used this.GetType(), the call returned an object that contained the info about this object but you cannot get back to the object using baseType. Just like a handler’s manual contains information about a specific item, it is not the item itself. <a href="https://msdn.microsoft.com/en-us/library/System.Type(v=vs.110" target="_blank" rel="external">Here</a>.aspx), you can find the documentation on Type from msdn.</p>
<p>Using the reflection method, we can find and register the FSM methods.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> T GetMethodInfo&amp;lt;T&amp;gt;(<span class="keyword">object</span> obj, Type type, <span class="keyword">string</span> method, T Default) <span class="keyword">where</span> T : <span class="keyword">class</span></div><div class="line">&#123;</div><div class="line">    Type ourType = type;</div><div class="line">    MethodInfo methodInfo = ourType.GetMethod(method, BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance);</div><div class="line">    <span class="keyword">if</span> (methodInfo != <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> Delegate.CreateDelegate(<span class="keyword">typeof</span>(T), obj, methodInfo) <span class="keyword">as</span> T;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> Default;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The method is generic with a constrain (the generic has to be a class). The first parameter is the object on which we are working, the second parameter is the type we are working with. The string parameter is for the method name and the last parameter is the default method in case none was found.</p>
<p>Looking at the method, we find the same pattern we looked at earlier. If GetMethod found a method, then we create a delegate with <a href="https://msdn.microsoft.com/en-us/library/s3860fy3(v=vs.110" target="_blank" rel="external">Delegate.CreateDelegate</a>.aspx) to which we pass the needed info with a cast as T. if none was found Default is returned.</p>
<p>This might require an extra explanation. When you think of a method on a class, you have to understand the inner mechanism. If you have a class Dog with a method Eat and you create 10 instances of Dog, the compiler actually only creates one version of the Eat method that is stored in memory. When an instance calls the method, the compiler passes a this pointer as first parameter that is hidden. That is how you can use this keyword within a method. So think you have a whole bunch of dogs and when one eats, it passes a reference to himself to a unique Eat method. That unique method is able to know the instance members of the Dog object using that this pointer. The same mechanism is explicitly used in extension methods.</p>
<p>Back to our CreateDelegate method, it creates a delegate, so simply said a pointer to the method location, it takes a type as first parameter so that it can instantiate the delegate (remember a delegate is an object of a type). The second parameter is a reference to an actual instance of an object and will create the this pointer relation between the delegate and that object. The delegate is now able to look into members of that instance. The third parameter uses the content of the method info to know where the delegate should point at.</p>
<ul>
<li>First -&gt; Creates the delegate object</li>
<li>Second -&gt; Gets the reference to the object it should deal with</li>
<li>Third -&gt; Gets the method it should point at</li>
</ul>
<p>Where does Default comes from?  Back up, when we called the method, we passed DoNothingUpdate and DoNothingEnterExit. Those are just empty method we use to fill the gap if nothing exists. So we can declare them:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StateMachine</span> : <span class="title">MonoBehaviour</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoNothingUpdate</span>(<span class="params"></span>) </span>&#123; &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoNothingEnterExit</span>(<span class="params">Enum state</span>) </span>&#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now, let’s get back to the GetMethodInfo to look at the parameters again:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s.enterMethod = StateTest.GetMethodInfo&amp;lt;Action&amp;lt;Enum&amp;gt;&amp;gt;(<span class="keyword">this</span>, type, &amp;quot;Enter&amp;quot; + newstate, DoNothingEnterExit);</div><div class="line">s.updateMethod = StateTest.GetMethodInfo&amp;lt;Action&amp;gt;(<span class="keyword">this</span>, type, &amp;quot;Update&amp;quot; + newstate, DoNothingUpdate);</div><div class="line">s.exitMethod = StateTest.GetMethodInfo&amp;lt;Action&amp;lt;Enum&amp;gt;&amp;gt;(<span class="keyword">this</span>, type, &amp;quot;Exit&amp;quot; + newstate, DoNothingEnterExit);</div></pre></td></tr></table></figure>
<p>Pay attention to the third parameter, it shows</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&amp;quot;Enter&amp;quot;+newState</div><div class="line">&amp;quot;Update&amp;quot;+newState</div><div class="line">&amp;quot;Exit&amp;quot; + newState&amp;quot;</div></pre></td></tr></table></figure>
<p>Our reflection process will look for methods that are made of Enter/Update/Exit and the name of the state. So consider we have</p>
<p><code>public enum MyClassState{ Start, Move, Die }</code></p>
<p>We need to implement like this:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyClassExample</span> : <span class="title">StateMachine</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">EnterStart</span>(<span class="params">Enum previous</span>)</span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateStart</span>(<span class="params"></span>)</span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ExitStart</span>(<span class="params">Enum nextState</span>)</span>&#123;&#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">EnterMove</span>(<span class="params">Enum previous</span>)</span>&#123;&#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateDie</span>(<span class="params"></span>)</span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Enter and exit are taking parameters. This may allow the user to perform specific actions based on previous or next state. Update does not require this process.</p>
<p>Finally concerning reflection, it tends to be fairly slow. So best is to use a pool if you plan on using it on object that gets regularly destroyed and instantiate. You can use my ObjectPool article.</p>
<h2 id="Changing-state"><a href="#Changing-state" class="headerlink" title="Changing state"></a>Changing state</h2><p>The final step is to be able to change state.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">bool</span> inTransition = <span class="literal">false</span>;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">ChangeCurrentState</span>(<span class="params">Enum newstate</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.Initialized() == <span class="literal">false</span>) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.inTransition)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.debugMode == <span class="literal">true</span>)</div><div class="line">        &#123;</div><div class="line">            Debug.LogWarning(<span class="keyword">this</span>.GetType().ToString() + &amp;quot; requests transition to state &amp;quot; + newstate + &amp;quot; when still transitioning to state &amp;quot;);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.debugMode == <span class="literal">true</span>)</div><div class="line">    &#123;</div><div class="line">        Debug.Log(<span class="keyword">this</span>.GetType().ToString() + &amp;quot; transition: &amp;quot; + <span class="keyword">this</span>.currentState.name + &amp;quot; =&amp;gt; &amp;quot; + newstate);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.inTransition = <span class="literal">true</span>;</div><div class="line">    State transitionTarget = <span class="keyword">this</span>.states[newstate];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.currentState.name == transitionTarget.name)</div><div class="line">    &#123;</div><div class="line">       Debug.LogError(<span class="keyword">this</span>.GetType().ToString() + &amp;quot; transition: &amp;quot; + <span class="keyword">this</span>.currentState.name + &amp;quot; =&amp;gt; &amp;quot; + newstate +&amp;quot; <span class="keyword">is</span> same state&amp;quot;);</div><div class="line">       <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (transitionTarget == <span class="literal">null</span> || <span class="keyword">this</span>.currentState == <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        Debug.LogError(<span class="keyword">this</span>.GetType().ToString() + &amp;quot; cannot finalize transition; source or target state <span class="keyword">is</span> <span class="literal">null</span>!&amp;quot;);</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.currentState.exitMethod(transitionTarget.name);</div><div class="line">    transitionTarget.enterMethod(<span class="keyword">this</span>.currentState.name);</div><div class="line">    <span class="keyword">this</span>.currentState = transitionTarget;</div><div class="line">    <span class="keyword">this</span>.inTransition = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">this</span>.OnUpdate = <span class="keyword">this</span>.currentState.updateMethod;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The point of the ChangeCurrentState method is mainly to make sure we are not doing anything wrong first (do the states exist? are we not going from and to the same state?). The inTransition variable makes sure we are not trying to switch to a new state while already switching to a new state. It means you are not trying to call ChangeCurrentState while calling a Enter/Exit method.</p>
<p>Once all conditions are ok, we call the exit of the current state with the next state as parameter and then the enter of the next state with the current state as parameter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">this.currentState.exitMethod(transitionTarget.name);</div><div class="line">transitionTarget.enterMethod(this.currentState.name);</div></pre></td></tr></table></figure>
<p>The final step is to reset the inTransition to false and set the update delegate to the new state update. Finally, we return true to say that it all went fine.</p>
<p>This last bit tells us we are missing one last method in our FSM, the update.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">this</span>.OnUpdate();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Simply, we call the OnUpdate delegate that thanks to our ChangeCurrentState will always refer to the update of the current state.</p>
<p>This also means that our subclass using the FSM should not hide the Update and instead use an override that calls the base within it.</p>
<p>If you want to also implement FixedUpdate and LateUpdate, it goes the same way as we do for Update.</p>
<h2 id="Practical-use"><a href="#Practical-use" class="headerlink" title="Practical use"></a>Practical use</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"><span class="keyword">using</span> System;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyClassExample</span>: <span class="title">StateTest</span></div><div class="line">&#123;</div><div class="line">     <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        InitializeStateMachine&amp;lt;StateClass&amp;gt;(StateClass.Start, <span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">EnterStart</span>(<span class="params">Enum previous</span>) </span>&#123; Debug.Log(&amp;quot;Enter Start&amp;quot;); &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ExitStart</span>(<span class="params">Enum next</span>) </span>&#123; Debug.Log(&amp;quot;Exit Start&amp;quot;); &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">EnterRun</span>(<span class="params">Enum previous</span>) </span>&#123; Debug.Log(&amp;quot;Enter Run&amp;quot;); &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">EnterDie</span>(<span class="params">Enum next</span>) </span>&#123; Debug.Log(&amp;quot;Enter Die&amp;quot;); &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UpdateRun</span>(<span class="params"></span>) </span>&#123; Debug.Log(&amp;quot;update run&amp;quot;);&#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">base</span>.Update();</div><div class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.S)) &#123; ChangeCurrentState(StateClass.Start); &#125;</div><div class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.R)) &#123; ChangeCurrentState(StateClass.Run); &#125;</div><div class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.D)) &#123; ChangeCurrentState(StateClass.Die); &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> StateClass</div><div class="line">&#123;</div><div class="line">    Start, Run, Die</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Note how the Update also calls the base.Update. Do not forget the override or the update in the base will be hidden. The example is really simple using some input to fake the start, the running state and the death of the object. If you switch to a new state, the transition is shown in the console.<br>If you try to jump from one state to the same state, you will see an error in the console. This is so far the only constrain. If you set the parameter in InitializeStateMachine to false, all printing will be removed.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This is a really basic introduction to FSM meant to be easy to begin with. Later, I will add some more features to the FSM so that it gets more robust. It can already be used as it is but is missing a main detail, one stage should only be able to move to defined stage. This is coming in the next article.<br>Any comment, go ahead.</p>
<p>Continuing with our FSM, we are about to add some extra features in order to more robust. One key issue with the current state of our FSM is that it allows any movement of state. All are registered and there is no tree of movement and restrictions. This is not acceptable and will be fixed with this article. So before getting any further, you need to have gone through the previous article or at least copied the script at the end.</p>
<p>Create a new script and name it StateMachine, go to the link below and copy paste the content onto your new script.</p>
<p><a href="https://github.com/fafase/unity-utilities/raw/master/Scripts/StateMachineB" target="_blank" rel="external">github-mark@1200x630</a></p>
<h2 id="Making-a-proper-FSM"><a href="#Making-a-proper-FSM" class="headerlink" title="Making a proper FSM"></a>Making a proper FSM</h2><p>A Finite-State-Machine is not just a bunch of states, it has to define some limitations. In the previous article, the result script does not have any, you can jump from any state to any other state. Actually, the only limitations are that both states have to be registered and the origin and target states cannot be the same.</p>
<p><img src="../_images/unity/fsm-1.png" alt="fsm (1)"></p>
<p>Just to clarify, the picture shows that:</p>
<ul>
<li>Start state leads to Walk and will be our initial state</li>
<li>Walk leads to Run, Attack, Pause and Die</li>
<li>Run leads to Walk, Attack, Pause and Die</li>
<li>Attack leads to Walk, Run, Pause and Die</li>
<li>Pause leads to Walk, Run and Attack</li>
<li>Die leads to Start</li>
</ul>
<p>As you can see, some states are restricted to some targets and that sounds more like a plan. You could argue that you just have to be careful and avoid sending one state to the wrong. Trust me, this is not enough. Even with the following addition, your program will perform actions you expect to land somewhere and it happens to crash somewhere else. This will help you track down or stop the program before it runs in the wrong direction.</p>
<h2 id="Extending-the-State"><a href="#Extending-the-State" class="headerlink" title="Extending the State"></a>Extending the State</h2><p>First thing we need is to add some features to the state class.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> <span class="title">State</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// existing code</span></div><div class="line">        </div><div class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> forceTransition = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">public</span> List &lt;Enum&gt; transitions = <span class="literal">null</span>;</div><div class="line">         </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">State</span>(<span class="params">Enum name</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.transitions = <span class="keyword">new</span> List &lt;Enum&gt;();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>So we add the forceTransition boolean that allows to bypass the restrictions we are about to implement. You might find this a contradiction, you may have find yourself in situations where it comes useful.</p>
<p>The second addition is the list of transitions the user will define as legal. This way we create a one to many relation (or one to one, or one to none).</p>
<h2 id="Adding-states"><a href="#Adding-states" class="headerlink" title="Adding states"></a>Adding states</h2><p>The next step is to enable the addition of user state.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">AddTransitionsToState</span>(<span class="params">Enum newState, Enum[] transitions, <span class="keyword">bool</span> forceTransition = <span class="literal">false</span></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.Initialized() == <span class="literal">false</span>) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.states.ContainsKey(newState) == <span class="literal">false</span>) &#123; <span class="keyword">return</span>; &#125;</div><div class="line"> </div><div class="line">    State s = states[newState];</div><div class="line">    s.forceTransition = forceTransition;</div><div class="line">    <span class="keyword">foreach</span> (Enum t <span class="keyword">in</span> transitions)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (s.transitions.Contains(t) == <span class="literal">true</span>)</div><div class="line">        &#123;</div><div class="line">            Debug.LogError(<span class="string">"State: "</span> + newState + <span class="string">" already contains a transition for "</span> + t + <span class="string">" in "</span> + <span class="keyword">this</span>.GetType().ToString());</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        s.transitions.Add(t);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>And there it is, no big magic once again. The first parameter is the state we are creating, the second parameter is the array of states we allow to go to. The last parameter will define if the state should allow any transition, default is false. The method reuses Initialized method from previous article.</p>
<p>So for our Walk state:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> PlayerState&#123; Start, Walk, Run, Attack, Die, Pause &#125;</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerController</span>:<span class="title">StateMachine</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">         InitializeStateMachine&lt;PlayerState&gt;(PlayerState.Walk, <span class="literal">true</span>);</div><div class="line">         AddTransitionsToState(PlayerState.Walk, <span class="keyword">new</span> Enum[]&#123; PlayerState.Run,PlayerState.Attack, PlayerState.Die, PlayerState,Pause &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The last parameter is left blank as forceTransition should be false by default. We just added Run, Attack, Die and Pause to its transitions list.</p>
<h2 id="Changing-state-1"><a href="#Changing-state-1" class="headerlink" title="Changing state"></a>Changing state</h2><p>First, we need a method that would tell us if a transition is legit.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">IsLegalTransition</span>(<span class="params">Enum fromstate, Enum tostate</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.Initialized() == <span class="literal">false</span>) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.states.ContainsKey(fromstate) &amp;&amp; <span class="keyword">this</span>.states.ContainsKey(tostate))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.states[fromstate].forceTransition == <span class="literal">true</span> || <span class="keyword">this</span>.states[fromstate].transitions.Contains(tostate) == <span class="literal">true</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The method is made protected so you can actually check in sub classes if the change of state is legit. So the first check is always the initialization. Then comes the check to see if both states are registered and finally either the state allows any transition or the source state allows the transition to the target state.</p>
<p>We can now implement the changing of state.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">ChangeCurrentState</span>(<span class="params">Enum newstate, <span class="keyword">bool</span> forceTransition = <span class="literal">false</span></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.Initialized() == <span class="literal">false</span>) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.inTransition)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.debugMode == <span class="literal">true</span>)</div><div class="line">        &#123;</div><div class="line">            Debug.LogWarning(<span class="keyword">this</span>.GetType().ToString() + <span class="string">" requests transition to state "</span> + newstate +</div><div class="line">                                    <span class="string">" when still transitioning"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (forceTransition || <span class="keyword">this</span>.IsLegalTransition(<span class="keyword">this</span>.currentState.name, newstate))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.debugMode == <span class="literal">true</span>)</div><div class="line">        &#123;</div><div class="line">            Debug.Log(<span class="keyword">this</span>.GetType().ToString() + <span class="string">" transition: "</span> + <span class="keyword">this</span>.currentState.name + <span class="string">" =&gt; "</span> + newstate);</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        State transitionSource = <span class="keyword">this</span>.currentState;</div><div class="line">        State transitionTarget = <span class="keyword">this</span>.states[newstate];</div><div class="line">        <span class="keyword">this</span>.inTransition = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">this</span>.currentState.exitMethod(transitionTarget.name);</div><div class="line">        transitionTarget.enterMethod(transitionSource.name);</div><div class="line">        <span class="keyword">this</span>.currentState = transitionTarget;</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (transitionTarget == <span class="literal">null</span> || transitionSource == <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            Debug.LogError(<span class="keyword">this</span>.GetType().ToString() + <span class="string">" cannot finalize transition; source or target state is null!"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">this</span>.inTransition = <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        Debug.LogError(<span class="keyword">this</span>.GetType().ToString() + <span class="string">" requests transition: "</span> + <span class="keyword">this</span>.currentState.name + <span class="string">" =&gt; "</span> + newstate + <span class="string">" is not a defined transition!"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">this</span>.OnUpdate = <span class="keyword">this</span>.currentState.updateMethod;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The first parameter takes the state to which we want to move. The second parameter will force the transition in case we do need to get there whatever it takes and we did not set the current state to accept the target state. It could be for instance a crash state while we already have 20 states and we do not want to manually add it to each single state. The rest is pretty much the same as in the previous article apart from the call to the if statement checking if we HAVE to transit or if it is a legal transition.</p>
<h2 id="Using-the-FSM"><a href="#Using-the-FSM" class="headerlink" title="Using the FSM"></a>Using the FSM</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerController</span> : <span class="title">StateTest</span> </div><div class="line">&#123;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">float</span> timer = <span class="number">0</span>f;</div><div class="line">     <span class="keyword">private</span> Enum previousState;</div><div class="line">     <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>) </span></div><div class="line">     &#123;</div><div class="line">        InitializeStateMachine&lt;PlayerState&gt;(PlayerState.Start, <span class="literal">true</span>);</div><div class="line">        AddTransitionsToState(PlayerState.Start, </div><div class="line">              <span class="keyword">new</span> Enum[]&#123;PlayerState.Walk&#125;);</div><div class="line">        AddTransitionsToState(PlayerState.Walk, </div><div class="line">              <span class="keyword">new</span> Enum[] &#123; PlayerState.Run, PlayerState.Attack, PlayerState.Pause, PlayerState.Die &#125;);</div><div class="line">        AddTransitionsToState(PlayerState.Run, </div><div class="line">              <span class="keyword">new</span> Enum[] &#123; PlayerState.Walk, PlayerState.Attack, PlayerState.Pause, PlayerState.Die &#125;);</div><div class="line">        AddTransitionsToState(PlayerState.Attack, </div><div class="line">              <span class="keyword">new</span> Enum[] &#123; PlayerState.Walk, PlayerState.Run, PlayerState.Pause, PlayerState.Die &#125;);</div><div class="line">        AddTransitionsToState(PlayerState.Pause, </div><div class="line">              <span class="keyword">new</span> Enum[] &#123; PlayerState.Walk, PlayerState.Attack, PlayerState.Run&#125;);</div><div class="line">        AddTransitionsToState(PlayerState.Die, </div><div class="line">              <span class="keyword">new</span> Enum[] &#123; PlayerState.Start &#125;);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">EnterStart</span>(<span class="params">Enum previous</span>) </span>&#123; </div><div class="line">         <span class="keyword">if</span>((PlayerState)previous == PlayerState.Die)</div><div class="line">         &#123;</div><div class="line">              Debug.Log(<span class="string">"I am back from the dead"</span>);</div><div class="line">         &#125;</div><div class="line">         Debug.Log(<span class="string">"Starting game"</span>); </div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">EnterWalk</span>(<span class="params">Enum previous</span>) </span>&#123; Debug.Log(<span class="string">"Setting walk"</span>); &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UpdateWalk</span>(<span class="params"></span>) </span>&#123; Debug.Log(<span class="string">"I am walking"</span>);&#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">EnterRun</span>(<span class="params">Enum previous</span>) </span>&#123; Debug.Log(<span class="string">"EnterRun"</span>); &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UpdateRun</span>(<span class="params"></span>) </span>&#123; Debug.Log(<span class="string">"I am running"</span>);&#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">EnterRun</span>(<span class="params">Enum previous</span>) </span>&#123; Debug.Log(<span class="string">"EnterRun"</span>); &#125;</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">EnterAttack</span>(<span class="params">Enum previous</span>)</span></div><div class="line">    &#123;</div><div class="line">         timer = <span class="number">0</span>f;</div><div class="line">         <span class="keyword">this</span>.previousState = previous;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UpdateAttack</span>(<span class="params"></span>) </span>&#123; Debug.Log(<span class="string">"I am attacking"</span>);</div><div class="line">         timer += Time.deltaTime;</div><div class="line">         <span class="keyword">if</span>(timer &gt;= <span class="number">1.0</span>f)&#123; ChangeCurrentState(previous); &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">EnterPause</span>(<span class="params">Enum previous</span>)</span></div><div class="line">    &#123;</div><div class="line">         previousState = previous;</div><div class="line">         <span class="comment">// Stopping the game!!</span></div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UpdatePause</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.P) &amp;&amp; (PlayerState)Current != PlayerState.Pause) &#123; ChangeCurrentState(previous); &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ExitPause</span>(<span class="params">Enum nextState</span>)</span></div><div class="line">    &#123;</div><div class="line">         <span class="comment">// Restarting the game!!</span></div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">EnterDie</span>(<span class="params">Enum next</span>) </span>&#123; Debug.Log(<span class="string">"I am so dead right now"</span>); &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UpdateDie</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="comment">// Should we restart</span></div><div class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.S)) &#123; ChangeCurrentState(StateParent.Start); &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>) </span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">base</span>.Update();</div><div class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.P) &amp;&amp; (PlayerState)Current != PLayerState.Pause) &#123; ChangeCurrentState(StateParent.Pause); &#125;</div><div class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.W)) &#123; ChangeCurrentState(StateParent.Walk); &#125;</div><div class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.A)) &#123; ChangeCurrentState(StateParent.Attack); &#125;</div><div class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.R)) &#123; ChangeCurrentState(StateParent.Run); &#125;</div><div class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.D)) &#123; ChangeCurrentState(StateParent.Die); &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> PlayerState </div><div class="line">&#123;</div><div class="line">    Start, Walk, Run, Attack, Die , Pause</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The example is again simple, I leave to you to come up with your own version. Maybe you can share it in the comments. Basically, it is meant to print what happens. You will notice that some actions are only performed for the specific state. For instance, the S key is only check when dead. A better and more thorough implementation would have been to place the input in methods that are called within the appropriate state updates.</p>
<h2 id="Conclusion-1"><a href="#Conclusion-1" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This is it for this part. We can now prevent wrong state transition so our FSM is more robust avoiding transition that should not be. Again, if you see some errors, problems or if there would be some features you would think of, let us know.</p>
<h2 id="StateMachine-–-FSM-–-Part-3"><a href="#StateMachine-–-FSM-–-Part-3" class="headerlink" title="StateMachine – FSM – Part 3"></a>StateMachine – FSM – Part 3</h2><p><img src="../_images/unity/j-alves-impossible-gears.png" alt="J-Alves-impossible-gears"></p>
<p>The article is currently being reviewed so it might contain some leftovers of previous version that are outdated.<br>Final part of the FSM, in this article we should add some methods that will give us some more flexibility and information.<br>At the moment, we can know the current state but there will be situations when we need to know where we came from, or if a state exists based on what state we have already registered.<br>The FSM does not allow us to create what could be considered multi-transition so we would need that too.<br>How about adding and removing state at runtime? There could be cases where we want and need that.<br>And finally, adding a transition to an existing state will enable inheritance.</p>
<p>The extra step we could add but I will leave it up to you, is to override the methods containing debug line. You may want to create your own versions, shorter, longer with precise info and so on.</p>
<p>Create a new script and name it StateMachine, go to the link below and copy paste the content onto your new script.</p>
<p><a href="https://github.com/fafase/unity-utilities/raw/master/Scripts/StateMachineC" target="_blank" rel="external">github-mark@1200x630</a></p>
<h2 id="Adding-helper-methods"><a href="#Adding-helper-methods" class="headerlink" title="Adding helper methods"></a>Adding helper methods</h2><p>Let’s consider a UI system based on Model-View-Controller (MVC). In this situation, you have a class containing the methods for the UI buttons, mainly the action that should be performed on press of a button. This action is send to the UIController which contains most of the “intelligent” methods and also the FSM of the GUI. The last one contains all the view methods, mostly some methods called from the controller to switch on and off the UI items.<br>The Action class has a reference to the controller and the controller has a reference to the view.</p>
<p>Let’s think of the Pause button. It can be pressed anytime in the game and should return to the same state. When the action is pressed, the action class sends the info to the controller and set the FSM to pause, spreading the info to whatever is interested. Now once the pause is pressed again, either we recorded the previous state or we create it in the FSM.</p>
<p>Remember our transitionSource variable we create in the ChangeCurrentState, well, we just need to make it global.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StateMachine</span> : <span class="title">MonoBehaviour</span>&#123;</div><div class="line">    <span class="keyword">private</span> State transitionSource = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">public</span> Enum PreviousState &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.transitionSource.name; &#125; &#125;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ChangeCurrentState</span>(<span class="params">Enum newstate, <span class="keyword">bool</span> forceTransition = <span class="literal">false</span></span>)</span></div><div class="line">    &#123;</div><div class="line">         <span class="comment">// Code</span></div><div class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.IsLegalTransition(<span class="keyword">this</span>.currentState.name, newstate))</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// Code</span></div><div class="line"> </div><div class="line">            <span class="keyword">this</span>.transitionSource = <span class="keyword">this</span>.currentState;</div><div class="line">            State transitionTarget = <span class="keyword">this</span>.states[newstate];</div><div class="line">            </div><div class="line">            <span class="comment">// Code</span></div><div class="line">            <span class="keyword">if</span> (transitionTarget == <span class="literal">null</span> || <span class="keyword">this</span>.transitionSource == <span class="literal">null</span>)</div><div class="line">            &#123;</div><div class="line">                Debug.LogError(<span class="keyword">this</span>.GetType().ToString() + <span class="string">" cannot finalize transition; source or target state is null!"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">this</span>.inTransition = <span class="literal">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>I stripped the code to a minimum of lines so that you can see where it happens. Before we were creating the transition state and destroying it at the end of the method since it was local. Now that we made it global it will remain and contain the previous state.</p>
<p>Next helper method I could think of would be getting all the states currently registered as well as does a state exist then all the transitions registered in a state. We already can check if a state and transition are legit.</p>
<p>You should understand that those methods are only useful in some specific cases. IF we would have made the members public, this would be easier but also breaking encapsulation. So we need methods to get info without risking to break the machine.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">ContainsState</span>(<span class="params">Enum state</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.states.ContainsKey(state);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> Enum[] <span class="title">GetTransitionsFromState</span>(<span class="params">Enum state</span>) </span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.states.ContainsKey(state) == <span class="literal">false</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.debugMode)</div><div class="line">        &#123;</div><div class="line">            Debug.LogError(<span class="string">"The given state "</span> + state + <span class="string">" is not a registered state"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.states[state].transitions.ToArray(); </div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> State[] <span class="title">GetAllStates</span>(<span class="params"></span>) </span></div><div class="line">&#123;</div><div class="line">    List&lt;State&gt;list = <span class="keyword">new</span> List&lt;State&gt;();</div><div class="line">    <span class="keyword">foreach</span>(<span class="keyword">var</span> kvp <span class="keyword">in</span> <span class="keyword">this</span>.states)</div><div class="line">    &#123;</div><div class="line">        list.Add(kvp.Value);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> list.ToArray();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In order to enable the GetAllStates method, we need to make the State class public or the State type is not available outside the FSM.<br>This is it for the basic helper methods, let’s now move on to another topic.</p>
<h2 id="Multi-transition"><a href="#Multi-transition" class="headerlink" title="Multi-transition"></a>Multi-transition</h2><p>The way the FSM has been defined, we restricted the possibility to move to a new state while transitioning.<br>To explain the needs for that feature, consider the user can see a tutorial before entering a level, if he already saw the tutorial, then switch to game:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">EnterTutorial</span>(<span class="params">Enum oldState</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(AppController.Instance.HasSeenTutorial == <span class="literal">true</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.ChangeCurrentState(AppState.GameOn);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// More code</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>As we enter, if the AppController tells the tutorial was already seen, then we switch state to game. Obviously, we could have checked for that earlier when the change of state was triggered. Or we can just allow this feature and make it easy.<br>I would consider the feature only available in EnterMethod. Think that you define state A to go to state B and this one defines that on some conditions, it goes directly to state C. The state was entered and left but it was run.<br>Other situation, state A goes to state B but in the exit method of A, it switch to state C. Now you were expecting B to happen but something made it jump to C. Now should we be queuing B so that it runs after C or should B be first and then C? Well, nope, let’s not make it happen, end of discussion.</p>
<p>It will also require to modify a couple of methods and a few new variables.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> State transitionQueue = <span class="literal">null</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">bool</span> allowMultiTransition = <span class="literal">false</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">bool</span> inExitMethod = <span class="literal">false</span>;</div><div class="line"> </div><div class="line"><span class="keyword">protected</span> <span class="keyword">void</span> InitializeStateMachine&lt;T&gt;(Enum initialState, <span class="keyword">bool</span> debug, <span class="keyword">bool</span> multiTransition = <span class="literal">false</span>) </div><div class="line">&#123;</div><div class="line">    <span class="comment">// Code</span></div><div class="line">    <span class="keyword">this</span>.allowMultiTransition = multiTransition;</div><div class="line">    <span class="comment">// Code</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We add three variables, transitionQueue is of type State and will inform if we should trigger a new transition. allowMultiTransition defines if we allowed the multi-transition feature (it is set in the initialization method) and the inExitMethod is tracking if we are trying to switch while in exit method (never underestimate how wrong a coder can code).</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">ChangeCurrentState</span>(<span class="params">Enum newstate, <span class="keyword">bool</span> forceTransition = <span class="literal">false</span></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.Initialized() == <span class="literal">false</span>) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.inTransition == <span class="literal">true</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.allowMultiTransition == <span class="literal">false</span>) </div><div class="line">        &#123;</div><div class="line">            <span class="comment">// Code</span></div><div class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params"><span class="keyword">this</span>.allowMultiTransition == <span class="literal">true</span></span>)</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.inExitMethod == <span class="literal">true</span>)</div><div class="line">            &#123;</div><div class="line">                Debug.LogWarning(<span class="keyword">this</span>.GetType().ToString() + <span class="string">" requests new state in exit method is not recommended"</span>);</div><div class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">this</span>.transitionQueue = states[newstate]; <span class="comment">// here</span></div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.IsLegalTransition(<span class="keyword">this</span>.currentState.name, newstate))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.debugMode == <span class="literal">true</span>)</div><div class="line">        &#123;</div><div class="line">            Debug.Log(<span class="keyword">this</span>.GetType().ToString() + <span class="string">" transition: "</span> + <span class="keyword">this</span>.currentState.name + <span class="string">" =&gt; "</span> + newstate);</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="keyword">this</span>.transitionSource = <span class="keyword">this</span>.currentState;</div><div class="line">        State transitionTarget = <span class="keyword">this</span>.states[newstate];</div><div class="line">        <span class="keyword">this</span>.inTransition = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">this</span>.inExitMethod = <span class="literal">true</span>; <span class="comment">// Added line here</span></div><div class="line">        <span class="keyword">this</span>.currentState.exitMethod(transitionTarget.name);</div><div class="line">        <span class="keyword">this</span>.inExitMethod = <span class="literal">false</span>; <span class="comment">// Added line here</span></div><div class="line">        transitionTarget.enterMethod(<span class="keyword">this</span>.currentState.name);</div><div class="line">        <span class="keyword">this</span>.currentState = transitionTarget;</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (transitionTarget == <span class="literal">null</span> || <span class="keyword">this</span>.transitionSource == <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            Debug.LogError(<span class="keyword">this</span>.GetType().ToString() + <span class="string">" cannot finalize transition; source or target state is null!"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.inTransition = <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Debug.LogError(<span class="keyword">this</span>.GetType().ToString() + <span class="string">" requests transition: "</span> + <span class="keyword">this</span>.currentState.name + <span class="string">" =&gt; "</span> + newstate + <span class="string">" is not a defined transition!"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Added code here </span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.allowMultiTransition == <span class="literal">true</span> &amp;&amp; <span class="keyword">this</span>.transitionQueue !=  <span class="literal">null</span>)</div><div class="line">    &#123;</div><div class="line">        State temp = <span class="keyword">this</span>.transitionQueue;</div><div class="line">        <span class="keyword">this</span>.transitionQueue = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">this</span>.ChangeCurrentState(temp.name);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">this</span>.OnUpdate = <span class="keyword">this</span>.currentState.updateMethod;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ChangeCurrentState is a little longer. The idea is that if the FSM is transiting while this is called, it means while we were in the Enter method of a state, a ChangeCurrentState was found. So we are stacking up state transition. If we allow multi-transition, we check that we ar not in the exit method and register the new state into transitionQueue and return to avoid calling the rest of the method. This is the snippet below:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params"><span class="keyword">this</span>.allowMultiTransition == <span class="literal">true</span></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.inExitMethod == <span class="literal">true</span>)</div><div class="line">    &#123;</div><div class="line">        Debug.LogWarning(<span class="keyword">this</span>.GetType().ToString() + <span class="string">" requests new state in exit method is not recommended"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.transitionQueue = states[newstate]; <span class="comment">// here</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In order to prevent the switch in exit method, here is what we do:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.inExitMethod = <span class="literal">true</span>; <span class="comment">// Added line here</span></div><div class="line"><span class="keyword">this</span>.currentState.exitMethod(transitionTarget.name);</div><div class="line"><span class="keyword">this</span>.inExitMethod = <span class="literal">false</span>; <span class="comment">// Added line here</span></div><div class="line">transitionTarget.enterMethod(<span class="keyword">this</span>.currentState.name);</div></pre></td></tr></table></figure>
<p>The inExitMethod is set tot true, then we call the exiting method via the delegate. This jumps to the ExitMethod of the current state and if there was a call for ChangCurrentState within it, then the inExitMethod is true, it fails. Once the exit method returns fine without any failure, we reset the inExitMethod to false and call the enter method delegate of the new state. Now if there is a call for ChangeCurrentState in this one, no problem, we just run the method again but the new state will be added to the transitionQueue reference.</p>
<p>The final part of the method checks if any transiting state is pending:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Added code here </span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.allowMultiTransition == <span class="literal">true</span> &amp;&amp; <span class="keyword">this</span>.transitionQueue !=  <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line">    State temp = <span class="keyword">this</span>.transitionQueue;</div><div class="line">    <span class="keyword">this</span>.transitionQueue = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">this</span>.ChangeCurrentState(temp.name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If the transitionQueue reference is not null, we have a pending state. We asiign it to a temporary state and set it to null (this prevent recursive call, a queue would have done it as well). Then we call for ChangeCurrentState with the new state and the process goes on again. Once all transition are done, the end of the method is run and finally, we give control back to the application.</p>
<h2 id="Adding-Removing-states"><a href="#Adding-Removing-states" class="headerlink" title="Adding/Removing states"></a>Adding/Removing states</h2><p>The final step for our FSM is to allow addition and removal of transitions into an existing state. Consider you have an object that evolve in time, so you may want to add attribute in time. This you can already do. But what we cannot do is remove states.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">RemoveTransitionToExistingState</span>(<span class="params">Enum state, Enum[]transitions</span>) </span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.states.ContainsKey(state) == <span class="literal">false</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.debugMode)</div><div class="line">        &#123;</div><div class="line">            Debug.LogError(<span class="string">"The given state "</span> + state + <span class="string">" is not a registered state"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    State existingState = <span class="keyword">this</span>.states[state];</div><div class="line">    <span class="keyword">foreach</span> (Enum transition <span class="keyword">in</span> transitions)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.states.ContainsKey(transition) == <span class="literal">false</span>)</div><div class="line">        &#123;</div><div class="line">            Debug.LogError(transition + <span class="string">" is not a registered state"</span>);</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (existingState.transitions.Contains(transition) == <span class="literal">false</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.debugMode)</div><div class="line">            &#123;</div><div class="line">                Debug.LogWarning(existingState.name + <span class="string">" does not contain "</span> + transition);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        existingState.transitions.Remove(transition);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We can now remove states if our object is losing ability for instance. We already know how to add states. We have only done it in Start but we can do it anytime.</p>
<p>Note that this allows us to consider upgrade as state additions. A newly collected item may add a new state that we can use.</p>
<h2 id="Inheritance"><a href="#Inheritance" class="headerlink" title="Inheritance"></a>Inheritance</h2><p>In order to enable inheritance, we first need to update our GetMethodInfo and add a new method that will take care of adding new states later on when initialization is already done and cannot be called again:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> T GetMethodInfo&lt;T&gt; (<span class="keyword">object</span> obj, Type type, <span class="keyword">string</span> method, T Default) <span class="keyword">where</span> T : <span class="keyword">class</span></div><div class="line">&#123;</div><div class="line">    Type baseType = type;</div><div class="line">    <span class="keyword">while</span> (baseType != <span class="keyword">typeof</span>(MonoBehaviour))</div><div class="line">    &#123;</div><div class="line">        MethodInfo methodInfo = baseType.GetMethod(method, BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance);</div><div class="line">        <span class="keyword">if</span> (methodInfo != <span class="literal">null</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> Delegate.CreateDelegate(<span class="keyword">typeof</span>(T), obj, methodInfo) <span class="keyword">as</span> T;</div><div class="line">        &#125;</div><div class="line">        baseType = baseType.BaseType;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> Default;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">CreateNewStateWithTransitions</span>(<span class="params">Enum newState, Enum[] transitions, <span class="keyword">bool</span> forceTransition = <span class="literal">false</span></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.Initialized() == <span class="literal">false</span>) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.CreateNewState(newState) == <span class="literal">false</span>) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</div><div class="line"> </div><div class="line">    State s = states[newState];</div><div class="line">    s.forceTransition = forceTransition;</div><div class="line">    <span class="keyword">foreach</span> (Enum t <span class="keyword">in</span> transitions)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (s.transitions.Contains(t) == <span class="literal">true</span>)</div><div class="line">        &#123;</div><div class="line">            Debug.LogError(<span class="string">"State: "</span> + newState + <span class="string">" already contains a transition for "</span> + t + <span class="string">" in "</span> + <span class="keyword">this</span>.GetType().ToString());</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        s.transitions.Add(t);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If our base class contains private FSM methods, our sub class would not contain them, so if we want the FSM to find them, we need to iterate through the class inheritance. When the method info is null, we search the class above for the missing class.</p>
<p>This may seem confusing so look at this:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Top</span> : <span class="title">StateMachine</span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        InitializeStateMachine&lt;TopState&gt;(TopState.Init, <span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateInit</span>(<span class="params"></span>)</span>&#123;&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sub</span> :<span class="title">Top</span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>We have a problem. When the initialization method will run, it will consider the calling type, and that is Sub. But Sub has no UpdateInit since it is private in Top. One solution is to make it protected but maybe that is not intended or make the FSM search for it as we did.</p>
<p>The Add/Remove feature actually opens a whole new universe. Until now, we were not able to consider inheritance. If we add an Enemy class with a FSM, we were not able to create a Archer class with specific states to add to Enemy and another Cavalery class with different states to add to Enemy. Now we simply can.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Enemy</span> : <span class="title">StateMachine</span>&#123;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>) </span></div><div class="line">    &#123;</div><div class="line">        InitializeStateMachine&lt;StateEnemy&gt;(StateEnemy.Start, <span class="literal">true</span>, <span class="literal">true</span>);</div><div class="line">        AddTransitionsToState(StateEnemy.Start, <span class="keyword">new</span> Enum[]&#123;StateEnemy.Walk&#125;);</div><div class="line">        AddTransitionsToState(StateEnemy.Run, <span class="keyword">new</span> Enum[] &#123; StateEnemy.Walk &#125;);</div><div class="line">        AddTransitionsToState(StateEnemy.Walk, <span class="keyword">new</span> Enum[] &#123; StateEnemy.Start, StateEnemy.Run &#125;);    </div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Archer</span> : <span class="title">Enemy</span></div><div class="line">&#123;</div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>) </span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// Call this one first</span></div><div class="line">        <span class="keyword">base</span>.Awake();</div><div class="line">        <span class="comment">// Do not call that one it was already in the base</span></div><div class="line">        <span class="comment">// InitializeStateMachineWithTransitions(true, true); </span></div><div class="line">        CreateNewStateWithTransitions(StateArcher.Shoot, <span class="keyword">new</span> Enum[]&#123;StateEnemy.Walk&#125;); </div><div class="line">        AddTransitionsToState(StateEnemy.Walk, <span class="keyword">new</span> Enum[]&#123;StateArcher.Shoot&#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Cavalery</span> :<span class="title">Enemy</span></div><div class="line">&#123;</div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>) </span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// Call this one first</span></div><div class="line">        <span class="keyword">base</span>.Awake();</div><div class="line">        <span class="comment">// Do not call that one it was already in the base</span></div><div class="line">        <span class="comment">// InitializeStateMachineWithTransitions(true, true); </span></div><div class="line">        CreateNewStateWithTransitions(StateCavalery.Ride, <span class="keyword">new</span> Enum[]&#123;StateEnemy.Walk&#125;); </div><div class="line">        AddTransitionsToState(StateEnemy.Walk, <span class="keyword">new</span> Enum[]&#123;StateCavalery.Ride&#125;);</div><div class="line">        ChangeCurrentState(StateCavalery.Ride);  <span class="comment">// Set starting state</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Alright, so the base.Awake() has to be called before anything else so that it initializes the FSM. Calling it again in sub class would crash. If you want to know whether a class has a FSM above, make the IsInitialized method protected and call it to see if it is already done.<br>Each sub class registers its own states and add them to the Enemy states. Notice the Cavalery also sets the entry state. We would not be able to do that if the base.Awake was not called first, we would always end up in the state defined in Enemy.</p>
<p>Conclusion<br>This is now the end of the series, we went from a simple FSM to a more advanced. Based on what you are doing, the first one might be enough, if you do not consider inheritance for instance. In this case, I would use the second version for development and the first article once I got it all working.</p>
<p>Here is the interface of our FSM:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Enum PreviousState&#123; <span class="keyword">get</span>; &#125;</div><div class="line"><span class="keyword">public</span> Enum CurrentState&#123; <span class="keyword">get</span>; &#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">Initialized</span>(<span class="params"></span>)</span>;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span>;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitializeStateMachineWithTransitions</span>(<span class="params"><span class="keyword">bool</span> debug, <span class="keyword">bool</span> multiTransition = <span class="literal">false</span></span>)</span>;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">CreateNewStateWithTransitions</span>(<span class="params">Enum newState, Enum[] transitions, <span class="keyword">bool</span> forceTransition = <span class="literal">false</span></span>)</span>;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">IsLegalTransition</span>(<span class="params">Enum fromstate, Enum tostate</span>)</span>;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">ChangeCurrentState</span>(<span class="params">Enum newstate, <span class="keyword">bool</span> forceTransition = <span class="literal">false</span></span>)</span>;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">AddTransitionToExistingState</span>(<span class="params">Enum state, Enum[] transitions</span>)</span>;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">RemoveTransitionToExistingState</span>(<span class="params">Enum state, Enum[]transitions</span>)</span>;</div><div class="line"><span class="function"><span class="keyword">protected</span> Enum[] <span class="title">GetTransitionsFromState</span>(<span class="params">Enum state</span>)</span>;</div><div class="line"><span class="function"><span class="keyword">protected</span> State[] <span class="title">GetAllState</span>(<span class="params"></span>)</span>;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">bool</span> <span class="title">ContainsState</span>(<span class="params">Enum state</span>)</span>;</div></pre></td></tr></table></figure>
<h2 id="原文链接"><a href="#原文链接" class="headerlink" title="原文链接"></a>原文链接</h2><ul>
<li><a href="https://unitygem.wordpress.com/state-machine-basic/" target="_blank" rel="external">State Machine – Basic</a></li>
<li><a href="https://unitygem.wordpress.com/state-machine-fsm-part-2/" target="_blank" rel="external">State Machine – FSM – Part 2</a></li>
<li><a href="https://unitygem.wordpress.com/fsm-part-3/" target="_blank" rel="external">StateMachine – FSM – Part 3</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tospan.me/2017/02/07/Unity-FSM/" data-id="ciyvdy4bp001g9qvwchbgpls8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/default/">default</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/02/07/Unity-Object-Pools-2/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Unity Object Pools 2</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorier</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unity/">Unity</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/default/">default</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Basics/">Basics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Games/">Games</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Geometry/">Geometry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linear-Algebra/">Linear Algebra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Numerical-Analysis/">Numerical Analysis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/default/">default</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Basics/" style="font-size: 14px;">Basics</a> <a href="/tags/C/" style="font-size: 12px;">C#</a> <a href="/tags/Games/" style="font-size: 10px;">Games</a> <a href="/tags/Geometry/" style="font-size: 12px;">Geometry</a> <a href="/tags/Linear-Algebra/" style="font-size: 16px;">Linear Algebra</a> <a href="/tags/Math/" style="font-size: 18px;">Math</a> <a href="/tags/Numerical-Analysis/" style="font-size: 10px;">Numerical Analysis</a> <a href="/tags/Unity/" style="font-size: 20px;">Unity</a> <a href="/tags/default/" style="font-size: 16px;">default</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Arkiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Siste innlegg</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/07/Unity-FSM/">Unity FSM</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Object-Pools-2/">Unity Object Pools 2</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Scripting-Coroutine-Delay/">Unity Scripting Coroutine Delay</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Scripting-Coroutine/">Unity Scripting Coroutine</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Scripting-Memory-Management/">Unity Scripting Memory Management</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 To Span<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>