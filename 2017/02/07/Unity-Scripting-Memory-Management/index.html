<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Unity Scripting Memory Management | 吐司片的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="In This Article
Memory Zones
Value Types and the Stack
Reference Types and the Heap
Struct vs Class
Creating a Reference
Static Classes
Static Variables
Static Functions
Heap Fragmentation, Object Poo">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity Scripting Memory Management">
<meta property="og:url" content="http://tospan.me/2017/02/07/Unity-Scripting-Memory-Management/index.html">
<meta property="og:site_name" content="吐司片的博客">
<meta property="og:description" content="In This Article
Memory Zones
Value Types and the Stack
Reference Types and the Heap
Struct vs Class
Creating a Reference
Static Classes
Static Variables
Static Functions
Heap Fragmentation, Object Poo">
<meta property="og:image" content="http://tospan.me/../_images/unity/Stack-300x150.png">
<meta property="og:image" content="http://tospan.me/../_images/unity/Stack2-300x253.png">
<meta property="og:image" content="http://tospan.me/../_images/unity/Diapositive8-300x182.png">
<meta property="og:image" content="http://tospan.me/../_images/unity/Diapositive4-231x300.png">
<meta property="og:image" content="http://tospan.me/../_images/unity/Diapositive6-300x136.png">
<meta property="og:image" content="http://tospan.me/../_images/unity/Heap-300x138.png">
<meta property="og:image" content="http://tospan.me/../_images/unity/Diapositive5-300x149.png">
<meta property="og:updated_time" content="2017-02-07T08:05:09.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unity Scripting Memory Management">
<meta name="twitter:description" content="In This Article
Memory Zones
Value Types and the Stack
Reference Types and the Heap
Struct vs Class
Creating a Reference
Static Classes
Static Variables
Static Functions
Heap Fragmentation, Object Poo">
<meta name="twitter:image" content="http://tospan.me/../_images/unity/Stack-300x150.png">
  
    <link rel="alternate" href="/atom.xml" title="吐司片的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">吐司片的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Work hard, play hard.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Søk"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://tospan.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Unity-Scripting-Memory-Management" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/07/Unity-Scripting-Memory-Management/" class="article-date">
  <time datetime="2017-02-07T08:05:09.000Z" itemprop="datePublished">2017-02-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/default/">default</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Unity Scripting Memory Management
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="In-This-Article"><a href="#In-This-Article" class="headerlink" title="In This Article"></a>In This Article</h2><ul>
<li>Memory Zones</li>
<li>Value Types and the Stack</li>
<li>Reference Types and the Heap</li>
<li>Struct vs Class</li>
<li>Creating a Reference</li>
<li>Static Classes</li>
<li>Static Variables</li>
<li>Static Functions</li>
<li>Heap Fragmentation, Object Pooling and Garbage Collection</li>
</ul>
<a id="more"></a>
<p>This tutorial is especially useful for C/C++ programmers making the move to C# for Unity development.  C# handles memory in a very different way which can appear confusing or magical at first and like all systems comes with its own pitfalls and idiosyncrasies.<br>When starting programming with Unity and programming in general many falls upon the purpose of variable types. For instance, why sometimes some variables are updated and others remain the same, why is my variable gone when I still need it.</p>
<p>Another common issue for beginners is the use of static variables. You often meet them in the various tutorials on the Internet but the tutors barely take the time to clearly explain and only end up claiming the “easy access of the variables”.</p>
<p>The problem is, static variables (also called class variables) are no easy topic.</p>
<p>Some might even tell you to simply avoid using them as whatever is done with static can be done with other types. We will see that if that could be true, it is not necessarily the best solution.</p>
<p>Before kicking off, if you have a C background and no real object-orientated programming, keep in mind that what you know about memory management and storage keyword is not totally similar in OOP. Try not to relate C usage with C#’s.<br>In this tutorial, we will cover the different memory zones, the value types, the reference types, the dynamic memory allocation and the static variables.</p>
<p>Memory Zones</p>
<p>When starting a program, the operating system allocates parts of the memory to the program. There used to be four main zones, the call stack, the heap, the register and the static memory.</p>
<p>The developers of the C# language have been kind enough to narrow it to two main zones only, stack and heap. The first is ordered, fast but limited. The second is random, large and then slower.</p>
<p>It is possible for the programmer to decide which of these is used for each variable depending on the purpose and the fate of the variable.</p>
<p>There are three storage class keywords (there used to be a fourth one in C, register) to be used for memory allocation, auto, static (those are the ones we are about to cover) and extern.</p>
<p>extern is a keyword you might encounter. It just means you declare a variable that is declared outside of the code in your project – for instance it’s a variable in a plugin DLL written in a different, non .NET language.</p>
<p>If you are a C programmer note that the meaning of extern is subtlety different in C# – where it refers to a variable that is not allocated in <em>managed memory</em>.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> <span class="keyword">int</span> number;</div></pre></td></tr></table></figure>
<p>The compiler will not allocate memory for number and expect the variable to be found somewhere else. We will not dwell any further on this. You may find more information <a href="https://web.archive.org/web/20140702030338/http://msdn.microsoft.com/en-us/library/e59b22c5(v=vs.71" target="_blank" rel="external">on this link</a>.aspx).</p>
<h2 id="Value-Types-and-the-Stack"><a href="#Value-Types-and-the-Stack" class="headerlink" title="Value Types and the Stack"></a>Value Types and the Stack</h2><p>Auto stands for automatic variable. You might have never seen the keyword though as it is not used in C# anymore. Back in the old days, auto would stand for the default variable:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> variable = <span class="number">10</span>;</div><div class="line">auto <span class="keyword">int</span> variable = <span class="number">10</span>;</div></pre></td></tr></table></figure>
<p>Those two lines are exactly the same.</p>
<p>The feature of an automatic variable is that it is allocated in the call stack. A stack is a pile of variables, just like a pile of plates, you can only remove the top one or add on the top but you cannot remove the bottom one or add at the bottom. See picture below.</p>
<p><img src="../_images/unity/Stack-300x150.png" alt="Stack"></p>
<p>A stack is said to be a LIFO (Last-In-First-Out), simply said what you put last will be taken out first.<br>In order to know what the top of the stack is, the program uses a stack pointer which is a variable in the CPU that keeps track of the current position in the stack represented by the black arrow on the picture. As we add a variable the stack pointer is incremented (or decremented depending which way  your OS implements memory management).</p>
<p>The stack is used for function calls, if you think about it the whole program is a main function that calls Update functions which in turn call other functions so it is logical that any variables in your script is an automatic variable placed on the stack if not defined otherwise.</p>
<p>You may also encounter the concept of the stack frame – simply put this is the collection of variables allocated locally by the currently executing function (and also contains the return address that is the instruction point that will be executed immediately after the function returns).  The compiler maintains a pointer to the end of the stack frame and then actually uses a negative offset from this pointer to find the memory that your local variables occupy.  The practical upshot of this is that after a function has returned then none of the space used by its local variables is used or allocated in any way – save for being spare space for the next function call.</p>
<p>If you write a recursive program (a function that calls itself) you could potentially run the stack out of space as each subsequent call requires all of the local variables and the return address need to have space made for them on the stack – you will also see the stack overflow message if a bug in your code makes your routines call themselves without stopping.</p>
<p>So the lifetime and scope of an automatic variable go hand in hand. A variable lives from its declaration until the next closing curly brace corresponding to the closest opening curly brace above. That might need a clarification.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">int</span> number = <span class="number">10</span>;</div><div class="line">    Fct(number);</div><div class="line">    Debug.Log(number);</div><div class="line">&#125; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Fct</span>(<span class="params"><span class="keyword">int</span> n</span>)</span>&#123;</div><div class="line">    <span class="keyword">int</span> inside=<span class="number">20</span>;</div><div class="line">    n = n + inside;</div><div class="line">    Debug.Log(n);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="../_images/unity/Stack2-300x253.png" alt="Stack function"></p>
<p>The Update is called and the first command is a variable declaration. The stack pointer is pushed one up and the value of number is placed into the memory location.The second command is a function call. When calling a function, the program stops and jumps to the address of the function, some data are passed to the stack in order to retrieve the original position of the program. The parameters (if any) are also pushed to the stack by creating a copy of the original value.</p>
<p>The variable number is not pushed onto the stack to be used in the function but a new variable n is created, pushed onto the stack to which the value of number is assigned</p>
<p>We now have a variable n inside the function that has the value of number but number does not exist in Fct() and therefore cannot be seen and accessed.</p>
<p>Inside the function a new integer is declared. The stack looks something like the picture below (note that it is highly simplified).</p>
<p>By the end of the function, n is printed and has value 30. All the variables created inside the function are destroyed/lost. That includes n and inside. Even though the variables are still in memory, they are simply ignored and not considered anymore by the system.</p>
<p>Back in the Update, we print number that has the original value of 10 as it was not the variable itself which was used in the function but a copy of it. The stack pointer has lost the location of n or inside, if we tried to access them back in the Update, the compiler would return an error that the variable does not exist in this scope.</p>
<p>We just saw that the scope of an automatic variable is defined by the { } it was declared in. Outside of them, the variable does not exist and cannot be seen. Those curly brackets can mark the scope of a function, an if-statement or a loop.</p>
<h2 id="Lifetime-and-scope"><a href="#Lifetime-and-scope" class="headerlink" title="Lifetime and scope"></a>Lifetime and scope</h2><p>Note that lifetime means the time in the program the variable exists, scope defines the zones of the program the variable is visible. In the case of automatic variables, both are similar.</p>
<p>Any value type variable is stored in the stack, those are:</p>
<ul>
<li>int</li>
<li>unsigned</li>
<li>float</li>
<li>double</li>
<li>char</li>
<li>struct</li>
<li>bool</li>
<li>byte</li>
<li>enum</li>
<li>long</li>
<li>short</li>
</ul>
<p>Pretty much, all the types inherited from C except for bool that did not exist back then.</p>
<p>For an automatic variable, its life is taken care by the compiler. The end of the scope in which it was declared marks also the end of the variable. The programmer does not have to care about releasing the memory location for further use, it is done automatically.</p>
<h2 id="Reference-Types-and-the-Heap"><a href="#Reference-Types-and-the-Heap" class="headerlink" title="Reference Types and the Heap"></a>Reference Types and the Heap</h2><p>A reference type variable is an object stored in memory as a reference. When creating a new instance of a class, the data are stored in the heap as well as a reference to the location of those data. This reference is a variable that has the address of the object as value.To create an instance of a class we use the keyword new which is a call to the OS for some space in memory corresponding to the type of object and an instruction to run any code that is required to initialize the object.  See below for the instantiation of an object of type dog.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Dog</span>&#123;</div><div class="line">     <span class="keyword">public</span> <span class="keyword">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</div><div class="line">     <span class="keyword">public</span> <span class="keyword">int</span> age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="title">Dog</span>(<span class="params"><span class="keyword">string</span> name, <span class="keyword">int</span> age</span>)</span>&#123;</div><div class="line">           <span class="keyword">this</span>.name = name;</div><div class="line">           <span class="keyword">this</span>.age = age;</div><div class="line">    &#125;                          </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test</span> : <span class="title">MonoBehaviour</span> </div><div class="line">&#123;</div><div class="line">    Dog dog1 = <span class="keyword">new</span> Dog(<span class="string">"Rufus"</span>,<span class="number">10</span>);</div><div class="line">    Dog dog2 = <span class="keyword">new</span> Dog(<span class="string">"Brutus"</span>,<span class="number">8</span>);</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>)</span>&#123;                                                  </div><div class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KeyCode.Alpha1))</div><div class="line">            Debug.Log (<span class="string">"The dog1 is named "</span>+dog1.name+<span class="string">" and is "</span>+dog1.age);</div><div class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KeyCode.Alpha2))</div><div class="line">             Debug.Log (<span class="string">"The dog2 is named "</span>+dog2.name+<span class="string">" and is "</span>+dog2.age);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Our <em>dog1</em> and <em>dog2</em> variables are references to the locations in memory where the data concerning these objects are stored.</p>
<p><img src="../_images/unity/Diapositive8-300x182.png" alt="Class"></p>
<p>Let’s now see in action with the Instantiate function. Consider we have a prefab called Enemy which includes a 3D model, some components and some scripts.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test</span> : <span class="title">MonoBehaviour</span>&#123;</div><div class="line">    <span class="keyword">public</span> GameObject enemyPrefab;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span>(Input.GeyKeyDown(KeyCode.Space))</div><div class="line">               Instantiate(enemyPrefab,<span class="keyword">new</span> Vector3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>), Quaternion.identity);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We created a new instance of the enemyPrefab and it is up and running. Problem is we have no reference to it if we want to access it. Should we want to apply some actions to our newly created object we can create a variable that will be a reference to it.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(Input.GeyKeyDown(KeyCode.Space))</div><div class="line">       GameObject enemyRef = Instantiate(enemyPrefab, <span class="keyword">new</span> Vector3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>), Quaternion.identity);</div><div class="line">        enemyRef.AddComponent(Rigidbody);</div><div class="line">        Destroy(enemyRef);</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In this example, enemyRef is declared and assigned the address of the new object. enemyRef is now a reference to it. See how we can add a component t since the variable knows the location of the object, it is possible to add or access any public variables of the object. In the final line, the object is destroyed which, you may agree, is not really likely to be done this way but that is just for the sake of the explanation.</p>
<p>Note that the reference is an automatic variable that lives only within the { } of the if statement. Outside of it, the reference variable does not exist any longer. In order to retrieve our enemy object we would have to look for it using for instance:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GameObject enemyRefAgain = GameObject.Find(“Enemy”);</div></pre></td></tr></table></figure>
<p>Any reference type variable is stored in the heap, those are:</p>
<ul>
<li>class</li>
<li>object</li>
<li>string (string may look like a variable but it is an actual object instantiation of the classString)</li>
</ul>
<p>The main difference between the value type variables and the reference type variables is the addition of a reference variable to point where the data are stored. This reference needs first to be accessed before we can find the data. This makes our class a little slower than structures which can be accessed directly.</p>
<p>Other main issue is operation like this:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Memory</span> : <span class="title">MonoBehaviour</span> </div><div class="line">&#123;</div><div class="line">    DogC dogC1 = <span class="keyword">new</span> DogC();</div><div class="line">    DogC dogC2 = <span class="keyword">new</span> DogC();</div><div class="line">    <span class="keyword">int</span> number1;</div><div class="line">    <span class="keyword">int</span> number2;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KeyCode.Space))&#123;</div><div class="line">           number2=number1 = <span class="number">10</span>;</div><div class="line">           number1 = <span class="number">20</span>;</div><div class="line">           Debug.Log (number1+<span class="string">" "</span>+number2);</div><div class="line">           dogC1.name = <span class="string">"Rufus"</span>;</div><div class="line">           dogC1.age = <span class="number">12</span>;</div><div class="line">           dogC2 = dogC1;</div><div class="line">           dogC1.name = <span class="string">"Brutus"</span>;</div><div class="line">           Debug.Log (dogC1.name+<span class="string">" "</span>+dogC1.age+<span class="string">" "</span>+dogC2.name+<span class="string">" "</span>+dogC2.age);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You will notice that the two numbers are independent as one changes the other does not get the modification.On the other hand, when assigning a class to another one, the modification to one affects also the other.</p>
<p>This is because when doing dogC2 = dogC1; we assign the address of dogC1 to dogC2 reference variable. The original address of the dogC2 data is lost in memory and altering dogC1 or dogC2 is the same. We now have two references to the same data location.</p>
<p><img src="../_images/unity/Diapositive4-231x300.png" alt="Class reference"></p>
<h2 id="Lifetime-Scope-and-Garbage-Collection"><a href="#Lifetime-Scope-and-Garbage-Collection" class="headerlink" title="Lifetime, Scope and Garbage Collection"></a>Lifetime, Scope and Garbage Collection</h2><p>In the case of a reference type variable, the lifetime is unclear as it is the job of the garbage collector. Back in the old days of C and C++, it was the duty of the programmer to make sure dynamically allocated variables are removed from memory (the free() function in C, the ~ in C++).</p>
<p>In C#, the garbage collector will check if the variables are still used, if no reference to it is found from executable code, it will mark the memory locations as free to use.  Programmers familiar with COM interfaces or other reference counting systems often find garbage collection a strange concept – because in reference counting systems having two objects refer to each other (like a parent having a reference to its children and those children having a reference to their parent) can cause memory to never be freed – garbage collection has no such limitation.</p>
<p>Garbage Collection is a big subject and Unity has a number of oddities when it comes to the implementation of the collection process – if you are used to traditional C# then you will basically expect that GC should be cheap for small short lived objects, but it is not in Unity.Every time a block of memory fills up the system needs to check for the reachability of all objects allocated on the heap – this means a check for whether they can be accessed from any code that is or could be running – if they can be then the object is retained otherwise it is released.  Normal .NET Garbage Collections happen in a thing called generations which seek to minimise the amount of work associated with reachability testing by trying newly created objects first and only continuing to older objects if there still isn’t enough memory available.  It appears that Unity always tests all objects and so Garbage Collection is a major overhead, far greater than would normally be expected in a .NET language.</p>
<p>Reachability testing is the magic behind Garbage Collection – it enables the collector to determine if any code that is currently running or that could be running, because there is a live reference to it, has a reference to the object which is a candidate for collection.  This includes the use of closures inside functions – it’s very complicated and very powerful, but it isn’t fast in the way games need things to be fast.<br>A closure is created by referring to some local variable or parameter inside an anonymous function defined inside a function.  The value of the variable is kept so that when the anonymous function is called the variable is the same as when the routine executed.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">List&lt;Action&gt; actionsToPerformLater = <span class="keyword">new</span> List&lt;Action&gt;();</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">DisplayAMessage</span>(<span class="params"><span class="keyword">string</span> message</span>)</span></div><div class="line">&#123;</div><div class="line">      <span class="keyword">var</span> t = System.DateTime.Now;</div><div class="line">      actionsToPerformLater.Add(()=&gt;&#123;</div><div class="line">          Debug.Log(message + <span class="string">" @ "</span> + t.ToString());</div><div class="line">      &#125;);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">SomeOtherFunction</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">      DisplayAMessage(<span class="string">"Hello"</span>);</div><div class="line">      DisplayAMessage(<span class="string">"World"</span>);</div><div class="line">      SomeFunctionThatTakesAWhile();</div><div class="line">      DisplayAMessage(<span class="string">"From Unity Gems"</span>);</div><div class="line"> </div><div class="line">      <span class="keyword">foreach</span>(<span class="keyword">var</span> a <span class="keyword">in</span> actionsToPerformLater)</div><div class="line">      &#123;</div><div class="line">           a();</div><div class="line">      &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In this code each time we call the DisplayAMessage function we form a closure over the message passed in and the current system time.  When we run the foreach loop at the end, the debug messages are logged with the value of the parameter passed at the time we called the earlier function to add it to the list.  Closures are a very powerful tool and will be the subject of a future article.</p>
<p>Garbage Collection happens when the system thinks that there isn’t enough memory available for some operation, this means that an object that has been discarded may not be collected for a considerable period of time – it is therefore common practice to explicitly close external connections or otherwise release external resources when an object is no longer required.There is no need to explicitly release internal objects (classes in your project), but there is a reason when using things outside your project including Streams (files) and database connections that might be having some impact on the system.  For example not closing a file may make a subsequent action that access that file fail because the file is still open by a discarded object.</p>
<p>Garbage Collection is an expensive operation and so it makes sense to manually trigger it when it won’t make any difference to game play – such as between level loads, when the player enters a pause menu or at other times that it is likely to be unnoticed by the player.  You can manually trigger Garbage Collection using System.GC.Collect();<br>Concerning the scope of a reference type variable, it can be accessed anywhere in the program providing we perform the appropriate action to find it, using GameObject.Find() for instance will return a reference to the object in any scripts.<br>See our GetComponent tutorial for more details on finding instances of classes during game play.</p>
<h2 id="Struct-vs-Class"><a href="#Struct-vs-Class" class="headerlink" title="Struct vs Class"></a>Struct vs Class</h2><p>So which one to use in what situations? We found out that using a class adds an overhead variable. If we were to create a thousand objects we get a thousand overhead variables when our structure would not generate them.</p>
<p>Now see this example:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DogC</span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">struct</span> DogS &#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> name;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Memory</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line">    DogC dogC = <span class="keyword">new</span> DogC();</div><div class="line">    DogS dogS = <span class="keyword">new</span> DogS();</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KeyCode.Alpha1))</div><div class="line">            Print (dogS);</div><div class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KeyCode.Alpha2))</div><div class="line">            Print (dogC);</div><div class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KeyCode.Alpha3))</div><div class="line">            print (<span class="string">"Struct: The dog's name is "</span>+dogS.name +<span class="string">" and is "</span>+dogS.age);</div><div class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KeyCode.Alpha4))</div><div class="line">            print (<span class="string">"Class: The dog's name is "</span>+dogC.name +<span class="string">" and is "</span>+dogC.age);</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Print</span>(<span class="params">DogS d</span>)</span>&#123;</div><div class="line">        d.age = <span class="number">10</span>;</div><div class="line">        d.name = <span class="string">"Rufus"</span>;</div><div class="line">        print (<span class="string">"Struct:The dog's name is "</span>+d.name +<span class="string">" and is "</span>+d.age);</div><div class="line">     &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Print</span>(<span class="params">DogC d</span>)</span>&#123;</div><div class="line">        d.age = <span class="number">10</span>;</div><div class="line">        d.name = <span class="string">"Rufus"</span>;</div><div class="line">        print (<span class="string">"Class:The dog's name is "</span>+d.name +<span class="string">" and is "</span>+d.age);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>First off, you will notice that the third input does not print out what is expected, the name and age of the structure dog have gone. On the other hand, the class retains its values.</p>
<p>Remember what we said, a structure is a value type when a class is a reference type. When calling the function for the structure, we pass a copy of the structure but the copy is not the original data. When modifying the data, we are just modifying the copies on the stack. Those are lost at the end of the function.</p>
<p>The class is passed using a reference which can access the original data and modify them within the function, those modifications remains even when the function is over.</p>
<p>What should that make us think of? If my structure is really large with for instance 10 variables, when passing it to the function the stack grows of 10 locations. Now if I pass an array of structures with 50 of them, the stack is now 500 locations larger, the stack is limited is size and a stack overflow could happen if the structure and array are even larger.</p>
<p>When passing the reference of my class, I only pass one variable. Passing 50 instances of the class will grow my stack of 50 variables only.<br><img src="../_images/unity/Diapositive6-300x136.png" alt="Struct vs Class"></p>
<p>So, classes save memory but structures are faster, totally. So the point is to figure out a balance between the two. Consider using structures when you have less than for instance 5 to 8 variables. Above that, use a class.</p>
<p>You must also bear in mind that every time you access a variable which is a structure (for example by doing transform.position) you are creating a copy of that structure on the stack – that copy takes time to create.</p>
<p>Every time you create a class you are allocating memory on the heap which will quickly lead to a Garbage Collection cycle for discarded values – structures are always allocated on the stack and hence will never cause Garbage Collection.</p>
<p>You will notice that in Unity structures are often used for 3 to 4 variables like position, color, quaternion, rotation, scale,…, all of those are structures.</p>
<p>Short lived, frequently allocated objects are good candidates for structs because they do not cause Garbage Collection.  Long lived, large objects are good candidates for classes because they will not be copied each time that they are accessed and their continued existence will not cause the need for Garbage Collection.  You will see that lots of small objects like Vector3 and RaycastHit are structs in Unity for this very reason.<br>One last point before we move on, we kept for the end the cherry on top. It is possible to pass a structure as reference so that we can modify our structure and retain the value.</p>
<p>You cannot maintain a reference to a structure after the function which originally defined the variable has exited, there are lots of ways for this to cause a problem such as the use of closures (formed by lambda functions or inline functions) but they are quite advanced techniques.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintRef</span>(<span class="params"><span class="keyword">ref</span> DogS d</span>)</span>&#123;</div><div class="line">    d.age = <span class="number">10</span>;</div><div class="line">    d.name = <span class="string">"Rufus"</span>;</div><div class="line">    print (<span class="string">"Structure:The dog's name is "</span>+d.name +<span class="string">" and is "</span>+d.age);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>we call it like this:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    PrintRef(<span class="keyword">ref</span> dogS);</div><div class="line">    Debug.Log (<span class="string">"Structure:The dog's name is "</span>+dogS.name +<span class="string">" and is "</span>+dogS.age);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You have noticed the keyword ref, this is telling the compiler to create a reference to the structure instead of copying it onto the stack. Outside the function, the structure has kept the values given inside of it. This keyword can be used with any value type.</p>
<h2 id="Creating-a-Reference"><a href="#Creating-a-Reference" class="headerlink" title="Creating a Reference"></a>Creating a Reference</h2><p>So we just saw that it is possible to create a reference to a value type variable. Consider we want to create an integer inside a function but we want to keep for later use. Simply declaring inside the function will create an automatic variable that is lost on completion of the function.</p>
<p>We can create a dynamically allocated variable that will be stored in the heap with a reference in our script.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test</span>:<span class="title">MonoBehaviour</span>&#123;</div><div class="line">    <span class="keyword">int</span> number;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span>(Input.GetKeyDown (KeyCode.C))</div><div class="line">            CreateVariable();</div><div class="line">        <span class="keyword">if</span>(Input.GetKeyDown (KeyCode.Space))</div><div class="line">            PrintVariable(number);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">CreateVariable</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="comment">//int number = new int();</span></div><div class="line">        number = <span class="keyword">new</span> <span class="keyword">int</span>();</div><div class="line">        number = <span class="number">10</span>;</div><div class="line">        Debug.Log (<span class="string">"In function "</span>+number);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">PrintVariable</span>(<span class="params"><span class="keyword">int</span> n</span>)</span>&#123;</div><div class="line">        Debug.Log (n);</div><div class="line">        n+=<span class="number">10</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>First we declare a variable number of type int that is global to our script. We use that variable inside CreateVariable and assign to it an integer variable reference using new int();</p>
<p><img src="../_images/unity/Heap-300x138.png" alt="Reference for automatic"></p>
<p>To clarify this situation, the new keyword returns a reference to the variable that is created in the heap section. This reference is stored inside number which now holds the address of the newly created variable. Using number is indirectly using this variable.Our newly created variable still exists outside the function.<br>Consider the commented part, if we had down it this way, we would have lost our reference at the end of the function. On its next cleaning round, the garbage collector would have found our data with no reference and remove it from memory. Consider that when declaring a local variable like we would have done here inside the function, int number; would have hidden the global int number.</p>
<p>When you hold a primitive variable, like an int, inside a reference the compiler performs a function called boxing basically wrapping the primitive variable inside a class.  Variables declared in this fashion are allocated on the heap and cause Garbage Collection to occur when they are released, they also take more memory than the default primitive value.<br>Let’s consider a basic boxing situation. When using the function Debug.Log(object);, the parameter is an object meaning that any type of variable can be passed to the function. But when passing an integer, the compiler will box the integer into an object. It is then possible to optimize the boxing by anticipating it like so:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintingManyTimes</span>(<span class="params"><span class="keyword">int</span> n</span>)</span>&#123;</div><div class="line">    <span class="keyword">object</span> obj = n;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">500</span>;i++)</div><div class="line">        Debug.Log(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This way the compiler does not need perform the boxing on each call of Debug.Log. It is done once and for all 500 calls.</p>
<h2 id="Static"><a href="#Static" class="headerlink" title="Static"></a>Static</h2><p>We are getting now to the last part of our tutorial. Again, if you have a C background, forget what you know about static as the use here is different.</p>
<p>A static variable in .NET is stored in a special part of the heap called the High Frequency Heap.</p>
<p>As we mentioned earlier, we often meet static variables in tutorials and beginners just praise the ease of use. The gentle tutor often does not take the time to fully explain the benefits and danger of static variables. We are about to try to clarify what is a static object, how to use, where to use it and not.</p>
<h2 id="Static-classes"><a href="#Static-classes" class="headerlink" title="Static classes"></a>Static classes</h2><p>A static class is a class that does not have any object instantiation, you cannot create an object of a static class.</p>
<p>As a result, there is only one instantiation. You might be confused as I just said there cannot be any instance of it. The program will allocate memory in the heap for this object and will not allow any user instantiation.</p>
<p>Static objects are created on their first call and will be destroyed on completion of the program (or its crash…).</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">GameManager</span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> score;  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> amountOfTime;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You will not be able to declare an object of type GameManager.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GameManager GM = <span class="keyword">new</span> GameManager();</div></pre></td></tr></table></figure>
<p>will return an error.</p>
<p>You will be able to access the members of the static class simply using</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GameManager.score = <span class="number">10</span>;</div></pre></td></tr></table></figure>
<p>This can be done anywhere and anytime in the game. A static class or member has scope in every file and lifetime of the whole program.</p>
<h3 id="An-example-for-using-static-class"><a href="#An-example-for-using-static-class" class="headerlink" title="An example for using static class"></a>An example for using static class</h3><p>When loading a new scene, all variables from the previous scene are destroyed. If we want to preserve one variable like the score for instance we need</p>
<p><code>DontDestroyOnLoad(score);</code></p>
<p>One great use for static class lies in their lifetime. Since they do not die, if we want our score to survive the load of a scene we can simply use a static class. At the end of our level we pass the value to the static member, starting our new scene we retrieve that value.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(newLevel)&#123;</div><div class="line">    GameManager.score = tempScore;</div><div class="line">    Application.LoadLevel(nextLevel);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>And in script of the new level:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    scoreTemp = gameManager.score;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>A little trick for this use, do not use GameManager.score until the end.</p>
<p>Think of a game with 10 levels where you get 200pts maximum per level.</p>
<p>One player finishes the game in one run and gets 2000pts.</p>
<p>Another player finishes the game in many run and gets 5000pts.</p>
<p>The second player is not as good but gets more points because he was trying each level many times and accumulating the points. If we wait for the loading of the next level to pass the point to the static variable, retrying should cancel the accumulated points during the level.</p>
<p>While leaving the game, the data from the static class can be sent to a save.</p>
<p>Static classes and static variables are allocated when they are first encountered during the programs execution.  A static class is never created unless you actually access one of its variables or methods.</p>
<h2 id="Static-Variables"><a href="#Static-Variables" class="headerlink" title="Static Variables"></a>Static Variables</h2><p>Many beginners make this simple mistake:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> health;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    health=<span class="number">100</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>in another script we might find:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnCollisionEnter</span>(<span class="params">Collision other</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span> (other.gameObject.tag == “Enemy”)&#123;</div><div class="line">        EnemyScript.health-=<span class="number">10</span>;</div><div class="line">        <span class="keyword">if</span>(EnemyScript.health &lt;= <span class="number">0</span>)Destroy(other);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>They try the game with one enemy and succeed to kill him. But then they add more enemies and wonder why everyone dies suddenly.</p>
<p>The reason is simple, you have many instances of the enemy class (which is not static) but you have only one instance of the health for all instances. Killing one kill them all!</p>
<p>In fact, a static variable declared in a class does not belong to the objects but to the class itself. That is why we access it using the class name and not the instance name.</p>
<p>It did not work for the enemy health because each enemy needs to have its own health variable.</p>
<p>A static variable in the same way as the static class is instantiated when the class that defines it is first accessed. That means even though there would not be any instance of the class in the game, the variable would exist if you tried to access it.</p>
<p>Consider an enemy counter, we want to keep track of the amount of enemies we have in the game.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">var</span> counter;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateEnemy</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    GameObject obj=Instantiate(enemyPrefab, <span class="keyword">new</span> Vector3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>).Quaternion.identity);</div><div class="line"> </div><div class="line">    <span class="keyword">if</span>(obj)counter++;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DestroyEnemy</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    Destroy(gameObject);</div><div class="line">    counter--;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This script is attached to each enemy. They all share the same counter variable even though they all have a different script.</p>
<p>Using this function in our game allows us keeping track of our enemy count. Note the use of a reference variable, in the case Instantiate would not succeed creating the object (heap fragmentation for example), Instantiate returns a null reference. If we were simply to increase our counter without checking, if for some reason an instantiation fails, we have a wrong counter. Now if we use that counter to end up our level and launch a new one as such:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(counter &lt;= <span class="number">0</span>)Application.LoadLevel(nextLevel);</div></pre></td></tr></table></figure>
<p>Without the check, if we had a fail, after killing all enemies we have a counter of 1, our game has a bug.</p>
<p>What about our player, can I use static health? Yes, you can use a static variable for the player’s health. Actually, accessing a static variable is even more efficient than an instance member.</p>
<p>When calling the member of an instance, the compiler needs to call a tiny function that checks for the existence of the object. That makes sense since you should not be able to modify a data that does not exist.</p>
<h3 id="Static-Functions"><a href="#Static-Functions" class="headerlink" title="Static Functions"></a>Static Functions</h3><p>A static function can be implemented in a non static class, in this case only the static member of that class can be accessed inside the function. This is logical since the static function is called via the class and not an instance, it would be problematic to try accessing members that are not sure to be existing.</p>
<p>On the other hand it is possible to pass parameters and you probably have been using this type of function quite a lot.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Vector3.Distance(vec1.vec2);</div><div class="line">vec1.Normalize();</div><div class="line"> </div><div class="line">Application.LoadLevel (<span class="number">1</span>);</div><div class="line"> </div><div class="line"><span class="keyword">if</span> (GUI.Button(Rect(<span class="number">10</span>,<span class="number">10</span>,<span class="number">50</span>,<span class="number">50</span>),btnTexture))&#123;&#125;</div></pre></td></tr></table></figure>
<p>The list could go on and on. Note the second example is not a static method. It is called through the instance vec1 of type Vector3. The other examples show that the class is used to call the static function.</p>
<p>Static function tends to be faster than non-static since the compiler since a call of an instance function creates a tiny overhead to check if the instance exist, a static function uses a class which is guarantee to exist . Though this gain of time is small.</p>
<p>Another benefit of static classes is that their existence is permanent and known to the compiler hence they can be used, in C#, to define extension methods – these are methods that appear to be additional functions added to any other type of variable.  This is syntactic sugar, the classes extended in this fashion are not actually opened (their private and protected variables are not available to extension methods), but it can be a neat way to apparently give new functions to existing objects which often lead to greater code legibility and an easier API for developers.  For example you could apparently add a new function to Transformtransform.MyWeirdNewFunction(x);</p>
<h2 id="Example-of-extension-function"><a href="#Example-of-extension-function" class="headerlink" title="Example of extension function:"></a>Example of extension function:</h2><p>Let’s consider I want to create a function for arrays that will extend the existing ones (OrderBy,Sort,…), I can declare a static function that will extend the list.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ExtensionTest</span> &#123;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">BiggestOfAll</span>(<span class="params"><span class="keyword">this</span> <span class="keyword">int</span>[] integer</span>)</span>&#123;</div><div class="line">        <span class="keyword">int</span> length = integer.Length;</div><div class="line">        <span class="keyword">int</span> biggest = integer[<span class="number">0</span>];</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt; length;i++)&#123;</div><div class="line">            <span class="keyword">if</span>(integer[i] &gt; biggest)biggest = integer[i];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> biggest;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We declare a static function,see how the parameter passed is the instance calling the function. Modifying the type of the parameter will allow working on other objects.</p>
<p>Now declare and fill up an array:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] array = &#123;<span class="number">1</span>,<span class="number">25</span>,<span class="number">12</span>,<span class="number">120</span>,<span class="number">12</span>,<span class="number">6</span>&#125;;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        print(array.BiggestOfAll()); </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>As you type the dot after your array name, you will see your new function showing up.</p>
<p>Should you decide to create a more generic function that accept any array regardless its type, you would implement a static generic extension method.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ExtensionTest</span> &#123;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T TypelessBiggestOfAll&lt;T&gt;(<span class="keyword">this</span> T[] t)&#123;</div><div class="line">        <span class="keyword">int</span> length = t.Length;</div><div class="line">        <span class="keyword">var</span> biggest = t[<span class="number">0</span>];</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt; length;i++)&#123;</div><div class="line">            biggest =((Comparer&lt;T&gt;.Default.Compare(t[i], biggest) &gt; <span class="number">0</span>)?t[i]:biggest);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> biggest;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Note the addition of using System.Collections.Generic; . As the compiler do not know what the type of T is, we cannot simply compare the values with &lt; or &gt;. But we can use  Comparer<t> . In the example, the ternary operator is used. It tends to make coding a little confusing at first but it also save a few lines.</t></p>
<p>The ternary operator looks like:       a ? b : c;a is performed and if true b is sent out of the command, if false c is sent. The advantage compared to a regular if-statement lies in the value returned from the comparison.        result = a ? b : c;           result will receive the value b or c depending on a</p>
<p>It is now possible to declare different type of arrays and use the same function.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] arrayInt = &#123;<span class="number">1</span>, <span class="number">25</span>, <span class="number">12</span>, <span class="number">120</span>, <span class="number">12</span>, <span class="number">6</span>&#125;;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span>[] arrayFl = &#123;<span class="number">0.5</span>f, <span class="number">52.456</span>f, <span class="number">654.25</span>f, <span class="number">41.2</span>f&#125;;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">double</span>[]arrayDb = &#123;<span class="number">0.1254</span>, <span class="number">-15487.258</span>, <span class="number">654</span>, <span class="number">8795.25</span>, <span class="number">-2</span>&#125;;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span> (<span class="params"></span>) </span>&#123;</div><div class="line">         print(arrayInt.TypelessBiggestOfAll());</div><div class="line">         print (arrayFl.TypelessBiggestOfAll());    </div><div class="line">         print (arrayDb.TypelessBiggestOfAll());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This will print out the values  120, 654.25, 8795.25 .</p>
<p>Now I want to show you where this can get useful. Many Unity users ask about how to constraint an object inside an area. For instance should you want to keep an object inside the screen you can clamp the Transform of that object using this function:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">GameManager</span>&#123;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ClampTransform</span>(<span class="params"><span class="keyword">this</span> Transform tr,Vector3 move, Vector3 min, Vector3 max</span>)</span>&#123;</div><div class="line">        Vector3 pos = tr.position + move;</div><div class="line">        <span class="keyword">if</span>(pos.x &lt; min.x ) pos.x = min.x;</div><div class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">pos.x &gt; max.x</span>) pos.x </span>= max.x;</div><div class="line"> </div><div class="line">        <span class="keyword">if</span>(pos.y  &lt; min.y ) pos.y = min.y;</div><div class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">pos.y &gt; max.y</span>) pos.y </span>= max.y;</div><div class="line"> </div><div class="line">        <span class="keyword">if</span>(pos.z &lt; min.z) pos.z = min.z;</div><div class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">pos.z &gt; max.z</span>) pos.z </span>= max.z;</div><div class="line"> </div><div class="line">        tr.position = pos;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>And you use it this way anywhere you need it:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Vector3 minVector = <span class="keyword">new</span> Vector3(<span class="number">-10</span>,<span class="number">0</span>,<span class="number">-10</span>);</div><div class="line">Vector3 maxVector = <span class="keyword">new</span> Vector3(<span class="number">10</span>,<span class="number">0</span>,<span class="number">10</span>);</div><div class="line">transform.ClampTransform(move,minVector,maxVector);</div></pre></td></tr></table></figure>
<p>In this example, the object is constraint in a 2D (y remains at 0) environment in a square of 20*20  centered at (0,0,0).</p>
<h2 id="Heap-Fragmentation-Garbage-Collection-and-Object-Pooling"><a href="#Heap-Fragmentation-Garbage-Collection-and-Object-Pooling" class="headerlink" title="Heap Fragmentation, Garbage Collection and Object Pooling"></a>Heap Fragmentation, Garbage Collection and Object Pooling</h2><p>The heap is a large zone of memory where data are randomly stored. Actually it is not so random, the OS will look into the memory and search for the first memory zone large enough to fit the required data.  The size and location of the heap varies depending on the player platform you have selected.</p>
<p>For instance, when we ask for an integer, the OS looks for 4 consecutive bytes of free memory. Fact is, as the program runs, memory locations get used and freed without real logic and your program might end up with a heap fragmentation.</p>
<p><img src="../_images/unity/Diapositive5-300x149.png" alt="Heap fragmentation"></p>
<p>The picture  shows an example of heap fragmentation, obviously this one is drastically emphasizes but the idea remains.You might notice that we are trying to allocate a data3 but on state1 we had a data3 that was destroyed on state2.<br>Note that no data have been added, there are at the end the same amount of data than at state1. Only the movements have created a heap fragmentation.</p>
<p>Unity uses .NET managed memory.  In a C program heap fragmentation could create a circumstance where it was impossible to allocate a block of memory because no contiguous block could be found of a suitable size, even though there was actually enough memory free – managed memory does not suffer from this limitation.  If a block of memory cannot be found the real .NET memory management and Garbage Collection systems can be used to remove the fragmentation of the heap by moving items around.  This doesn’t happen in Unity due to the implementation of the Garbage Collector.  It is more likely that you will find space as more than one object can be cleared at once, but this isn’t as effective as moving around blocks until they fit.<br>A solution to the programmer can use consist of Object pooling. What if instead of destroying our data3 in state1 we simply deactivate it for later use. That would have avoided our heap fragmentation.</p>
<p>We do not destroy data, we keep it sleeping and when needed, we wake it up.</p>
<p>There are many advantages for this solution, first we avoid the case seen above, second we also avoid calling Instantiate and Destroy functions, we only need to use gameObject.SetActiveRecursevely(true/false);</p>
<p>Finally, since we do not destroy, we do not call the garbage collector which is quite an expensive action.</p>
<p>ObjectScript.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line">    <span class="keyword">public</span> GameObject prefab;</div><div class="line">    GameObject[] objectArray = <span class="keyword">new</span> GameObject[<span class="number">5</span>];  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> counter; </div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; objectArray.Length;i++)&#123;</div><div class="line">            objectArray[i] = (GameObject)Instantiate(prefab,<span class="keyword">new</span> Vector3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),Quaternion.identity);</div><div class="line">            objectArray[i].SetActiveRecursively(<span class="literal">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Createobject</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">if</span>(counter &lt; objectArray.Length)&#123;    </div><div class="line">        <span class="comment">// iterate through array</span></div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; objectArray.Length;i++)&#123;  </div><div class="line">                 <span class="comment">// Find an inactive object                                     </span></div><div class="line">                 <span class="keyword">if</span>(!objectArray[i].active)&#123;    </div><div class="line">                     <span class="comment">// Increase the counter, activate the object, position it                                              </span></div><div class="line">                     counter++;                                             </div><div class="line">                     objectArray[i].SetActiveRecursively(<span class="literal">true</span>);            </div><div class="line">                     objectArray[i].transform.position = <span class="keyword">new</span> Vector3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);  </div><div class="line">                     <span class="keyword">return</span>;</div><div class="line">                 &#125;</div><div class="line">             &#125;</div><div class="line">             <span class="keyword">return</span>;</div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnCollisionEnter</span>(<span class="params">CollisionEnter</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(other.gameObject.tag==<span class="string">"Object"</span>)&#123;</div><div class="line">        other.gameobject.SetActiveRecursively(<span class="literal">false</span>);       <span class="comment">//Deactivate the object</span></div><div class="line">        ObjectScript.counter--;                                             <span class="comment">//Decrease counter</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The scene never have more than 5 objects at the same time, when one is deactivated it can be reactivated anywhere we want it. No garbage collection is needed.</p>
<p>You can use this trick for your enemies, if you have a wave of enemies coming at you, instead of destroying a killed enemy, reposition him on the back, you are about to kill the same guy many time without noticing it.</p>
<p>Same for your ammunition, instead of destroying each bullet you or the other NPC are shooting, disable them. Enable them back when you shoot again with position in front of your gun and proper velocity.</p>
<p>Note that pooling at the memory level is a different process managed by the OS consisting in reserving always the same amount  of memory whatever size the object is. As a result there will never be tiny memory locations lost all over the memory.</p>
<h2 id="Array-Reuse"><a href="#Array-Reuse" class="headerlink" title="Array Reuse"></a>Array Reuse</h2><p>In addition to reusing objects it is also worth considering creating buffers that are reused by your code between different calls or repeatedly in the same call.  This is because an array or List is allocated on the heap and creating one every Update or in some other frequent circumstance can quickly lead to Garbage Collection cycles.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">      <span class="keyword">if</span>(readyToFire &amp;&amp; Input.GetKeyDown(KeyCode.F))</div><div class="line">      &#123;</div><div class="line">          <span class="keyword">var</span> nearestFiveEnemies = <span class="keyword">new</span> Enemy[<span class="number">5</span>];</div><div class="line"> </div><div class="line">          <span class="comment">//Do something to fill out the list finding the nearest</span></div><div class="line">          <span class="comment">//enemies</span></div><div class="line"> </div><div class="line">          TargetEnemies(nearestFiveEnemies);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In this example we are targeting the nearest 5 enemies and firing some automatic weapon at them.  The problem is that we are allocating memory every time we press the fire button.  If instead we made a long-lived array of enemies we could use anywhere in our code, then we would not allocate memory and hence avoid the slow down.</p>
<p>This would be the simple case:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Enemy[] _nearestFiveEnemies = <span class="keyword">new</span> Enemy[<span class="number">5</span>];</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">      <span class="keyword">if</span>(readyToFire &amp;&amp; Input.GetKeyDown(KeyCode.F))</div><div class="line">      &#123;</div><div class="line">          <span class="comment">//Do something to fill out the list finding the nearest</span></div><div class="line">          <span class="comment">//enemies</span></div><div class="line"> </div><div class="line">          TargetEnemies(_nearestFiveEnemies);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>But perhaps we could make it even more general if we often needed arrays of enemies:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Enemy[] _enemies = <span class="keyword">new</span> Enemy[<span class="number">100</span>];</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">      <span class="keyword">if</span>(readyToFire &amp;&amp; Input.GetKeyDown(KeyCode.F))</div><div class="line">      &#123;</div><div class="line">          <span class="comment">//Do something to fill out the list finding the nearest</span></div><div class="line">          <span class="comment">//enemies</span></div><div class="line"> </div><div class="line">          TargetEnemies(_enemies, <span class="number">5</span>);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>By rewriting our code for TargetEnemies to take the count we can effectively use a general purpose buffer of enemies anywhere in our code and avoid further need for allocations.</p>
<p>The second example here is a pretty extreme case, and you should only do this if you really have huge collections that might cause a memory issue – in general you should always write readable, comprehensible code in favour of saving a few bytes of memory.</p>
<h2 id="原文链接"><a href="#原文链接" class="headerlink" title="原文链接"></a>原文链接</h2><ul>
<li><a href="https://unitygem.wordpress.com/memory-management/" target="_blank" rel="external">Memory Management</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tospan.me/2017/02/07/Unity-Scripting-Memory-Management/" data-id="ciyvdy4da003b9qvwnggzehbg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/default/">default</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/02/07/Unity-Scripting-Coroutine/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Unity Scripting Coroutine
        
      </div>
    </a>
  
  
    <a href="/2017/02/07/Unity-Scripting-GetComponent/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Unity Scripting GetComponent</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorier</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unity/">Unity</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/default/">default</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Basics/">Basics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Games/">Games</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Geometry/">Geometry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linear-Algebra/">Linear Algebra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Numerical-Analysis/">Numerical Analysis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/default/">default</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Basics/" style="font-size: 14px;">Basics</a> <a href="/tags/C/" style="font-size: 12px;">C#</a> <a href="/tags/Games/" style="font-size: 10px;">Games</a> <a href="/tags/Geometry/" style="font-size: 12px;">Geometry</a> <a href="/tags/Linear-Algebra/" style="font-size: 16px;">Linear Algebra</a> <a href="/tags/Math/" style="font-size: 18px;">Math</a> <a href="/tags/Numerical-Analysis/" style="font-size: 10px;">Numerical Analysis</a> <a href="/tags/Unity/" style="font-size: 20px;">Unity</a> <a href="/tags/default/" style="font-size: 16px;">default</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Arkiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Siste innlegg</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/07/Unity-FSM/">Unity FSM</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Object-Pools-2/">Unity Object Pools 2</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Scripting-Coroutine-Delay/">Unity Scripting Coroutine Delay</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Scripting-Coroutine/">Unity Scripting Coroutine</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Scripting-Memory-Management/">Unity Scripting Memory Management</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 To Span<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>