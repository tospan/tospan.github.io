<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Everything about interpolation in Unity with C# | 吐司片的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="IntroductionAccording to Wikipedia, interpolation is a method of constructing new data points within the range of a discrete set of known data points. The easiest form of interpolation is linear inter">
<meta property="og:type" content="article">
<meta property="og:title" content="Everything about interpolation in Unity with C#">
<meta property="og:url" content="http://tospan.me/2017/02/05/Interpolation-in-Unity/index.html">
<meta property="og:site_name" content="吐司片的博客">
<meta property="og:description" content="IntroductionAccording to Wikipedia, interpolation is a method of constructing new data points within the range of a discrete set of known data points. The easiest form of interpolation is linear inter">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/bezier-curve-traffic-intersection.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/catmull-rom-splines-mafia.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/nSwZgKo.gif">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/bezier-curve-explanation.png">
<meta property="og:image" content="http://tospan.me/../images/unity/bezier-curve.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/line-segments.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/integral-curve-length.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/equation-to-find-t.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/bezier-curve-constant-steps.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/bezier-curve-constant-steps.png">
<meta property="og:updated_time" content="2017-02-05T05:23:08.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Everything about interpolation in Unity with C#">
<meta name="twitter:description" content="IntroductionAccording to Wikipedia, interpolation is a method of constructing new data points within the range of a discrete set of known data points. The easiest form of interpolation is linear inter">
<meta name="twitter:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/bezier-curve-traffic-intersection.png">
  
    <link rel="alternate" href="/atom.xml" title="吐司片的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">吐司片的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Work hard, play hard.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://tospan.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Interpolation-in-Unity" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/05/Interpolation-in-Unity/" class="article-date">
  <time datetime="2017-02-05T05:23:08.000Z" itemprop="datePublished">2017-02-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Unity/">Unity</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Everything about interpolation in Unity with C#
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>According to <a href="https://en.wikipedia.org/wiki/Interpolation" target="_blank" rel="external">Wikipedia</a>, interpolation is a method of constructing new data points within the range of a discrete set of known data points. The easiest form of interpolation is linear interpolation, where you follow a straight line from A to B (the known data points).</p>
<a id="more"></a>
<p>When interpolating you are using a parameter called t, which is defined as 0 when you are at the start position and 1 if you are at the end position. So to interpolate linearly from A to B we get the following function: f(t) = (1 - t) <em> A + t </em> B. If you insert t = 0, you get f(0) = A, which is the start position. Unity has this function built-in, so if you write Vector3.Lerp(A, B, t), it’s the same as writing (1 - t) <em> A + t </em> B.</p>
<p>But following straight lines are kinda boring - it’s more fun to follow curves. The curves are here called <a href="https://en.wikipedia.org/wiki/Spline_(mathematics" target="_blank" rel="external">splines</a>), which is “a numeric function that is piecewise-defined by polynomial functions, and which possesses a high degree of smoothness at the places where the polynomial pieces connect.” The most common splines are quadratic, with one control point, and cubic, with two control points. These control points are determining the shape of the spline.</p>
<p>A <a href="https://en.wikipedia.org/wiki/Cubic_Hermite_spline" target="_blank" rel="external">Cubic Hermite spline</a> is a cubic polynomial spline. One example of these is the Catmull-Rom spline. But these can also be specified in other ways, where the <a href="https://en.wikipedia.org/wiki/B%C3%A9zier_curve" target="_blank" rel="external">Bézier</a> form being the most common. However, these two methods provide the same set of splines, and data can be easily converted between the Bézier and Hermite forms, so the names are often used as if they were synonymous.</p>
<p>This tutorial is divided into the following sections:</p>
<ol>
<li><a href="http://www.habrador.com/tutorials/interpolation/1-catmull-rom-splines/" target="_blank" rel="external">Generate a Catmull-Rom spline</a>. Use these if you want to control the shape of the curve by moving the points that make up the curve.</li>
<li><a href="http://www.habrador.com/tutorials/interpolation/2-bezier-curve/" target="_blank" rel="external">Generate a Bezier Curve</a>. Use these if you want to control the shape of the curve even though the points that make up the curve are fixed.</li>
<li><a href="http://www.habrador.com/tutorials/interpolation/3-move-along-curve/" target="_blank" rel="external">Move along a Bezier curve</a>. Learn how to move along a Bezier curve with constant steps by first finding the length of the curve.<br>…and when you are done you will be able to guide your self-driving cars through a traffic intersection:</li>
</ol>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/bezier-curve-traffic-intersection.png" alt="Several Bezier curves in a traffic intersection"></p>
<h2 id="1-Generate-a-Catmull-Rom-spline"><a href="#1-Generate-a-Catmull-Rom-spline" class="headerlink" title="1.Generate a Catmull-Rom spline"></a>1.Generate a Catmull-Rom spline</h2><p>Here you will create your very own Catmull-Rom spline in Unity. The name orignates from the creators of the spline: Edwin Catmull, co-founder of Pixar, and Raphael Rom. So the Catmull-Rom splines are often used in 3D animations. But the splines are also very popular to use in computer games. For example, the game Mafia uses Catmull-Rom splines to connect waypoints.</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/catmull-rom-splines-mafia.png" alt="Catmull-Rom splines in the game mafia"><br>Catmull-Rom splines in Mafia. <a href="http://www.gdcvault.com/play/1013728/Living-City-in-Mafia" target="_blank" rel="external">Source</a></p>
<p>In this tutorial we will focus on the very basics. We will create a smooth path between a series of spheres. And if we want to create a connected path so it can form a loop, we will also be able to do that. This is the beauty of the Catmull-Rom spline: if you have a series of points and want to generate a smooth curve along these points, it’s possible. The reason is that the curve will use all points to form the curve (except the first and last point if you are not making a loop). Compare this with the Bezier curve, which will need extra control points which are not a part of the spline itself.</p>
<p>What’s the basic idea behind the Catmull-Rom spline?. The answer is a <a href="http://mathworld.wolfram.com/CubicPolynomial.html" target="_blank" rel="external">cubic polynomial</a>, which looks like this: f(t) = a_3 <em> t^3 + a_2 </em> t^2 + a_1 * t + a_0. It’s your job to determine the coefficients a. To help, you can use <a href="http://www.iquilezles.org/www/articles/minispline/minispline.htm" target="_blank" rel="external">this link</a>.</p>
<p>If you have 4 points called p0, p1, p2, and p3, you will be able to add a smooth path between the 2 middle points p1 and p2 (if the curve is not forming a loop). The middle points are called the curve´s <strong>endpoints</strong>. We need the first and last point (p0 and p3) to define the curve’s <strong>control points</strong> that control the shape of the curve.</p>
<p>To create the curve we will move from p1 to p2 with a parameter called t (the same t as is in the cubic polynomial above). This t will always be a number between 0 and 1. If t is 0 we are exactly at the same coordinate as p1, and if t is 1 we are exactly at the same coordinate as p2. This <a href="http://www.mvps.org/directx/articles/catmull/" target="_blank" rel="external">link</a> will explain it better if you are lost.</p>
<p>What you first have to do after you have created a new scene in Unity is to create an empty GameObject. As children to that GameObject, you should create 4 spheres. Name these something like p1, p2, p3,… because they will form our path. Remember to create at least 4 of them, because that is the minimum number of points in a Catmull-Rom spline. Then create a new script called CatmullRomSpline, and add the following:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"></div><div class="line"><span class="comment">//Interpolation between points with a Catmull-Rom spline</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CatmullRomSpline</span> : <span class="title">MonoBehaviour</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//Has to be at least 4 points</span></div><div class="line">	<span class="keyword">public</span> Transform[] controlPointsList;</div><div class="line">	<span class="comment">//Are we making a line or a loop?</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">bool</span> isLooping = <span class="literal">true</span>;</div><div class="line"></div><div class="line">	<span class="comment">//Display without having to press play</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnDrawGizmos</span>(<span class="params"></span>)</span></div><div class="line">	&#123;</div><div class="line">		Gizmos.color = Color.white;</div><div class="line"></div><div class="line">		<span class="comment">//Draw the Catmull-Rom spline between the points</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; controlPointsList.Length; i++)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">//Cant draw between the endpoints</span></div><div class="line">			<span class="comment">//Neither do we need to draw from the second to the last endpoint</span></div><div class="line">			<span class="comment">//...if we are not making a looping line</span></div><div class="line">			<span class="keyword">if</span> ((i == <span class="number">0</span> || i == controlPointsList.Length - <span class="number">2</span> || i == controlPointsList.Length - <span class="number">1</span>) &amp;&amp; !isLooping)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			DisplayCatmullRomSpline(i);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//Display a spline between 2 points derived with the Catmull-Rom spline algorithm</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">DisplayCatmullRomSpline</span>(<span class="params"><span class="keyword">int</span> pos</span>)</span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">//The 4 points we need to form a spline between p1 and p2</span></div><div class="line">		Vector3 p0 = controlPointsList[ClampListPos(pos - <span class="number">1</span>)].position;</div><div class="line">		Vector3 p1 = controlPointsList[pos].position;</div><div class="line">		Vector3 p2 = controlPointsList[ClampListPos(pos + <span class="number">1</span>)].position;</div><div class="line">		Vector3 p3 = controlPointsList[ClampListPos(pos + <span class="number">2</span>)].position;</div><div class="line"></div><div class="line">		<span class="comment">//The start position of the line</span></div><div class="line">		Vector3 lastPos = p1;</div><div class="line"></div><div class="line">		<span class="comment">//The spline's resolution</span></div><div class="line">		<span class="comment">//Make sure it's is adding up to 1, so 0.3 will give a gap, but 0.2 will work</span></div><div class="line">		<span class="keyword">float</span> resolution = <span class="number">0.2</span>f;</div><div class="line"></div><div class="line">		<span class="comment">//How many times should we loop?</span></div><div class="line">		<span class="keyword">int</span> loops = Mathf.FloorToInt(<span class="number">1</span>f / resolution);</div><div class="line"></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= loops; i++)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">//Which t position are we at?</span></div><div class="line">			<span class="keyword">float</span> t = i * resolution;</div><div class="line"></div><div class="line">			<span class="comment">//Find the coordinate between the end points with a Catmull-Rom spline</span></div><div class="line">			Vector3 newPos = GetCatmullRomPosition(t, p0, p1, p2, p3);</div><div class="line"></div><div class="line">			<span class="comment">//Draw this line segment</span></div><div class="line">			Gizmos.DrawLine(lastPos, newPos);</div><div class="line"></div><div class="line">			<span class="comment">//Save this pos so we can draw the next line segment</span></div><div class="line">			lastPos = newPos;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//Clamp the list positions to allow looping</span></div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">ClampListPos</span>(<span class="params"><span class="keyword">int</span> pos</span>)</span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span> (pos &lt; <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			pos = controlPointsList.Length - <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (pos &gt; controlPointsList.Length)</div><div class="line">		&#123;</div><div class="line">			pos = <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">pos &gt; controlPointsList.Length - <span class="number">1</span></span>)</span></div><div class="line">		&#123;</div><div class="line">			pos = <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> pos;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//Returns a position between 4 Vector3 with Catmull-Rom spline algorithm</span></div><div class="line">	<span class="comment">//http://www.iquilezles.org/www/articles/minispline/minispline.htm</span></div><div class="line">	<span class="function">Vector3 <span class="title">GetCatmullRomPosition</span>(<span class="params"><span class="keyword">float</span> t, Vector3 p0, Vector3 p1, Vector3 p2, Vector3 p3</span>)</span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">//The coefficients of the cubic polynomial (except the 0.5f * which I added later for performance)</span></div><div class="line">		Vector3 a = <span class="number">2</span>f * p1;</div><div class="line">		Vector3 b = p2 - p0;</div><div class="line">		Vector3 c = <span class="number">2</span>f * p0 - <span class="number">5</span>f * p1 + <span class="number">4</span>f * p2 - p3;</div><div class="line">		Vector3 d = -p0 + <span class="number">3</span>f * p1 - <span class="number">3</span>f * p2 + p3;</div><div class="line"></div><div class="line">		<span class="comment">//The cubic polynomial: a + b * t + c * t^2 + d * t^3</span></div><div class="line">		Vector3 pos = <span class="number">0.5</span>f * (a + (b * t) + (c * t * t) + (d * t * t * t));</div><div class="line"></div><div class="line">		<span class="keyword">return</span> pos;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>That wasn’t too difficult? If you go to the editor you should be able to do this:</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/nSwZgKo.gif" alt="Catmull-Rom splines finished"></p>
<h2 id="2-Generate-a-Bezier-curve"><a href="#2-Generate-a-Bezier-curve" class="headerlink" title="2. Generate a Bezier curve"></a>2. Generate a Bezier curve</h2><p>The <a href="https://en.wikipedia.org/wiki/B%C3%A9zier_curve" target="_blank" rel="external">Bezier curve</a> is the most common spline, and is used to design streamlined cars (that’s why the algorithm was invented), in Photoshop, and to make roads in the game <a href="http://www.gamasutra.com/view/news/239534/Game_Design_Deep_Dive_Traffic_systems_in_Cities_Skylines.php" target="_blank" rel="external">Cities: Skylines</a>. The basic idea is that you have 2 end points and 2 control points. To form the final spline you need to interpolate linearly in different layers with <a href="https://en.wikipedia.org/wiki/De_Casteljau%27s_algorithm" target="_blank" rel="external">De Casteljau’s algorithm</a>. But why is it called a Bezier curve if we are using De Casteljau’s algorithm? The answer is that poor De Casteljau came up with the algorithm and Bezier stole it a few years later and renamed it to Bezier! Anyway, the algorithm is best explained with a picture:</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/bezier-curve-explanation.png" alt="Explanation of the Bezier curve"><br>A and D are the end points, and B and C are the control points. This will form a cubic curve. It is possible to add just one control point and you will end up with a quadratic curve, which is useful if you have limited processing power. For example, the game Quake 3 used quadratic Bezier curves. But a quadratic curve is less flexible than a cubic curve. You may also add more dimensions, so you can have as many control points as you want.</p>
<p>If A and D are fixed, you can move B and C to change the shape of the curve. But to make the curve itself, you first have to interpolate linearly between A and B, B and C, C and D. Now you have 3 new positions: Q, R, S. Now you are at a different “layer,” so you have to interpolate linearly between Q and R, and R and S. To get the final point U you need on the Bezier curve, you interpolate linearly one final time between P and T. All these interpolations use the same t value. This is how it looks like in a script (To make it work you just need 4 spheres that make up the end points and control points):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"></div><div class="line"><span class="comment">//Interpolation between 2 points with a Bezier Curve (cubic spline)</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BezierCurve</span> : <span class="title">MonoBehaviour</span> </div><div class="line">&#123;</div><div class="line">    <span class="comment">//Has to be at least 4 so-called control points</span></div><div class="line">    <span class="keyword">public</span> Transform startPoint;</div><div class="line">    <span class="keyword">public</span> Transform endPoint;</div><div class="line">    <span class="keyword">public</span> Transform controlPointStart;</div><div class="line">    <span class="keyword">public</span> Transform controlPointEnd;</div><div class="line"></div><div class="line">    <span class="comment">//Easier to use ABCD for the positions of the points so they are the same as in the tutorial image</span></div><div class="line">    Vector3 A, B, C, D;</div><div class="line"></div><div class="line">    <span class="comment">//Display without having to press play</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDrawGizmos</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        A = startPoint.position;</div><div class="line">        B = controlPointStart.position;</div><div class="line">        C = controlPointEnd.position;</div><div class="line">        D = endPoint.position;</div><div class="line"></div><div class="line">	<span class="comment">//The Bezier curve's color</span></div><div class="line">        Gizmos.color = Color.white;</div><div class="line"></div><div class="line">        <span class="comment">//The start position of the line</span></div><div class="line">        Vector3 lastPos = A;</div><div class="line"></div><div class="line">        <span class="comment">//The resolution of the line</span></div><div class="line">        <span class="comment">//Make sure the resolution is adding up to 1, so 0.3 will give a gap at the end, but 0.2 will work</span></div><div class="line">        <span class="keyword">float</span> resolution = <span class="number">0.02</span>f;</div><div class="line"></div><div class="line">        <span class="comment">//How many loops?</span></div><div class="line">        <span class="keyword">int</span> loops = Mathf.FloorToInt(<span class="number">1</span>f / resolution);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= loops; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//Which t position are we at?</span></div><div class="line">            <span class="keyword">float</span> t = i * resolution;</div><div class="line"></div><div class="line">            <span class="comment">//Find the coordinates between the control points with a Catmull-Rom spline</span></div><div class="line">            Vector3 newPos = DeCasteljausAlgorithm(t);</div><div class="line"></div><div class="line">            <span class="comment">//Draw this line segment</span></div><div class="line">            Gizmos.DrawLine(lastPos, newPos);</div><div class="line"></div><div class="line">            <span class="comment">//Save this pos so we can draw the next line segment</span></div><div class="line">            lastPos = newPos;</div><div class="line">        &#125;</div><div class="line">		</div><div class="line">	<span class="comment">//Also draw lines between the control points and endpoints</span></div><div class="line">        Gizmos.color = Color.green;</div><div class="line"></div><div class="line">        Gizmos.DrawLine(A, B);</div><div class="line">        Gizmos.DrawLine(C, D);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//The De Casteljau's Algorithm</span></div><div class="line">    <span class="function">Vector3 <span class="title">DeCasteljausAlgorithm</span>(<span class="params"><span class="keyword">float</span> t</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//Linear interpolation = lerp = (1 - t) * A + t * B</span></div><div class="line">        <span class="comment">//Could use Vector3.Lerp(A, B, t)</span></div><div class="line"></div><div class="line">        <span class="comment">//To make it faster</span></div><div class="line">        <span class="keyword">float</span> oneMinusT = <span class="number">1</span>f - t;</div><div class="line">        </div><div class="line">        <span class="comment">//Layer 1</span></div><div class="line">        Vector3 Q = oneMinusT * A + t * B;</div><div class="line">        Vector3 R = oneMinusT * B + t * C;</div><div class="line">        Vector3 S = oneMinusT * C + t * D;</div><div class="line"></div><div class="line">        <span class="comment">//Layer 2</span></div><div class="line">        Vector3 P = oneMinusT * Q + t * R;</div><div class="line">        Vector3 T = oneMinusT * R + t * S;</div><div class="line"></div><div class="line">        <span class="comment">//Final interpolated position</span></div><div class="line">        Vector3 U = oneMinusT * P + t * T;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> U;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>That wasn’t too difficult? If you go to the editor you should see this:</p>
<p><img src="../images/unity/bezier-curve.png" alt="Final Bezier curve"></p>
<h2 id="3-Move-along-a-Bezier-curve"><a href="#3-Move-along-a-Bezier-curve" class="headerlink" title="3. Move along a Bezier curve"></a>3. Move along a Bezier curve</h2><p>The focus here is on the Bezier curve. But the ideas are the same if you want to move along a Catmull-Rom spline. The problem we want to solve is that the parameter t we have used to determine where we are on a spline is <strong>NOT</strong> always percentage of distance along the line. The reason is that the distances between each t step may be different depending on the positions of the points that determines the shape of the spline. As you can see in the image below where I’ve interpolated the Bezier curve with constant t steps, the individual line segments don’t have the same length:</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/line-segments.png" alt="Explanation of the different lengths of the splines line segments"><br>If you have a camera which need to move along the curve with constant steps you need to modify the curve to make sure each step has the same size. It’s by the way common to move cameras along cubic splines. And yes, you could move the camera with constant speed (with something like Transform.Translate(Vector3.forward <em> speed </em> Time.deltatime)) and rotate it towards waypoints along the curve, but maybe that’s not always possible. The solution to the problem is that we have to <strong>reparametrize the curve</strong> to make each step the same size.</p>
<p>To make each step the same size you need to learn a few things. Luckily, people have already made detailed explanations on YouTube, so there’s no need to flood the Internet with more of the same information. So if you are interested in understanding what’s going on here, you should watch the following (or if you aldready have the knowledge needed, or if you are just interested in the code, you can ignore them):</p>
<p><a href="https://www.youtube.com/watch?v=ajkvjI8DXbY" target="_blank" rel="external">1. Constant Speed Movement</a><br><a href="https://www.youtube.com/watch?v=PGFY8vKXzQU" target="_blank" rel="external">2. Review &amp; Introduction to Quadratures</a><br><a href="https://www.youtube.com/watch?v=J_a4PXI_nLY" target="_blank" rel="external">3. Simpson’s Rule</a><br><a href="https://www.youtube.com/watch?v=-mad4YPAn2U" target="_blank" rel="external">4. Constant Speed Splines</a><br><a href="https://www.youtube.com/watch?v=Ge28Xb4B3rU" target="_blank" rel="external">Bonus: Crazy Collisions (Newton’s Method)</a><br><a href="https://www.youtube.com/watch?v=zj3eRqFXrQE" target="_blank" rel="external">Bonus: Arc Length: Derivation, Reparametrization, Example</a></p>
<p>To sum it up, the basic idea is that we have to first learn how to compute the length of the Bezier curve, and then how to compute where we are on a curve at certain positions. We already know how to compute where we are on a curve based on the parameter t. But now we imagine that we move along a straight line at constant steps, and at each step we have to translate the straight line to a position on the curve by calculating the curve’s t value (to get a position on the curve) as if we had traveled along a curve.</p>
<h3 id="Calculate-the-length-of-the-curve"><a href="#Calculate-the-length-of-the-curve" class="headerlink" title="Calculate the length of the curve"></a>Calculate the length of the curve</h3><p>To be able to compute the length of a curve we will use two methods. Both of these methods involve a root (which is not good from a performance perspective), so I’m not sure which one is the fastest, but one of them is most likely more accurate than the other.</p>
<h4 id="Method-1-Straight-lines"><a href="#Method-1-Straight-lines" class="headerlink" title="Method 1. Straight lines"></a>Method 1. Straight lines</h4><p>Here we loop through the Bezier curve in the same way as when we created it. But we will also calculate the length of each section and add them up to get the total length. So we will approximate the Bezier curve with a lot of small straight lines. This is the code:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Get the length of the curve with a naive method where we divide the</span></div><div class="line"><span class="comment">//curve into straight lines and then measure the length of each line</span></div><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">GetLengthNaive</span>(<span class="params"><span class="keyword">float</span> tStart, <span class="keyword">float</span> tEnd</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//This is the resolution, the higher the better</span></div><div class="line">	<span class="keyword">int</span> sections = <span class="number">10</span>;</div><div class="line"></div><div class="line">	<span class="comment">//Divide the curve into sections</span></div><div class="line">	<span class="keyword">float</span> delta = (tEnd - tStart) / (<span class="keyword">float</span>)sections;</div><div class="line"></div><div class="line">	<span class="comment">//The start position of the curve</span></div><div class="line">	Vector3 lastPos = DeCasteljausAlgorithm(tStart);</div><div class="line"></div><div class="line">	<span class="comment">//Init length</span></div><div class="line">	<span class="keyword">float</span> length = <span class="number">0</span>f;</div><div class="line"></div><div class="line">	<span class="comment">//Move along the curve</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= sections; i++)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//Calculate the t value at this section</span></div><div class="line">		<span class="keyword">float</span> t = tStart + delta * i;</div><div class="line"></div><div class="line">		<span class="comment">//Find the coordinates at this t</span></div><div class="line">		Vector3 pos = DeCasteljausAlgorithm(t);</div><div class="line"></div><div class="line">		<span class="comment">//Add the section to the total length</span></div><div class="line">		length += Vector3.Magnitude(pos - lastPos);</div><div class="line"></div><div class="line">		<span class="comment">//Save the latest pos for next loop</span></div><div class="line">		lastPos = pos;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> length;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Method-2-Simpson’s-Rule"><a href="#Method-2-Simpson’s-Rule" class="headerlink" title="Method 2. Simpson’s Rule"></a>Method 2. Simpson’s Rule</h4><p>Here we loop through the Bezier curve in the same way as when we created it. But instead of approximating each section with a straight line, we will approximate each section with a second degree polynomial. The easiest way to do that is to use <a href="https://en.wikipedia.org/wiki/Simpson%27s_rule" target="_blank" rel="external">Simpson’s rule</a>.</p>
<p>To be able to use Simpson’s rule we need an integral that calculates the length of the line. Luckily, the nice people in the YouTube videos gave us that integral (but we have three dimensions, so just add dz to it):</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/integral-curve-length.png" alt="Integral to calculate the length of a curve"><br>It’s not possible to find an analytic solution to that integral, which is why we have to approximate it with Simpson’s rule. But first we need to figure out what’s inside the integral. If we have a Bezier curve, what’s inside the integral is the derivative of the Bezier curve with respect to t. So you have to take the derivative of De Casteljau’s Algorithm. This is easy: you just combine all different layers into one big equation called U, simplify, and then take the derivative. The result is this:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//The derivative of cubic De Casteljau's Algorithm</span></div><div class="line"><span class="function">Vector3 <span class="title">DeCasteljausAlgorithmDerivative</span>(<span class="params"><span class="keyword">float</span> t</span>)</span></div><div class="line">&#123;</div><div class="line">	Vector3 dU = t * t * (<span class="number">-3</span>f * (A - <span class="number">3</span>f * (B - C) - D));</div><div class="line"></div><div class="line">	dU += t * (<span class="number">6</span>f * (A - <span class="number">2</span>f * B + C));</div><div class="line"></div><div class="line">	dU += <span class="number">-3</span>f * (A - B); </div><div class="line"></div><div class="line">	<span class="keyword">return</span> dU;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>But what’s inside the integral is actually the magnitude of the derivative, so we need another method:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Get and infinite small length from the derivative of the curve at position t</span></div><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">GetArcLengthIntegrand</span>(<span class="params"><span class="keyword">float</span> t</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//The derivative at this point (the velocity vector)</span></div><div class="line">	Vector3 dPos = DeCasteljausAlgorithmDerivative(t);</div><div class="line"></div><div class="line">	<span class="comment">//This the how it looks like in the YouTube videos</span></div><div class="line">	<span class="comment">//float xx = dPos.x * dPos.x;</span></div><div class="line">	<span class="comment">//float yy = dPos.y * dPos.y;</span></div><div class="line">	<span class="comment">//float zz = dPos.z * dPos.z;</span></div><div class="line"></div><div class="line">	<span class="comment">//float integrand = Mathf.Sqrt(xx + yy + zz);</span></div><div class="line"></div><div class="line">	<span class="comment">//Same as above</span></div><div class="line">	<span class="keyword">float</span> integrand = dPos.magnitude;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> integrand;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>And now we can use Simpson’s rule to approximate the integral to get the length of the Bezier curve between two t values:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Get the length of the curve between two t values with Simpson's rule</span></div><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">GetLengthSimpsons</span>(<span class="params"><span class="keyword">float</span> tStart, <span class="keyword">float</span> tEnd</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//This is the resolution and has to be even</span></div><div class="line">	<span class="keyword">int</span> n = <span class="number">20</span>;</div><div class="line"></div><div class="line">	<span class="comment">//Now we need to divide the curve into sections</span></div><div class="line">	<span class="keyword">float</span> delta = (tEnd - tStart) / (<span class="keyword">float</span>)n;</div><div class="line"></div><div class="line">	<span class="comment">//The main loop to calculate the length</span></div><div class="line">	</div><div class="line">	<span class="comment">//Everything multiplied by 1</span></div><div class="line">	<span class="keyword">float</span> endPoints = GetArcLengthIntegrand(tStart) + GetArcLengthIntegrand(tEnd);</div><div class="line"></div><div class="line">	<span class="comment">//Everything multiplied by 4</span></div><div class="line">	<span class="keyword">float</span> x4 = <span class="number">0</span>f;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i += <span class="number">2</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">float</span> t = tStart + delta * i;</div><div class="line"></div><div class="line">		x4 += GetArcLengthIntegrand(t);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//Everything multiplied by 2</span></div><div class="line">	<span class="keyword">float</span> x2 = <span class="number">0</span>f;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i += <span class="number">2</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">float</span> t = tStart + delta * i;</div><div class="line"></div><div class="line">		x2 += GetArcLengthIntegrand(t);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//The final length</span></div><div class="line">	<span class="keyword">float</span> length = (delta / <span class="number">3</span>f) * (endPoints + <span class="number">4</span>f* x4 + <span class="number">2</span>f * x2);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> length;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>So which of the methods is most accurate? The answer is that we don’t know because we don’t know the exact length of the line. But if you test the methods you get the following:</p>
<ul>
<li>Small straight lines: 860.0575 m</li>
<li>Simpson’s rule: 861.2954 m<br>…so the difference between the methods is not big.</li>
</ul>
<h3 id="Divide-the-curve-into-constant-steps"><a href="#Divide-the-curve-into-constant-steps" class="headerlink" title="Divide the curve into constant steps"></a>Divide the curve into constant steps</h3><p>Alright, finding the length of the Bezier curve was cool, but why do we need it? Well, if you have watched the YouTube videos you know that we need it to solve this equation:</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/equation-to-find-t.png" alt="Equation to find parameter t from length"></p>
<p>The above equation answers the question: at which t value have we walked 1/3 of the total length of the curve? In the future we will replace this 1/3 with however far we have walked on the line. This distance is always measured from the start of the line. To solve the equation we are going to use a numerical method called <a href="https://en.wikipedia.org/wiki/Newton%27s_method" target="_blank" rel="external">Newton’s method</a>. The basic idea behind the method is that it starts with a t value, and then it’s trying to find a better t value by using the t value from the last iteration. This is how it looks like in code:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Use Newton–Raphsons method to find the t value at the end of this distance d</span></div><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">FindTValue</span>(<span class="params"><span class="keyword">float</span> d, <span class="keyword">float</span> totalLength</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//Need a start value to make the method start</span></div><div class="line">	<span class="comment">//Should obviously be between 0 and 1</span></div><div class="line">	<span class="comment">//We can say that a good starting point is the percentage of distance traveled</span></div><div class="line">	<span class="comment">//If this start value is not working you can use the Bisection Method to find a start value</span></div><div class="line">	<span class="comment">//https://en.wikipedia.org/wiki/Bisection_method</span></div><div class="line">	<span class="keyword">float</span> t = d / totalLength;</div><div class="line"></div><div class="line">	<span class="comment">//Need an error so we know when to stop the iteration</span></div><div class="line">	<span class="keyword">float</span> error = <span class="number">0.001</span>f;</div><div class="line"></div><div class="line">	<span class="comment">//We also need to avoid infinite loops</span></div><div class="line">	<span class="keyword">int</span> iterations = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//Newton's method</span></div><div class="line">		<span class="keyword">float</span> tNext = t - ((GetLengthSimpsons(<span class="number">0</span>f, t) - d) / GetArcLengthIntegrand(t));</div><div class="line"></div><div class="line">		<span class="comment">//Have we reached the desired accuracy?</span></div><div class="line">		<span class="keyword">if</span> (Mathf.Abs(tNext - t) &lt; error)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		t = tNext;</div><div class="line"></div><div class="line">		iterations += <span class="number">1</span>;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (iterations &gt; <span class="number">1000</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> t;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>To be able to better see the line sections, I’ve added a way to display a new color each new step. To make that work you need to add this to the top of the script:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//An array with colors to display the line segments that make up the final curve</span></div><div class="line">Color[] colorsArray = &#123;Color.white, Color.red, Color.blue, Color.magenta, Color.black&#125;;</div></pre></td></tr></table></figure>
<p>And finally the method that will divide the Bezier curve into equal steps:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Divide the curve into equal steps</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">DivideCurveIntoSteps</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//Find the total length of the curve</span></div><div class="line">	<span class="keyword">float</span> totalLength = GetLengthSimpsons(<span class="number">0</span>f, <span class="number">1</span>f);</div><div class="line"></div><div class="line">	<span class="comment">//How many sections do we want to divide the curve into</span></div><div class="line">	<span class="keyword">int</span> parts = <span class="number">10</span>;</div><div class="line"></div><div class="line">	<span class="comment">//What's the length of one section?</span></div><div class="line">	<span class="keyword">float</span> sectionLength = totalLength / (<span class="keyword">float</span>)parts;</div><div class="line"></div><div class="line">	<span class="comment">//Init the variables we need in the loop</span></div><div class="line">	<span class="keyword">float</span> currentDistance = <span class="number">0</span>f + sectionLength;</div><div class="line">	</div><div class="line">	<span class="comment">//The curve's start position</span></div><div class="line">	Vector3 lastPos = A;</div><div class="line"></div><div class="line">	<span class="comment">//The Bezier curve's color</span></div><div class="line">	<span class="comment">//Need a seed or the line will constantly change color</span></div><div class="line">	Random.InitState(<span class="number">12345</span>);</div><div class="line"></div><div class="line">	<span class="keyword">int</span> lastRandom = Random.Range(<span class="number">0</span>, colorsArray.Length);</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= parts; i++)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//Use Newton–Raphsons method to find the t value from the start of the curve </span></div><div class="line">		<span class="comment">//to the end of the distance we have</span></div><div class="line">		<span class="keyword">float</span> t = FindTValue(currentDistance, totalLength);</div><div class="line"></div><div class="line">		<span class="comment">//Get the coordinate on the Bezier curve at this t value</span></div><div class="line">		Vector3 pos = DeCasteljausAlgorithm(t);</div><div class="line"></div><div class="line"></div><div class="line">		<span class="comment">//Draw the line with a random color</span></div><div class="line">		<span class="keyword">int</span> newRandom = Random.Range(<span class="number">0</span>, colorsArray.Length);</div><div class="line">		</div><div class="line">		<span class="comment">//Get a different random number each time</span></div><div class="line">		<span class="keyword">while</span> (newRandom == lastRandom)</div><div class="line">		&#123;</div><div class="line">			newRandom = Random.Range(<span class="number">0</span>, colorsArray.Length);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		lastRandom = newRandom;</div><div class="line"></div><div class="line">		Gizmos.color = colorsArray[newRandom];</div><div class="line"></div><div class="line">		Gizmos.DrawLine(lastPos, pos);</div><div class="line"></div><div class="line"></div><div class="line">		<span class="comment">//Save the last position</span></div><div class="line">		lastPos = pos;</div><div class="line"></div><div class="line">		<span class="comment">//Add to the distance traveled on the line so far</span></div><div class="line">		currentDistance += sectionLength;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now we can compare if all this math was really worth it:</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/bezier-curve-constant-steps.png" alt="Bezier curve with constant steps"></p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/bezier-curve-constant-steps.png" alt="Bezier curve with unequal step size"></p>
<p>If you can’t tell the difference then you’ve wasted a lot of time, but maybe learned something new! Otherwise you’ve just learned how to take constant steps along a Bezier curve!</p>
<h2 id="Read-more"><a href="#Read-more" class="headerlink" title="Read more"></a>Read more</h2><ul>
<li><a href="https://www.amazon.com/Essential-Mathematics-Games-Interactive-Applications/dp/0123742978" target="_blank" rel="external">Essential Mathematics for Games and Interactive Applications</a></li>
<li><a href="http://www.redblobgames.com/articles/curved-paths/" target="_blank" rel="external">Red Blob Games - Curved Paths</a></li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.habrador.com/tutorials/interpolation/" target="_blank" rel="external">Everything about interpolation in Unity with C# code</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tospan.me/2017/02/05/Interpolation-in-Unity/" data-id="ciyu4ntex000w2tvwmrzgg4uc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Math/">Math</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Numerical-Analysis/">Numerical Analysis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unity/">Unity</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/02/05/Generate-random-numbers-in-Unity/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Generate random numbers in Unity
        
      </div>
    </a>
  
  
    <a href="/2017/02/05/How-to-make-Dubins-Paths-in-Unity/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">在Unity中制作Dubins曲线(C#)</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unity/">Unity</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Basics/">Basics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Games/">Games</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Geometry/">Geometry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linear-Algebra/">Linear Algebra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Numerical-Analysis/">Numerical Analysis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/default/">default</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Basics/" style="font-size: 15px;">Basics</a> <a href="/tags/C/" style="font-size: 13.33px;">C#</a> <a href="/tags/Games/" style="font-size: 10px;">Games</a> <a href="/tags/Geometry/" style="font-size: 11.67px;">Geometry</a> <a href="/tags/Linear-Algebra/" style="font-size: 16.67px;">Linear Algebra</a> <a href="/tags/Math/" style="font-size: 18.33px;">Math</a> <a href="/tags/Numerical-Analysis/" style="font-size: 10px;">Numerical Analysis</a> <a href="/tags/Unity/" style="font-size: 20px;">Unity</a> <a href="/tags/default/" style="font-size: 10px;">default</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/06/Math-3D/">3D数学</a>
          </li>
        
          <li>
            <a href="/2017/02/06/Unity-Engine-Core-Concept/">Unity引擎重要概念</a>
          </li>
        
          <li>
            <a href="/2017/02/06/Unity-Scripting-2D-Code-Snippet/">Unity编程 2D脚本常用代码集合</a>
          </li>
        
          <li>
            <a href="/2017/02/06/Unity-Scripting-Core/">Unity编程要点</a>
          </li>
        
          <li>
            <a href="/2017/02/06/C-Sharp-Essential/">C#要点</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 To Span<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>