<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Unity游戏编程模式:Flyweight Pattern | 吐司片的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="What’s the flyweight pattern?We begin with Wikipedia‘s defintion of the flyweight pattern:

In computer programming, flyweight is a software design pattern. A flyweight is an object that minimizes mem">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity游戏编程模式:Flyweight Pattern">
<meta property="og:url" content="http://tospan.me/2017/02/05/Unity-GPP-Flyweight-Pattern/index.html">
<meta property="og:site_name" content="吐司片的博客">
<meta property="og:description" content="What’s the flyweight pattern?We begin with Wikipedia‘s defintion of the flyweight pattern:

In computer programming, flyweight is a software design pattern. A flyweight is an object that minimizes mem">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/memory-without-flyweight.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/memory-with-flyweight.png">
<meta property="og:updated_time" content="2017-02-05T07:14:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unity游戏编程模式:Flyweight Pattern">
<meta name="twitter:description" content="What’s the flyweight pattern?We begin with Wikipedia‘s defintion of the flyweight pattern:

In computer programming, flyweight is a software design pattern. A flyweight is an object that minimizes mem">
<meta name="twitter:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/memory-without-flyweight.png">
  
    <link rel="alternate" href="/atom.xml" title="吐司片的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">吐司片的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Work hard, play hard.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Søk"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://tospan.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Unity-GPP-Flyweight-Pattern" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/05/Unity-GPP-Flyweight-Pattern/" class="article-date">
  <time datetime="2017-02-05T07:14:28.000Z" itemprop="datePublished">2017-02-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Unity/">Unity</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Unity游戏编程模式:Flyweight Pattern
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="What’s-the-flyweight-pattern"><a href="#What’s-the-flyweight-pattern" class="headerlink" title="What’s the flyweight pattern?"></a>What’s the flyweight pattern?</h2><p>We begin with <a href="https://en.wikipedia.org/wiki/Flyweight_pattern" target="_blank" rel="external">Wikipedia</a>‘s defintion of the flyweight pattern:</p>
<blockquote>
<p>In computer programming, flyweight is a software design pattern. A flyweight is an object that minimizes memory use by sharing as much data as possible with other similar objects; it is a way to use objects in large numbers when a simple repeated representation would use an unacceptable amount of memory.</p>
</blockquote>
<a id="more"></a>
<p>So the basic idea is that if you have a lot of objects in your game, there’s a high probability that you can increase the performance of your game by optimizing memory usage by making those objects “lighter.” If this is going to work, your objects have to share some data which is the same for all objects. If they do share some data, then you can create the data once and then store a reference to the data in the object. This might sound complicated, so we need an example.</p>
<p>One common example to use is trees. Each tree in a game is the same to all other trees. So what’s being shared among all trees is:</p>
<ul>
<li>They have the same mesh</li>
<li>They have the same textures</li>
</ul>
<p>But the trees don’t have the same position, so that’s the only thing in the tree object that’s different from all other trees.</p>
<h2 id="Before-the-flyweight-pattern"><a href="#Before-the-flyweight-pattern" class="headerlink" title="Before the flyweight pattern"></a>Before the flyweight pattern</h2><p>Trees are kinda dull, so we are here going to use Aliens with thousands of eyes, arms, and legs. So we need an alien class that describes an alien:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">FlyweightPattern</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//Class that includes lists with position of body parts</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Alien</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">public</span> List&lt;Vector3&gt; eyePositions;</div><div class="line">        <span class="keyword">public</span> List&lt;Vector3&gt; legPositions;</div><div class="line">        <span class="keyword">public</span> List&lt;Vector3&gt; armPositions;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Before the flyweight pattern we will create all aliens and generate new body-part-positions for each alien:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"></div><div class="line"><span class="comment">//Flyweight design pattern main class</span></div><div class="line"><span class="keyword">namespace</span> <span class="title">FlyweightPattern</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Flyweight</span> : <span class="title">MonoBehaviour</span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//The list that stores all aliens</span></div><div class="line">        List&lt;Alien&gt; allAliens = <span class="keyword">new</span> List&lt;Alien&gt;();</div><div class="line"></div><div class="line">        List&lt;Vector3&gt; eyePositions;</div><div class="line">        List&lt;Vector3&gt; legPositions;</div><div class="line">        List&lt;Vector3&gt; armPositions;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></div><div class="line">        &#123;</div><div class="line">            <span class="comment">//List used when flyweight is enabled</span></div><div class="line">            eyePositions = GetBodyPartPositions();</div><div class="line">            legPositions = GetBodyPartPositions();</div><div class="line">            armPositions = GetBodyPartPositions();</div><div class="line">            </div><div class="line">            <span class="comment">//Create all aliens</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++)</div><div class="line">            &#123;</div><div class="line">                Alien newAlien = <span class="keyword">new</span> Alien();</div><div class="line"></div><div class="line">                <span class="comment">//Add eyes and leg positions</span></div><div class="line">                <span class="comment">//Without flyweight</span></div><div class="line">                newAlien.eyePositions = GetBodyPartPositions();</div><div class="line">                newAlien.armPositions = GetBodyPartPositions();</div><div class="line">                newAlien.legPositions = GetBodyPartPositions();</div><div class="line"></div><div class="line">                <span class="comment">//With flyweight</span></div><div class="line">                <span class="comment">//newAlien.eyePositions = eyePositions;</span></div><div class="line">                <span class="comment">//newAlien.armPositions = legPositions;</span></div><div class="line">                <span class="comment">//newAlien.legPositions = armPositions;</span></div><div class="line"></div><div class="line">                allAliens.Add(newAlien);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">//Generate a list with body part positions</span></div><div class="line">        <span class="function">List&lt;Vector3&gt; <span class="title">GetBodyPartPositions</span>(<span class="params"></span>)</span></div><div class="line">        &#123;</div><div class="line">            <span class="comment">//Create a new list</span></div><div class="line">            List&lt;Vector3&gt; bodyPartPositions = <span class="keyword">new</span> List&lt;Vector3&gt;();</div><div class="line"></div><div class="line">            <span class="comment">//Add body part positions to the list</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</div><div class="line">            &#123;</div><div class="line">                bodyPartPositions.Add(<span class="keyword">new</span> Vector3());</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> bodyPartPositions;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If you add the <code>Flyweight.cs</code> to an empty gameobject, open the profiler, press play, click on the Memory box, you will see this image:</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/memory-without-flyweight.png" alt="Unity profiler memory without flyweight pattern"></p>
<p>The box you should pay attention to is Mono, which, <a href="http://docs.unity3d.com/Manual/ProfilerMemory.html" target="_blank" rel="external">according to Unity</a>, is the “total heap size and used heap size used by Managed Code - this memory is garbagecollected.” It’s currently at 0.63 Gb, which is the number we are going to lower with the flyweight pattern.</p>
<h2 id="After-the-flyweight-pattern"><a href="#After-the-flyweight-pattern" class="headerlink" title="After the flyweight pattern"></a>After the flyweight pattern</h2><p>To add the flyweight pattern, we just assume that all aliens have the same body-part-positions. It might not be realistic, but this is just a test to see how the flyweight pattern is working. So modify the code so it looks like this:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Add eyes and leg positions</span></div><div class="line"><span class="comment">//Without flyweight</span></div><div class="line"><span class="comment">//newAlien.eyePositions = GetBodyPartPositions();</span></div><div class="line"><span class="comment">//newAlien.armPositions = GetBodyPartPositions();</span></div><div class="line"><span class="comment">//newAlien.legPositions = GetBodyPartPositions();</span></div><div class="line"></div><div class="line"><span class="comment">//With flyweight</span></div><div class="line">newAlien.eyePositions = eyePositions;</div><div class="line">newAlien.armPositions = legPositions;</div><div class="line">newAlien.legPositions = armPositions;</div></pre></td></tr></table></figure>
<p>So we generate the body-part-positions once in the beginning and then add a reference to them to each Alien object. If you now open the profiler, press play, click on the Memory box, you will see this image:</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/memory-with-flyweight.png" alt="Unity profiler memory with flyweight pattern"></p>
<p>So the Memory has gone from 0.63 Gb to 17 Mb!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tospan.me/2017/02/05/Unity-GPP-Flyweight-Pattern/" data-id="ciyvdy4bv001o9qvwpv6gn49l" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unity/">Unity</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/02/05/Unity-GPP-Observer-pattern/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Unity GPP Observer pattern
        
      </div>
    </a>
  
  
    <a href="/2017/02/05/Unity-GPP-Command-Pattern/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Unity GPP Command Pattern</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorier</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unity/">Unity</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/default/">default</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Basics/">Basics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Games/">Games</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Geometry/">Geometry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linear-Algebra/">Linear Algebra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Numerical-Analysis/">Numerical Analysis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/default/">default</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Basics/" style="font-size: 14px;">Basics</a> <a href="/tags/C/" style="font-size: 12px;">C#</a> <a href="/tags/Games/" style="font-size: 10px;">Games</a> <a href="/tags/Geometry/" style="font-size: 12px;">Geometry</a> <a href="/tags/Linear-Algebra/" style="font-size: 16px;">Linear Algebra</a> <a href="/tags/Math/" style="font-size: 18px;">Math</a> <a href="/tags/Numerical-Analysis/" style="font-size: 10px;">Numerical Analysis</a> <a href="/tags/Unity/" style="font-size: 20px;">Unity</a> <a href="/tags/default/" style="font-size: 16px;">default</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Arkiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Siste innlegg</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/07/Unity-FSM/">Unity FSM</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Object-Pools-2/">Unity Object Pools 2</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Scripting-Coroutine-Delay/">Unity Scripting Coroutine Delay</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Scripting-Coroutine/">Unity Scripting Coroutine</a>
          </li>
        
          <li>
            <a href="/2017/02/07/Unity-Scripting-Memory-Management/">Unity Scripting Memory Management</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 To Span<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>