<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Unity Dynamic Mesh Combining | 吐司片的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="IntroductionA few weeks ago I decided to make a forest fire simulator in Unity (you can test it here). A forest, as you know, has a lot of trees. But when I added all trees to the forest I realized t">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity Dynamic Mesh Combining">
<meta property="og:url" content="http://tospan.me/2017/02/05/Unity-Dynamic-Mesh-Combining/index.html">
<meta property="og:site_name" content="吐司片的博客">
<meta property="og:description" content="IntroductionA few weeks ago I decided to make a forest fire simulator in Unity (you can test it here). A forest, as you know, has a lot of trees. But when I added all trees to the forest I realized t">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/combine-meshes-tutorial.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/circle.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/setup-scene-finished.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/multicolor-trees-combined.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/forest-before-combined-meshes.png">
<meta property="og:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/forest-after-combined-meshes.png">
<meta property="og:updated_time" content="2017-02-05T06:39:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unity Dynamic Mesh Combining">
<meta name="twitter:description" content="IntroductionA few weeks ago I decided to make a forest fire simulator in Unity (you can test it here). A forest, as you know, has a lot of trees. But when I added all trees to the forest I realized t">
<meta name="twitter:image" content="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/combine-meshes-tutorial.png">
  
    <link rel="alternate" href="/atom.xml" title="吐司片的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">吐司片的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Work hard, play hard.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://tospan.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Unity-Dynamic-Mesh-Combining" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/05/Unity-Dynamic-Mesh-Combining/" class="article-date">
  <time datetime="2017-02-05T06:39:07.000Z" itemprop="datePublished">2017-02-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Unity/">Unity</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Unity Dynamic Mesh Combining
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/combine-meshes-tutorial.png" alt="Unity mesh combining final forest"></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>A few weeks ago I decided to make a forest fire simulator in Unity (you can test it here). A forest, as you know, has a lot of trees. But when I added all trees to the forest I realized that the simulation was running very slow. Then I recalled the game <a href="http://www.citiesskylines.com/" target="_blank" rel="external">Cities: Skylines</a> and began to wonder how that game was running faster despite having more trees than my small forest. After an unscientific research on the Internet I realized that the answer was mesh combining.</p>
<a id="more"></a>
<p>Mesh combining is the art of taking several of your objects in Unity and combine them into one object. So instead of having several tree game objects, you will end up with one big tree game object that contains several trees. This will increase the performance of your game or simulator. You can measure this by looking at the number of batches in Unity’s “Statistics” window. The fewer batches, the better.</p>
<p>Unity already has a small tutorial on how to combine meshes (you can find it <a href="http://docs.unity3d.com/ScriptReference/Mesh.CombineMeshes.html" target="_blank" rel="external">here</a>). But that tutorial is way too basic. What if you need to remove a tree from the combined mesh? What if you need to add a tree to the combined mesh? So I decided to extend that tutorial with this tutorial.</p>
<ul>
<li>In part 2 you will set up the basic scene and make a tool that looks like Cities: Skylines’s Tree Brush tool.</li>
<li>In part 3 you will learn how to combine meshes with different colors into one mesh. You will not need this part to complete the rest of the tutorial, so you can safely ignore it if you want.</li>
<li>In part 4 you will learn how to make a forest and combine the trees into larger meshes.</li>
<li>In part 5 you will learn how to add and remove trees from the combined meshes, by using a tool similar to the Tree Brush tool in Cities: Skylines.</li>
</ul>
<h2 id="Set-up-the-basic-scene"><a href="#Set-up-the-basic-scene" class="headerlink" title="Set up the basic scene"></a>Set up the basic scene</h2><p>In this part of the tutorial you will make a ground, a tree, a moving camera, and a Tree Brush tool similar to the tool in Cities: Skylines.</p>
<h3 id="Part-1-A-one-tree-forest"><a href="#Part-1-A-one-tree-forest" class="headerlink" title="Part 1. A one tree forest"></a>Part 1. A one tree forest</h3><p>Start by making a plane with the scale 100 positioned at the center. Give it a nice color and rename it to “Ground.” Then create an empty gameobject and rename it “_Controller.” Make sure it is at the center. This controller will hold all scripts we create.</p>
<p>Then create an empty gameobject and rename it to “Tree.” As a child to that gameobject, create a cylinder, and rename it to “Wood.” It should have position (0, 1, 0) and scale (0.2, 1, 0.2). Give it a material called “Wood.” Then add a sphere, and rename the sphere to “Leaf,” and give it a material called “Leaf.” The sphere should have position (0, 2, 0) and scale (2, 2.54, 2). If you have done everything correctly you should now have what looks like a tree, where the coordinate system of the tree begins at the bottom of the tree. This will make it easier to add trees and we don’t need to care about the tree’s height. Also make the tree a prefab.</p>
<p>Now we need a script that can move the camera. This is not a tutorial on how to move a camera, so I will just give you my script. The basic idea is that we move the camera with WASD and zoom it with the mouse wheel or keys I or O. Drag the script to the camera.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CameraController</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line"></div><div class="line">	<span class="keyword">float</span> height = <span class="number">40</span>f;</div><div class="line">	<span class="keyword">float</span> distanceBack = <span class="number">40</span>f;</div><div class="line"></div><div class="line">	<span class="keyword">float</span> camMoveSpeed = <span class="number">30</span>f;</div><div class="line">	<span class="keyword">float</span> zoomSpeed = <span class="number">3</span>f;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>) </span></div><div class="line">	&#123;</div><div class="line">		transform.position = Vector3.zero;</div><div class="line">		<span class="comment">//Move up</span></div><div class="line">		transform.position += <span class="keyword">new</span> Vector3(<span class="number">0</span>f, height, <span class="number">0</span>f);</div><div class="line">		<span class="comment">//Move back</span></div><div class="line">		transform.position -= <span class="keyword">new</span> Vector3(<span class="number">0</span>f, <span class="number">0</span>f, distanceBack);</div><div class="line">		<span class="comment">//Look at the center to get an angle</span></div><div class="line">		transform.LookAt(Vector3.zero);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LateUpdate</span>(<span class="params"></span>) </span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">//Move camera with keys</span></div><div class="line">		<span class="comment">//Move left/right</span></div><div class="line">		<span class="keyword">if</span> (Input.GetKey(KeyCode.A)) &#123;</div><div class="line">			transform.position -= <span class="keyword">new</span> Vector3(camMoveSpeed * Time.deltaTime, <span class="number">0</span>f, <span class="number">0</span>f);</div><div class="line">		&#125;</div><div class="line">		<span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">Input.GetKey(KeyCode.D</span>)) </span>&#123;</div><div class="line">			transform.position += <span class="keyword">new</span> Vector3(camMoveSpeed * Time.deltaTime, <span class="number">0</span>f, <span class="number">0</span>f);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//Move forward/back</span></div><div class="line">		<span class="keyword">if</span> (Input.GetKey(KeyCode.S)) &#123;</div><div class="line">			transform.position -= <span class="keyword">new</span> Vector3(<span class="number">0</span>f, <span class="number">0</span>f, camMoveSpeed * Time.deltaTime);</div><div class="line">		&#125;</div><div class="line">		<span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">Input.GetKey(KeyCode.W</span>)) </span>&#123;</div><div class="line">			transform.position += <span class="keyword">new</span> Vector3(<span class="number">0</span>f, <span class="number">0</span>f, camMoveSpeed * Time.deltaTime);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//Zoom</span></div><div class="line">		<span class="keyword">float</span> currentHeight = transform.position.y;</div><div class="line"></div><div class="line">		<span class="keyword">float</span> zoomDistance = <span class="number">0</span>f;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (currentHeight &gt; <span class="number">20</span>f &amp;&amp; currentHeight &lt; <span class="number">200</span>f) &#123;</div><div class="line">			<span class="keyword">if</span> (Input.GetAxis(<span class="string">"Mouse ScrollWheel"</span>) &gt; <span class="number">0</span>f || Input.GetKeyDown(KeyCode.I)) &#123;</div><div class="line">				zoomDistance += zoomSpeed;</div><div class="line">			&#125; </div><div class="line">			<span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">Input.GetAxis(<span class="string">"Mouse ScrollWheel"</span></span>) &lt; 0f || Input.<span class="title">GetKeyDown</span>(<span class="params">KeyCode.O</span>)) </span>&#123;</div><div class="line">				zoomDistance -= zoomSpeed;</div><div class="line">			&#125; </div><div class="line">		&#125;</div><div class="line">		<span class="comment">//Can only zoom in</span></div><div class="line">		<span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">currentHeight &gt; <span class="number">200</span>f</span>) </span>&#123;</div><div class="line">			<span class="keyword">if</span> (Input.GetAxis(<span class="string">"Mouse ScrollWheel"</span>) &gt; <span class="number">0</span>f || Input.GetKeyDown(KeyCode.I)) &#123;</div><div class="line">				zoomDistance += zoomSpeed;</div><div class="line">			&#125; </div><div class="line">		&#125;</div><div class="line">		<span class="comment">//Can only zoom out</span></div><div class="line">		<span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">currentHeight &lt; <span class="number">20</span>f</span>) </span>&#123;</div><div class="line">			<span class="keyword">if</span> (Input.GetAxis(<span class="string">"Mouse ScrollWheel"</span>) &lt; <span class="number">0</span>f || Input.GetKeyDown(KeyCode.O)) &#123;</div><div class="line">				zoomDistance -= zoomSpeed;</div><div class="line">			&#125; </div><div class="line">		&#125;</div><div class="line"></div><div class="line">		transform.Translate(Vector3.forward * zoomDistance);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Part-2-A-Tree-Brush-tool"><a href="#Part-2-A-Tree-Brush-tool" class="headerlink" title="Part 2. A Tree Brush tool"></a>Part 2. A Tree Brush tool</h3><p>Now we will create a Tree Brush tool similar to the tool Cities: Skylines is using to place trees. If you haven’t seen it, it is basically a filled circle that you can resize to place (or remove) trees over a larger or smaller area.</p>
<p>Out Tree Brush tool consists of a projector, so import Unity’s standard projectors. Go to Assets → Import package → Effects → Projectors. We are here going to use the <strong>BlobLightProjector</strong>. But first you have to create an empty gameobject and rename it “Circle.” Then make the projector a child of that gameobject. Position the projector at (0, 0.38, 0) and make sure the rotation is (90, 0, 0). Also check the projector’s “Ortographic” checkbox, and that the projector should ignore layer “Tree.” So make sure the Tree you created is at a layer called “Tree.”</p>
<p>But the projector’s circle doesn’t look good, so we need a new one. Open the projector’s material and give it a new circle by importing a circle image to Unity and then drag it to the material slot called “Cookie.” I’m using this circle:</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/circle.png" alt="Our tree brush circle"></p>
<p>Now we need to make the circle move around with the mouse. Create a new script called “TutorialMouseMarker,” and add the following to it:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"></div><div class="line"><span class="comment">//Creates a cities skylines style round circle that </span></div><div class="line"><span class="comment">//will move around with the mouse and is resizable</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TutorialMouseMarker</span> : <span class="title">MonoBehaviour</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TutorialMouseMarker current;</div><div class="line"></div><div class="line">    <span class="comment">//Drags</span></div><div class="line">    <span class="comment">//The gameobject holding the projector</span></div><div class="line">    <span class="keyword">public</span> GameObject circleObj;</div><div class="line">    <span class="comment">//The projector that will display the circle</span></div><div class="line">    <span class="keyword">public</span> Projector projector;</div><div class="line"></div><div class="line">    <span class="comment">//Projector settings</span></div><div class="line">    <span class="keyword">float</span> projectorMax = <span class="number">15</span>f;</div><div class="line">    <span class="keyword">float</span> projectorMin = <span class="number">3</span>f;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        current = <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        UpdateProjector();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//Move the circle and change its size</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UpdateProjector</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//Find the position of the mouse</span></div><div class="line">        Vector3 mouseScreenPosition = Input.mousePosition;</div><div class="line"></div><div class="line">        RaycastHit hit;</div><div class="line"></div><div class="line">        <span class="comment">//Fire ray and make sure we hit ground which is layer 10</span></div><div class="line">        <span class="keyword">if</span> (Physics.Raycast(Camera.main.ScreenPointToRay(mouseScreenPosition), <span class="keyword">out</span> hit, <span class="number">1000</span>f, <span class="number">1</span> &lt;&lt; <span class="number">10</span>))</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//Change the position of the circle to the position</span></div><div class="line">            <span class="comment">//where the ray hit the ground</span></div><div class="line">            circleObj.transform.position = hit.point;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//Change size of projector radius</span></div><div class="line">        <span class="keyword">float</span> projectorSize = projector.orthographicSize;</div><div class="line"></div><div class="line">        <span class="comment">//Increase/decrease with p and m keys</span></div><div class="line">        <span class="keyword">if</span> (Input.GetKey(KeyCode.P))</div><div class="line">        &#123;</div><div class="line">            projectorSize += <span class="number">0.5</span>f;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">Input.GetKey(KeyCode.M</span>))</span></div><div class="line">        &#123;</div><div class="line">            projectorSize -= <span class="number">0.5</span>f;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//Make sure it can't grow too big nor too small</span></div><div class="line">        projector.orthographicSize = Mathf.Clamp(projectorSize, projectorMin, projectorMax);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Add the script to “_Controller” gameobject and add both the “Circle” gameobject and the projector to the script. The basic idea of the script is to fire a ray from wherever the mouse is towards the ground and then position the circle where the ray hit the ground. To make this work the ray has to ignore everything else except the ground. So click on the “Ground” gameobject and make sure it is at layer 10 (We check that when we fire a ray by using the parameter “1 &lt;&lt; 10”) and give the layer a cool name like Ground.</p>
<p>The last part of the script above takes care of resizing the circle so we can remove trees over a larger area and add trees over a smaller area. If you now click play you should see something that looks like this (ignore the “Tree parent” and the “Tree combined” gameobjects because we will soon add them):</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/setup-scene-finished.png" alt="How the scene should look like when you are finished"></p>
<p>Now let’s learn how to combine meshes with different colors into one mesh!</p>
<h2 id="Combine-meshes-with-different-colors"><a href="#Combine-meshes-with-different-colors" class="headerlink" title="Combine meshes with different colors"></a>Combine meshes with different colors</h2><p>This part of the tutorial is independent of the rest of the tutorial, so you can safely ignore it if you want to. The reason that I included it is that in Unity’s example on how to combine meshes (found <a href="http://docs.unity3d.com/ScriptReference/Mesh.CombineMeshes.html" target="_blank" rel="external">here</a>) it is assumed that all meshes have the same color. But what are you supposed to do if they have different colors? So in this part of the tutorial you will learn how to combine meshes with different colors into one mesh.</p>
<p>First of all we need more trees, so copy the tree you created in the last part three times. Then press play, click on the “Stats” button while in Game view, and notice the amount of “Batches.” In my case we have 22 batches, and this is the number we want to decrease by using mesh combining.</p>
<p>First of all we need a game object that will hold the combined mesh, so create a new game object and name it “Tree combined multicolor.” To that game object you have to add a Mesh Renderer and a Mesh Filter. In the Mesh Renderer, set the material size to “2” and first add the “Leaf” material and then the “Wood” material you created in the previous part.</p>
<p>Create a new script called “TutorialCombineAll” and add it to the “_Controller” game object. Add the following to the script:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"></div><div class="line"><span class="comment">//Combine trees with different materials into one mesh</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TutorialCombineAll</span> : <span class="title">MonoBehaviour</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//Array with trees we are going to combine</span></div><div class="line">    <span class="keyword">public</span> GameObject[] treesArray;</div><div class="line">    <span class="comment">//The object that is going to hold the combined mesh</span></div><div class="line">    <span class="keyword">public</span> GameObject combinedObj;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>) </span></div><div class="line">    &#123;</div><div class="line">        CombineTrees();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//Similar to Unity's reference, but with different materials</span></div><div class="line">    <span class="comment">//http://docs.unity3d.com/ScriptReference/Mesh.CombineMeshes.html</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">CombineTrees</span>(<span class="params"></span>) </span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//Lists that holds mesh data that belongs to each submesh</span></div><div class="line">        List&lt;CombineInstance&gt; woodList = <span class="keyword">new</span> List&lt;CombineInstance&gt;();</div><div class="line">        List&lt;CombineInstance&gt; leafList = <span class="keyword">new</span> List&lt;CombineInstance&gt;();</div><div class="line">        </div><div class="line">        <span class="comment">//Loop through the array with trees</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; treesArray.Length; i++)</div><div class="line">        &#123;</div><div class="line">            GameObject currentTree = treesArray[i];</div><div class="line"></div><div class="line">            <span class="comment">//Deactivate the tree </span></div><div class="line">            currentTree.SetActive(<span class="literal">false</span>);</div><div class="line"></div><div class="line">            <span class="comment">//Get all meshfilters from this tree, true to also find deactivated children</span></div><div class="line">            MeshFilter[] meshFilters = currentTree.GetComponentsInChildren&lt;MeshFilter&gt;(<span class="literal">true</span>);</div><div class="line"></div><div class="line">            <span class="comment">//Loop through all children</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; meshFilters.Length; j++)</div><div class="line">            &#123;</div><div class="line">                MeshFilter meshFilter = meshFilters[j];</div><div class="line"></div><div class="line">                CombineInstance combine = <span class="keyword">new</span> CombineInstance();</div><div class="line"></div><div class="line">                <span class="comment">//Is it wood or leaf?</span></div><div class="line">                MeshRenderer meshRender = meshFilter.GetComponent&lt;MeshRenderer&gt;();</div><div class="line"></div><div class="line">                <span class="comment">//Modify the material name, because Unity adds (Instance) to the end of the name</span></div><div class="line">                <span class="keyword">string</span> materialName = meshRender.material.name.Replace(<span class="string">" (Instance)"</span>, <span class="string">""</span>);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (materialName == <span class="string">"Leaf"</span>)</div><div class="line">                &#123;</div><div class="line">                    combine.mesh = meshFilter.mesh;</div><div class="line">                    combine.transform = meshFilter.transform.localToWorldMatrix;</div><div class="line"></div><div class="line">                    <span class="comment">//Add it to the list of leaf mesh data</span></div><div class="line">                    leafList.Add(combine);</div><div class="line">                &#125;</div><div class="line">                <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">materialName == <span class="string">"Wood"</span></span>)</span></div><div class="line">                &#123;</div><div class="line">                    combine.mesh = meshFilter.mesh;</div><div class="line">                    combine.transform = meshFilter.transform.localToWorldMatrix;</div><div class="line"></div><div class="line">                    <span class="comment">//Add it to the list of wood mesh data</span></div><div class="line">                    woodList.Add(combine);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">//First we need to combine the wood into one mesh and then the leaf into one mesh</span></div><div class="line">        Mesh combinedWoodMesh = <span class="keyword">new</span> Mesh();</div><div class="line">        combinedWoodMesh.CombineMeshes(woodList.ToArray());</div><div class="line"></div><div class="line">        Mesh combinedLeafMesh = <span class="keyword">new</span> Mesh();</div><div class="line">        combinedLeafMesh.CombineMeshes(leafList.ToArray());</div><div class="line"></div><div class="line">        <span class="comment">//Create the array that will form the combined mesh</span></div><div class="line">        CombineInstance[] totalMesh = <span class="keyword">new</span> CombineInstance[<span class="number">2</span>];</div><div class="line"></div><div class="line">        <span class="comment">//Add the submeshes in the same order as the material is set in the combined mesh</span></div><div class="line">        totalMesh[<span class="number">0</span>].mesh = combinedLeafMesh;</div><div class="line">        totalMesh[<span class="number">0</span>].transform = combinedObj.transform.localToWorldMatrix;</div><div class="line">        totalMesh[<span class="number">1</span>].mesh = combinedWoodMesh;</div><div class="line">        totalMesh[<span class="number">1</span>].transform = combinedObj.transform.localToWorldMatrix;</div><div class="line"></div><div class="line">        <span class="comment">//Create the final combined mesh</span></div><div class="line">        Mesh combinedAllMesh = <span class="keyword">new</span> Mesh();</div><div class="line"></div><div class="line">        <span class="comment">//Make sure it's set to false to get 2 separate meshes</span></div><div class="line">        combinedAllMesh.CombineMeshes(totalMesh, <span class="literal">false</span>);</div><div class="line">        combinedObj.GetComponent&lt;MeshFilter&gt;().mesh = combinedAllMesh;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>What’s different in the script above compared with Unity’s example is that we first combine all Wood into one mesh and all Leaf into another mesh. When we have these two different meshes, we can combine them into one mesh. It is important that you add them in the same order as you added the materials in the Mesh Renderer. And that’s the secret behind combining meshes with different colors into one mesh.</p>
<p>Add the trees and the game object “Tree combined multicolor” to the script. If you now press play you should see the following:</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/multicolor-trees-combined.png" alt="Trees with different colors combined into one mesh in Unity"></p>
<p>…and if you click the Stats button you should see that the number of batches have decreased from 22 to 18. It might not sound like much, but when we have thousands of trees, like we will have in the next part of the tutorial, you will notice a dramatic difference. So head to the next part of the tutorial!</p>
<h2 id="Combine-trees-into-larger-meshes"><a href="#Combine-trees-into-larger-meshes" class="headerlink" title="Combine trees into larger meshes"></a>Combine trees into larger meshes</h2><p>In this section you will learn how to create a random forest and how to combine the trees into larger meshes to increase the performance.</p>
<h3 id="Part-1-Create-a-forest"><a href="#Part-1-Create-a-forest" class="headerlink" title="Part 1. Create a forest"></a>Part 1. Create a forest</h3><p>Begin by removing the trees you added in the last tutorial (but keep the prefap Tree). Then create two new game objects and add a Mesh Renderer and a Mesh Filter to them. Rename them “Tree combined wood” and “Tree combined leaf” and add materials to them. These objects will hold the combined tree meshes. To get a cleaner work space, create a new game object called “Tree parent” and as a child to this object, create 2 new game objects called “Individual trees” and “Combined parent.” So we will parent all individual trees to the parent “Individual trees” because we have to save them after creating the combined tree mesh so we can remove them later on from the combined mesh.</p>
<p>Now create a script called “TutorialCreateForest” and add it to the “_Controller” game object. Deactivate the “TutorialCombineAll” script if you haven’t already done so (the script we created in the last part). Then add the following to the new script:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TutorialCreateForest</span> : <span class="title">MonoBehaviour</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TutorialCreateForest current;</div><div class="line"></div><div class="line">    <span class="comment">//Drags</span></div><div class="line">    <span class="comment">//The main tree</span></div><div class="line">    <span class="keyword">public</span> GameObject treeObj;</div><div class="line">    <span class="comment">//What we are going to parent everything to, to get a clean workspace</span></div><div class="line">    <span class="keyword">public</span> Transform individualTreeParent;</div><div class="line">    <span class="keyword">public</span> Transform combinedMeshParent;</div><div class="line">    <span class="comment">//The combined meshes</span></div><div class="line">    <span class="keyword">public</span> GameObject combinedWoodObj;</div><div class="line">    <span class="keyword">public</span> GameObject combinedLeafObj;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//How many vertices per combined mesh (max 65535)</span></div><div class="line">    <span class="comment">//Should sometimes be smaller because smaller meshes are faster to modify</span></div><div class="line">    [System.NonSerialized]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> vertexLimit = <span class="number">30000</span>;</div><div class="line"></div><div class="line">    <span class="comment">//Lists to make it easier to remove/add trees from/to combined meshes</span></div><div class="line">    <span class="comment">//Will contain references to all combined meshes</span></div><div class="line">    [System.NonSerialized]</div><div class="line">    <span class="keyword">public</span> List&lt;GameObject&gt; combinedWoodList = <span class="keyword">new</span> List&lt;GameObject&gt;();</div><div class="line">    [System.NonSerialized]</div><div class="line">    <span class="keyword">public</span> List&lt;GameObject&gt; combinedLeafList = <span class="keyword">new</span> List&lt;GameObject&gt;();</div><div class="line"></div><div class="line">    <span class="comment">//We also need a list of all trees we created before combining them</span></div><div class="line">    <span class="comment">//to make it easier to remove them from the combined meshes</span></div><div class="line">    [System.NonSerialized]</div><div class="line">    <span class="keyword">public</span> List&lt;GameObject&gt; allTrees = <span class="keyword">new</span> List&lt;GameObject&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        current = <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>) </span></div><div class="line">    &#123;</div><div class="line">        CreateForest();</div><div class="line">        <span class="comment">//CombineTrees();</span></div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">//Creates a random forest</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">CreateForest</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//Generate random map coordinates</span></div><div class="line">            <span class="keyword">float</span> halfMapSize = <span class="number">300</span>f;</div><div class="line"></div><div class="line">            <span class="keyword">float</span> x = Random.Range(-halfMapSize, halfMapSize);</div><div class="line">            <span class="keyword">float</span> z = Random.Range(-halfMapSize, halfMapSize);</div><div class="line"></div><div class="line">            Vector3 treePos = <span class="keyword">new</span> Vector3(x, <span class="number">0</span>f, z);</div><div class="line"></div><div class="line">            <span class="comment">//Create a tree</span></div><div class="line">            GameObject newTree = Instantiate(treeObj, treePos, Quaternion.identity) <span class="keyword">as</span> GameObject;</div><div class="line"></div><div class="line">            <span class="comment">//Parent it to get a clean workspace</span></div><div class="line">            newTree.transform.parent = individualTreeParent;</div><div class="line"></div><div class="line">            <span class="comment">//Add it to the list of trees</span></div><div class="line">            allTrees.Add(newTree);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Add everything needed to the script and press Play. If you click to display the Stats window and if you zoom out, you should see that the number of batches has grown to almost 4000:</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/forest-before-combined-meshes.png" alt="The number of batches before we combine the trees"></p>
<h3 id="Part-2-Combine-the-meshes"><a href="#Part-2-Combine-the-meshes" class="headerlink" title="Part 2. Combine the meshes"></a>Part 2. Combine the meshes</h3><p>Let’s reduce the number of batches. So add the method “CombineTrees()” to the script:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Combines the trees in the forest into combined meshes</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CombineTrees</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//Lists needed to create the combined meshes of each type</span></div><div class="line">	List&lt;CombineInstance&gt; woodList = <span class="keyword">new</span> List&lt;CombineInstance&gt;();</div><div class="line">	List&lt;CombineInstance&gt; leafList = <span class="keyword">new</span> List&lt;CombineInstance&gt;();</div><div class="line"></div><div class="line">	<span class="comment">//Used in the loop, but better to create it here</span></div><div class="line">	CombineInstance combine = <span class="keyword">new</span> CombineInstance();</div><div class="line"></div><div class="line">	<span class="comment">//Keep track of the vertices in the list so we know when we have reached the limit</span></div><div class="line">	<span class="keyword">int</span> verticesSoFar = <span class="number">0</span>;</div><div class="line">	<span class="comment">//Keep track of which gameobject the mesh has been combined into</span></div><div class="line">	<span class="keyword">int</span> meshListCounter = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="comment">//Loop through all trees</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; allTrees.Count; i++)</div><div class="line">	&#123;</div><div class="line">		allTrees[i].SetActive(<span class="literal">false</span>);</div><div class="line"></div><div class="line">		<span class="comment">//Add to which list och combined meshes this tree belongs</span></div><div class="line">		allTrees[i].GetComponent&lt;TreeData&gt;().listPos = meshListCounter;</div><div class="line"></div><div class="line">		<span class="comment">//Get all children</span></div><div class="line">		MeshFilter[] meshFilters = allTrees[i].GetComponentsInChildren&lt;MeshFilter&gt;(<span class="literal">true</span>);</div><div class="line"></div><div class="line">		<span class="comment">//Loop through all children and add them to respective list</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; meshFilters.Length; j++)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">//We need to get both the mesh's mesh renderer and mesh filter</span></div><div class="line">			MeshFilter meshFilter = meshFilters[j];</div><div class="line"></div><div class="line">			<span class="comment">//To find out if this is mesh is a wood or a leaf we need the name of the material</span></div><div class="line">			<span class="comment">//Modify the material name, because Unity adds (Instance) to the end of the name</span></div><div class="line">			<span class="keyword">string</span> materialName = meshFilter.GetComponent&lt;MeshRenderer&gt;().material.name.Replace(<span class="string">" (Instance)"</span>, <span class="string">""</span>);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (materialName == <span class="string">"Leaf"</span>)</div><div class="line">			&#123;</div><div class="line">				combine.mesh = meshFilter.mesh;</div><div class="line">				combine.transform = meshFilter.transform.localToWorldMatrix;</div><div class="line"></div><div class="line">				<span class="comment">//Add it to the list of leaf mesh data</span></div><div class="line">				leafList.Add(combine);</div><div class="line"></div><div class="line">				<span class="comment">//The leafs have more vertices, so we need to keep track of them</span></div><div class="line">				verticesSoFar += meshFilter.mesh.vertexCount;</div><div class="line">			&#125;</div><div class="line">			<span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">materialName == <span class="string">"Wood"</span></span>)</span></div><div class="line">			&#123;</div><div class="line">				combine.mesh = meshFilter.mesh;</div><div class="line">				combine.transform = meshFilter.transform.localToWorldMatrix;</div><div class="line"></div><div class="line">				<span class="comment">//Add it to the list of wood mesh data</span></div><div class="line">				woodList.Add(combine);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//Have we reached the limit?</span></div><div class="line">		<span class="keyword">if</span> (verticesSoFar &gt; vertexLimit)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">//If so we have added to many vertices, so we undo the last step</span></div><div class="line">			i -= <span class="number">1</span>;</div><div class="line"></div><div class="line">			<span class="comment">//And remove the last mesh we added to the lists</span></div><div class="line">			leafList.RemoveAt(leafList.Count - <span class="number">1</span>);</div><div class="line">			woodList.RemoveAt(woodList.Count - <span class="number">1</span>);</div><div class="line"></div><div class="line">			<span class="comment">//Now we can create a combined mesh of the meshes we have collected so far</span></div><div class="line">			CreateCombinedMesh(woodList, combinedWoodObj, combinedWoodList);</div><div class="line">			CreateCombinedMesh(leafList, combinedLeafObj, combinedLeafList);</div><div class="line"></div><div class="line">			<span class="comment">//Reset the lists with mesh data</span></div><div class="line">			leafList.Clear();</div><div class="line">			woodList.Clear();</div><div class="line"></div><div class="line">			verticesSoFar = <span class="number">0</span>;</div><div class="line"></div><div class="line">			<span class="comment">//Change how many combined meshes we have generated so far</span></div><div class="line">			meshListCounter += <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//When the main loop is finished we have to add what didnt reach the vertice limit</span></div><div class="line">	CreateCombinedMesh(woodList, combinedWoodObj, combinedWoodList);</div><div class="line">	CreateCombinedMesh(leafList, combinedLeafObj, combinedLeafList);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//Creates a combined mesh from a list and adds it to a game object</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CreateCombinedMesh</span>(<span class="params">List&lt;CombineInstance&gt; meshDataList, GameObject meshHolderObj, List&lt;GameObject&gt; combinedHolderList</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//Create the new combined mesh</span></div><div class="line">	Mesh newMesh = <span class="keyword">new</span> Mesh();</div><div class="line">	newMesh.CombineMeshes(meshDataList.ToArray());</div><div class="line"></div><div class="line">	<span class="comment">//Create new game object that will hold the combined mesh</span></div><div class="line">	GameObject combinedMeshHolder = Instantiate(meshHolderObj, Vector3.zero, Quaternion.identity) <span class="keyword">as</span> GameObject;</div><div class="line"></div><div class="line">	combinedMeshHolder.transform.parent = combinedMeshParent;</div><div class="line"></div><div class="line">	<span class="comment">//Add the mesh</span></div><div class="line">	combinedMeshHolder.GetComponent&lt;MeshFilter&gt;().mesh = newMesh;</div><div class="line"></div><div class="line">	<span class="comment">//Add the combined holder to the list</span></div><div class="line">	combinedHolderList.Add(combinedMeshHolder);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The basic idea is that we loop through all trees we created and combine them into meshes. The problem is that the limit of one mesh is 65535 vertices (a vertice is like a corner in the mesh), so when we have reached that limit we need to create a new combined mesh and begin all over again. I’ve also decided to lower the limit from 65535 to 30000. The reason is that when we begin to add and remove trees, it will be much faster to search through the combined mesh if we have fewer trees combined into one mesh. But if you are not going to remove or add something to the mesh, you can safely leave the limit at 65535.</p>
<p>To be able to easier add and remove trees, we also need to know which combined mesh the individual tree has been combined into. So we have to save the list number in a script called “TreeData.” So create such a script, add it to the Tree prefab, and add the following:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"></div><div class="line"><span class="comment">//Holds data about a tree</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TreeData</span> : <span class="title">MonoBehaviour</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> listPos;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//-1 means not in any list at all</span></div><div class="line">        listPos = <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>I’ve also been lazy by assuming that the wood part of the tree and the leaf part of the tree have the same amount of vertices. But in reality the cylinder has fewer vertices than a sphere. So if you want to squeeze out every inch of performance out of your game, you should not change to a new combined wood mesh when the combined mesh that holds the leafs is full, because you can fit more cylinders in one combined mesh than what you can fit spheres. But to get a cleaner code, I’ve decided to ignore that fact.</p>
<p>If you now press Play and zoom out you should be able to see that the number of batches have decreased from 4000 to 200:</p>
<p><img src="https://raw.githubusercontent.com/tospan/tospan.github.io/source/source/_images/unity/forest-after-combined-meshes.png" alt="The number of batches after we combine the trees"></p>
<p>Now let’s move on and learn how to add and remove trees. It might sound easy, but it will be complicated, so take a break before you begin!</p>
<h2 id="Add-and-remove-trees-from-the-combined-meshes"><a href="#Add-and-remove-trees-from-the-combined-meshes" class="headerlink" title="Add and remove trees from the combined meshes"></a>Add and remove trees from the combined meshes</h2><p>In this part of the tutorial you will learn how to add and remove meshes from combined meshes.</p>
<h3 id="Part-1-How-do-you-modify-a-combined-mesh"><a href="#Part-1-How-do-you-modify-a-combined-mesh" class="headerlink" title="Part 1. How do you modify a combined mesh?"></a>Part 1. How do you modify a combined mesh?</h3><p>Adding and removing trees is easy if we are not dealing with combined meshes. It is not difficult to remove a mesh from a combined mesh and it is not difficult to add a mesh to a combined mesh. But there’s a Swedish expression saying that you “need to have your tongue at the correct position in your mouth,” meaning it’s easy to get lost among the arrays and vertices we are going to use if you are not focusing.</p>
<p>Before we begin with the adding and removing of trees we have to learn how to identify a tree mesh in a combined mesh (I’m saying “tree,” but I’m meaning the tree’s wood mesh and leaf mesh). We can easily identify in which mesh a tree has been combined, because we have saved that list position. But how do we identify the tree mesh in the combined mesh? The answer is that we have to search through all vertices of the combined mesh and see when a vertice matches a vertice in a single tree. This will only work if no trees have the same position, which we here assume they don’t have.</p>
<p>So create a new script called “ModifyMesh” and add the following:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ModifyMesh</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">float</span> tolerance = <span class="number">0.0001</span>f;</div><div class="line">  </div><div class="line">    <span class="comment">//Removes a mesh from another mesh that contains the same mesh (at the same position) </span></div><div class="line">    <span class="comment">//but also other meshes at other positions</span></div><div class="line">    <span class="comment">//Can add the parameter moveVec if we know we have moved the mesh we want to remove a certain distance</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveVerticesFromMesh</span>(<span class="params">Transform currentObject, Transform objectToRemove, Vector3 moveVec = <span class="keyword">default</span>(Vector3</span>))</span></div><div class="line">    &#123;</div><div class="line">        MeshFilter currentMeshFilter = currentObject.GetComponent&lt;MeshFilter&gt;();</div><div class="line">        </div><div class="line">        <span class="comment">//The vertices and triangles belonging to the mesh we are going to modify</span></div><div class="line">        <span class="comment">//From array to list so we can modify them - Requires "using System.Linq;" </span></div><div class="line">        List&lt;Vector3&gt; currentVertices = currentMeshFilter.mesh.vertices.ToList&lt;Vector3&gt;();</div><div class="line">        </div><div class="line">        List&lt;<span class="keyword">int</span>&gt; currentTriangles = currentMeshFilter.mesh.triangles.ToList&lt;<span class="keyword">int</span>&gt;();</div><div class="line"></div><div class="line">        <span class="comment">//The vertices we are going to remove from the mesh</span></div><div class="line">        Mesh objectToRemoveMesh = objectToRemove.GetComponent&lt;MeshFilter&gt;().mesh;</div><div class="line"></div><div class="line">        Vector3[] verticesToRemove = objectToRemoveMesh.vertices;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> nrOfVerticesToRemove = verticesToRemove.Length;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">//First find the position where we should begin to remove vertices</span></div><div class="line">        <span class="keyword">int</span> minVerticePos = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="comment">//From local to global</span></div><div class="line">        Vector3 firstVertPosToRemove = objectToRemove.transform.TransformPoint(verticesToRemove[<span class="number">0</span>]);</div><div class="line"></div><div class="line">        <span class="comment">//From global to local of the combined mesh or we have to do do it each time in the loop, which is slower</span></div><div class="line">        firstVertPosToRemove = currentObject.InverseTransformPoint(firstVertPosToRemove) + moveVec;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; currentVertices.Count; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//We now know where the mesh we want to remove begins in the combined mesh</span></div><div class="line">            <span class="comment">//if (currentVertices[i] == firstVertPosToRemove)</span></div><div class="line">            <span class="comment">//The above is sometimes not working because of rounding errors, so use a tolerance</span></div><div class="line">            <span class="keyword">if</span> ((currentVertices[i] - firstVertPosToRemove).sqrMagnitude &lt; tolerance)</div><div class="line">            &#123;</div><div class="line">                minVerticePos = i;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//Remove the vertices that we dont need</span></div><div class="line">        currentVertices.RemoveRange(minVerticePos, nrOfVerticesToRemove);</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">//Change the number of the triangles by first finding the position where </span></div><div class="line">        <span class="comment">//we should begin to remove triangles, while at the same time shifting</span></div><div class="line">        <span class="comment">//the triangles that comes after the ones we are removing, so they point</span></div><div class="line">        <span class="comment">//at the correct vertices</span></div><div class="line">        <span class="keyword">int</span> minTrianglePos = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">bool</span> hasFoundStart = <span class="literal">false</span>;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> firstTrianglePos = objectToRemoveMesh.triangles[<span class="number">0</span>] + minVerticePos;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> upperLimit = minVerticePos + nrOfVerticesToRemove;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; currentTriangles.Count; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">int</span> currentTrianglePos = currentTriangles[i];</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (currentTrianglePos == firstTrianglePos &amp;&amp; !hasFoundStart)</div><div class="line">            &#123;</div><div class="line">                hasFoundStart = <span class="literal">true</span>;</div><div class="line">                minTrianglePos = i;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//Change which vertices the triangles are being built from</span></div><div class="line">            <span class="comment">//We only need to shift the triangles that come after the triangles we remove</span></div><div class="line">            <span class="keyword">if</span> (currentTrianglePos &gt;= upperLimit)</div><div class="line">            &#123;</div><div class="line">                currentTriangles[i] = currentTrianglePos - nrOfVerticesToRemove;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//Remove the triangles we dont need</span></div><div class="line">        currentTriangles.RemoveRange(minTrianglePos, objectToRemoveMesh.triangles.Length);</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">//Now we can create the new mesh</span></div><div class="line">        <span class="comment">//Important to clear or create a new mesh it will complain about the triangles</span></div><div class="line">        <span class="comment">//being the wrong size even though they arent</span></div><div class="line">        currentMeshFilter.mesh.Clear();</div><div class="line"></div><div class="line">        currentMeshFilter.mesh.vertices = currentVertices.ToArray();</div><div class="line">        currentMeshFilter.mesh.triangles = currentTriangles.ToArray();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>When we are searching through the vertices that belongs to the combined mesh and trying to match coordinates with the mesh that belongs to the tree, the problem is that because of rounding errors, these coordinates will not always match 100 percent. So instead we have to use a tolerance, which I’ve assumed to be 0.0001. That means that if the coordinate in the combined mesh matches the coordinate in the tree mesh, then we assume we have found the tree in the combined mesh.</p>
<p>Next step is removing the vertices that belongs to the tree from the combined mesh. That’s easy because we now know where the tree’s vertices begins in the long list of vertices and how many vertices a single tree has. But a mesh also consists of a long list of triangles that are building up the final mesh, so we have to modify that list as well. But that’s easy because we know the position of the first vertice we are going to remove, and then we have to modify all triangles that come after the mesh we have removed so they point at the vertices that are still there. Then we just add the new vertices and triangles to the combined mesh.</p>
<p>The problem is that the above is slow. If we are going to remove many trees at the same time, we have to cheat by hiding the trees below the ground. So add the following method to “ModifyMesh”:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Moves a mesh away from another mesh that contains the same mesh (at the same position) </span></div><div class="line"><span class="comment">//but also other meshes at other positions</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MoveVerticesOutOfTheWay</span>(<span class="params">Transform currentObject, Transform objectToRemove, Vector3 moveVec</span>)</span></div><div class="line">&#123;</div><div class="line">	MeshFilter currentMeshFilter = currentObject.GetComponent&lt;MeshFilter&gt;();</div><div class="line"></div><div class="line">	<span class="comment">//The vertices belonging to the mesh we are going to modify</span></div><div class="line">	Vector3[] currentVertices = currentMeshFilter.mesh.vertices;</div><div class="line"></div><div class="line">	<span class="comment">//The vertices we are going to move</span></div><div class="line">	Vector3[] verticesToRemove = objectToRemove.GetComponent&lt;MeshFilter&gt;().mesh.vertices;</div><div class="line"></div><div class="line">	<span class="comment">//Find the position of the first vertice we are going to remove, but in local pos of the mesh</span></div><div class="line">	<span class="comment">//we are going to remove it from</span></div><div class="line">	<span class="comment">//From local to global</span></div><div class="line">	Vector3 firstVertPosToRemove = objectToRemove.transform.TransformPoint(verticesToRemove[<span class="number">0</span>]);</div><div class="line">	<span class="comment">//From global to local of the combined mesh</span></div><div class="line">	firstVertPosToRemove = currentObject.InverseTransformPoint(firstVertPosToRemove);</div><div class="line">   </div><div class="line">	<span class="comment">//Find the first vertice in the combined mesh</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; currentVertices.Length; i++)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//We now know where the mesh we want to move begins</span></div><div class="line">		<span class="comment">//if (currentVertices[i] == firstVertPosToRemove)</span></div><div class="line">		<span class="comment">//The above is sometimes not working because of rounding errors, so use a tolerance</span></div><div class="line">		<span class="keyword">if</span> ((currentVertices[i] - firstVertPosToRemove).sqrMagnitude &lt; tolerance)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">//Move the vertices</span></div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; verticesToRemove.Length; j++)</div><div class="line">			&#123;</div><div class="line">				currentVertices[i + j] += moveVec;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//Add the modified vertices to the combined mesh</span></div><div class="line">	currentMeshFilter.mesh.vertices = currentVertices;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The above method is similar to the method that removes a mesh from a combined mesh. The difference is that we are just moodifying the vertices by moving them with a certain distance determined by a vector. It will make the code much faster.</p>
<h3 id="Part-2-Remove-trees"><a href="#Part-2-Remove-trees" class="headerlink" title="Part 2. Remove trees"></a>Part 2. Remove trees</h3><p>With the above in mind, you may understand that to be able to remove a tree, we first have to hide all trees we want to remove in one frame and then remove the hidden trees over several frames. So create a script called “TutorialAddRemoveTrees” and add the following (it will include some code we need to add trees, but it’s less messy to add everything at the same time):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> UnityEngine;</div><div class="line"><span class="keyword">using</span> System.Collections;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TutorialAddRemoveTrees</span> : <span class="title">MonoBehaviour</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//Used in the coroutine to set if we should add new trees</span></div><div class="line">    <span class="keyword">bool</span> shouldAddTrees = <span class="literal">false</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//Slow to add trees to combined meshes, so spread out over several frames</span></div><div class="line">    List&lt;GameObject&gt;waitingListAddTree = <span class="keyword">new</span> List&lt;GameObject&gt;();</div><div class="line">    <span class="comment">//If we want to remove the trees completely, and not just hide them</span></div><div class="line">    List&lt;GameObject&gt; waitingListRemoveTree = <span class="keyword">new</span> List&lt;GameObject&gt;();</div><div class="line"></div><div class="line">    <span class="comment">//How far away should we move a tree that has been removed?</span></div><div class="line">    Vector3 moveVec = <span class="keyword">new</span> Vector3(<span class="number">0</span>f, <span class="number">-40</span>f, <span class="number">0</span>f);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>) </span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//Add trees when pressing mouse button</span></div><div class="line">        StartCoroutine(<span class="string">"AddNewTrees"</span>);</div><div class="line">        <span class="comment">//Add recently instantiated trees to a combined mesh</span></div><div class="line">        <span class="comment">//or remove trees from combined mesh</span></div><div class="line">        StartCoroutine(<span class="string">"AddRemoveTreesToFromCombinedMesh"</span>);</div><div class="line">    &#125;</div><div class="line">		</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>) </span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//Remove trees with right mouse button</span></div><div class="line">        <span class="keyword">if</span> (Input.GetMouseButton(<span class="number">1</span>))</div><div class="line">        &#123;</div><div class="line">            RemoveTrees();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//Add trees with left mouse button</span></div><div class="line">        <span class="keyword">if</span> (Input.GetMouseButton(<span class="number">0</span>))</div><div class="line">        &#123;</div><div class="line">            shouldAddTrees = <span class="literal">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//Add/remove trees in the waiting list to/from a combined mesh</span></div><div class="line">    <span class="function">IEnumerator <span class="title">AddRemoveTreesToFromCombinedMesh</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//Add tree to combined mesh</span></div><div class="line">            <span class="keyword">if</span> (waitingListAddTree.Count &gt; <span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                AddTreeToCombinedMesh(waitingListAddTree[<span class="number">0</span>]);</div><div class="line"></div><div class="line">                waitingListAddTree.RemoveAt(<span class="number">0</span>);</div><div class="line"></div><div class="line">                <span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">0.1</span>f</span>)</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="comment">//Remove tree from combined mesh</span></div><div class="line">            <span class="keyword">if</span> (waitingListRemoveTree.Count &gt; <span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                RemoveTreeCompletely(waitingListRemoveTree[<span class="number">0</span>]);</div><div class="line"></div><div class="line">                <span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">0.1</span>f</span>)</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;    </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We are later on going to add trees with a coroutine, and the idea will then be similar to when we remove trees, but more of that later. What you will see is that we have waiting lists we are going to fill with trees that we are going to remove (and are now hidden) and trees we are going to combine into combined meshes, but have now just been instantiated, which is faster.</p>
<p>To be able to remove trees you will need the following methods:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Remove trees within the radius of the circle</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">RemoveTrees</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//The current cicle radius</span></div><div class="line">	<span class="keyword">float</span> radius = TutorialMouseMarker.current.projector.orthographicSize;</div><div class="line"></div><div class="line">	<span class="comment">//All trees we have in our forest</span></div><div class="line">	List&lt;GameObject&gt; allTrees = TutorialCreateForest.current.allTrees;</div><div class="line">	</div><div class="line">	<span class="comment">//Position of the mouse</span></div><div class="line">	Vector3 mousePos = TutorialMouseMarker.current.circleObj.transform.position;</div><div class="line">	<span class="comment">//Make sure we operate in 2d space</span></div><div class="line">	mousePos.y = <span class="number">0</span>f;</div><div class="line">	</div><div class="line">	<span class="comment">//Loop through all trees</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; allTrees.Count; i++)</div><div class="line">	&#123;</div><div class="line">		GameObject currentTree = allTrees[i];</div><div class="line"></div><div class="line">		Vector3 treePos = currentTree.transform.position;</div><div class="line">		<span class="comment">//Make sure we operate in 2d space</span></div><div class="line">		treePos.y = <span class="number">0</span>f;</div><div class="line"></div><div class="line">		<span class="comment">//The distance Sqr between the tree and the center of the mouse</span></div><div class="line">		<span class="comment">//Remember that sqr is faster than sqrt!</span></div><div class="line">		<span class="keyword">float</span> distSqr = (treePos - mousePos).sqrMagnitude;</div><div class="line"></div><div class="line">		<span class="comment">//If the tree is within the circle radius</span></div><div class="line">		<span class="keyword">if</span>(distSqr &lt; radius * radius)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">//Remove the tree from our list with trees so we are not selecting it again</span></div><div class="line">			TutorialCreateForest.current.allTrees.Remove(currentTree);</div><div class="line">			<span class="comment">//Also remove the tree from the waiting list if it is waiting to be added to a combined mesh</span></div><div class="line">			waitingListAddTree.Remove(currentTree);</div><div class="line">			<span class="comment">//But add it to the list with trees we want to remove completely</span></div><div class="line">			waitingListRemoveTree.Add(currentTree);</div><div class="line">			<span class="comment">//Move the tree out of the way</span></div><div class="line">			MoveTree(currentTree);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Moves one tree so we cant see it anymore</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MoveTree</span>(<span class="params">GameObject currentTree</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//First get which list this tree is in</span></div><div class="line">	<span class="keyword">int</span> listPos = currentTree.GetComponent&lt;TreeData&gt;().listPos;</div><div class="line"></div><div class="line">	<span class="comment">//Does this tree belong to a list?</span></div><div class="line">	<span class="keyword">if</span> (listPos == <span class="number">-1</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//Just deactivate the tree if it doesnt belong to a list</span></div><div class="line">		currentTree.SetActive(<span class="literal">false</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//Tree belongs to a list, so we have to move the vertices in the combined mesh</span></div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">//Get the combined object in which this tree is a part of</span></div><div class="line">		GameObject combinedObjWood = TutorialCreateForest.current.combinedWoodList[listPos];</div><div class="line">		GameObject combinedObjLeaf = TutorialCreateForest.current.combinedLeafList[listPos];</div><div class="line"></div><div class="line">		<span class="comment">//Find the wood and leaf meshes inside of this tree</span></div><div class="line">		Transform woodObj = <span class="literal">null</span>;</div><div class="line">		Transform leafObj = <span class="literal">null</span>;</div><div class="line"></div><div class="line">		GetWoodandLeaf(currentTree, <span class="keyword">out</span> woodObj, <span class="keyword">out</span> leafObj);</div><div class="line"></div><div class="line">		<span class="comment">//Move it</span></div><div class="line">		ModifyMesh.MoveVerticesOutOfTheWay(combinedObjWood.transform, woodObj, moveVec);</div><div class="line">		ModifyMesh.MoveVerticesOutOfTheWay(combinedObjLeaf.transform, leafObj, moveVec);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Removes one tree completely from the game</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">RemoveTreeCompletely</span>(<span class="params">GameObject currentTree</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//First get which list this tree is in</span></div><div class="line">	<span class="keyword">int</span> listPos = currentTree.GetComponent&lt;TreeData&gt;().listPos;</div><div class="line"></div><div class="line">	<span class="comment">//If the tree belongs to a list, remove it from the combined mesh</span></div><div class="line">	<span class="keyword">if</span> (listPos != <span class="number">-1</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//Get the combined object in which this tree is a part of</span></div><div class="line">		GameObject combinedObjWood = TutorialCreateForest.current.combinedWoodList[listPos];</div><div class="line">		GameObject combinedObjLeaf = TutorialCreateForest.current.combinedLeafList[listPos];</div><div class="line"></div><div class="line">		<span class="comment">//Find the wood and leaf meshes inside of this tree</span></div><div class="line">		Transform woodObj = <span class="literal">null</span>;</div><div class="line">		Transform leafObj = <span class="literal">null</span>;</div><div class="line"></div><div class="line">		GetWoodandLeaf(currentTree, <span class="keyword">out</span> woodObj, <span class="keyword">out</span> leafObj);</div><div class="line"></div><div class="line">		<span class="comment">//Remove the wood and leaf from the combined mesh</span></div><div class="line">		ModifyMesh.RemoveVerticesFromMesh(combinedObjWood.transform, woodObj, moveVec);</div><div class="line">		ModifyMesh.RemoveVerticesFromMesh(combinedObjLeaf.transform, leafObj, moveVec);</div><div class="line">		<span class="comment">//Also need to recalculate normals</span></div><div class="line">		combinedObjWood.GetComponent&lt;MeshFilter&gt;().mesh.RecalculateNormals();</div><div class="line">		combinedObjLeaf.GetComponent&lt;MeshFilter&gt;().mesh.RecalculateNormals();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//Remove the tree from the waiting list</span></div><div class="line">	waitingListRemoveTree.Remove(currentTree);</div><div class="line">	<span class="comment">//Destroy the tree</span></div><div class="line">	Destroy(currentTree);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>So when we hold the right mouse button, we search through the list of all single trees we have in our forest and check if they are within the radius of our Tree Brush tool. If so, we remove the tree from the list of all trees, we hide the tree below the ground, and then we add the tree to the waiting list so we can remove it completely later on.</p>
<p>We will also need this help method that will help us to get the child leaf and child wood transform from each individual tree:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Finds the tree's leaf and wood children</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetWoodandLeaf</span>(<span class="params">GameObject currentTree, <span class="keyword">out</span> Transform woodObj, <span class="keyword">out</span> Transform leafObj</span>)</span></div><div class="line">&#123;</div><div class="line">	woodObj = <span class="literal">null</span>;</div><div class="line">	leafObj = <span class="literal">null</span>;</div><div class="line"></div><div class="line">	<span class="comment">//Find the wood and leaf meshes inside of this tree</span></div><div class="line">	MeshFilter[] meshFilters = currentTree.GetComponentsInChildren&lt;MeshFilter&gt;(<span class="literal">true</span>);</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; meshFilters.Length; j++)</div><div class="line">	&#123;</div><div class="line">		MeshFilter meshFilter = meshFilters[j];</div><div class="line"></div><div class="line">		<span class="comment">//Is it wood or leaf?</span></div><div class="line">		<span class="comment">//Modify the material name, because Unity adds (Instance) to the end of the name</span></div><div class="line">		<span class="keyword">string</span> materialName = meshFilter.GetComponent&lt;MeshRenderer&gt;().material.name.Replace(<span class="string">" (Instance)"</span>, <span class="string">""</span>);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (materialName == <span class="string">"Leaf"</span>)</div><div class="line">		&#123;</div><div class="line">			leafObj = meshFilter.transform;</div><div class="line">		&#125;</div><div class="line">		<span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">materialName == <span class="string">"Wood"</span></span>)</span></div><div class="line">		&#123;</div><div class="line">			woodObj = meshFilter.transform;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Part-3-Add-trees"><a href="#Part-3-Add-trees" class="headerlink" title="Part 3. Add trees"></a>Part 3. Add trees</h3><p>Adding trees is similar to removing trees. As said before, we are going to cheat by just instantiating the trees, add them to a waiting list, and then add them to a combined mesh over several frames. So add the following to the script “TutorialAddRemoveTrees”:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Coroutine used to determine how often we should add a new tree</span></div><div class="line"><span class="comment">//when we press left mouse button</span></div><div class="line"><span class="function">IEnumerator <span class="title">AddNewTrees</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span> (shouldAddTrees)</div><div class="line">		&#123;</div><div class="line">			AddOneTree();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		shouldAddTrees = <span class="literal">false</span>;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">yield</span> return new <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">0.1</span>f</span>)</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Add one tree randomly within the circle and just instantiate it</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddOneTree</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//Find random coordinate within the circle</span></div><div class="line">	<span class="comment">//http://stackoverflow.com/questions/5837572/generate-a-random-point-within-a-circle-uniformly</span></div><div class="line">	<span class="keyword">float</span> a = Random.Range(<span class="number">0</span>f, <span class="number">1</span>f);</div><div class="line">	<span class="keyword">float</span> b = Random.Range(<span class="number">0</span>f, <span class="number">1</span>f);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (b &lt; a)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">float</span> a_temp = a;</div><div class="line">		a = b;</div><div class="line">		b = a_temp;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">float</span> R = TutorialMouseMarker.current.projector.orthographicSize;</div><div class="line"></div><div class="line">	<span class="keyword">float</span> xCoord = b * R * Mathf.Cos(<span class="number">2</span> * Mathf.PI * a / b);</div><div class="line">	<span class="keyword">float</span> zCoord = b * R * Mathf.Sin(<span class="number">2</span> * Mathf.PI * a / b);</div><div class="line"></div><div class="line">	<span class="comment">//Add a tree at the position of the mouse</span></div><div class="line">	Vector3 mousePos = TutorialMouseMarker.current.circleObj.transform.position;</div><div class="line">	mousePos.y = <span class="number">0</span>f;</div><div class="line">	Vector3 treePos = <span class="keyword">new</span> Vector3(xCoord, <span class="number">0</span>f, zCoord) + mousePos;</div><div class="line"></div><div class="line">	<span class="comment">//The tree we are going to add</span></div><div class="line">	GameObject treeObj = TutorialCreateForest.current.treeObj;</div><div class="line"></div><div class="line">	<span class="comment">//Make sure the tree is active</span></div><div class="line">	treeObj.SetActive(<span class="literal">true</span>);</div><div class="line"></div><div class="line">	GameObject newTree = Instantiate(treeObj, treePos, Quaternion.identity) <span class="keyword">as</span> GameObject;</div><div class="line">	</div><div class="line">	newTree.transform.parent = TutorialCreateForest.current.individualTreeParent;</div><div class="line"></div><div class="line">	<span class="comment">//Add the tree to the list of all trees so we can remove it</span></div><div class="line">	TutorialCreateForest.current.allTrees.Add(newTree);</div><div class="line"></div><div class="line">	<span class="comment">//Now we need to add this tree to a combined mesh, but this is slow, </span></div><div class="line">	<span class="comment">//so better spreading it out over several frames, so add it to a waiting list</span></div><div class="line">	waitingListAddTree.Add(newTree);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Adds one tree to a combined mesh</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddTreeToCombinedMesh</span>(<span class="params">GameObject newTree</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//Find the wood and leaf meshes inside of this tree</span></div><div class="line">	Transform woodObj = <span class="literal">null</span>;</div><div class="line">	Transform leafObj = <span class="literal">null</span>;</div><div class="line"></div><div class="line">	GetWoodandLeaf(newTree, <span class="keyword">out</span> woodObj, <span class="keyword">out</span> leafObj);</div><div class="line"></div><div class="line">	<span class="comment">//How many vertices has the leaf?</span></div><div class="line">	<span class="keyword">int</span> leafVertices = leafObj.GetComponent&lt;MeshFilter&gt;().mesh.vertexCount;</div><div class="line"></div><div class="line">	<span class="comment">//Find a list with vertices left, leafs are critical because have more vertices</span></div><div class="line">	List&lt;GameObject&gt; combinedLeafList = TutorialCreateForest.current.combinedLeafList;</div><div class="line">	List&lt;GameObject&gt; combinedWoodList = TutorialCreateForest.current.combinedWoodList;</div><div class="line"></div><div class="line">	<span class="keyword">bool</span> hasFoundCombinedMesh = <span class="literal">false</span>;</div><div class="line"></div><div class="line">	<span class="comment">//Search through all lists and see if we have a list that has room for more vertices</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; combinedLeafList.Count; i++)</div><div class="line">	&#123;</div><div class="line">		MeshFilter combinedMeshFilter = combinedLeafList[i].GetComponent&lt;MeshFilter&gt;();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> vertices = combinedMeshFilter.mesh.vertexCount;</div><div class="line"></div><div class="line">		<span class="comment">//This mesh has room for more vertices</span></div><div class="line">		<span class="keyword">if</span> (vertices + leafVertices &lt; TutorialCreateForest.current.vertexLimit)</div><div class="line">		&#123;</div><div class="line">			hasFoundCombinedMesh = <span class="literal">true</span>;</div><div class="line"></div><div class="line">			<span class="comment">//Add the current wood and leaf to the combined mesh that has room for them</span></div><div class="line">			AddMeshToCombinedMesh(leafObj, combinedLeafList[i]);</div><div class="line">			AddMeshToCombinedMesh(woodObj, combinedWoodList[i]);</div><div class="line"></div><div class="line">			<span class="comment">//Add the list number to the tree object</span></div><div class="line">			newTree.GetComponent&lt;TreeData&gt;().listPos = i;</div><div class="line"></div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//We need to create a new combined mesh because all meshes are full</span></div><div class="line">	<span class="keyword">if</span> (!hasFoundCombinedMesh)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//Wood</span></div><div class="line">		GameObject newMeshHolderWood = Instantiate(TutorialCreateForest.current.combinedWoodObj) <span class="keyword">as</span> GameObject;</div><div class="line"></div><div class="line">		newMeshHolderWood.transform.parent = TutorialCreateForest.current.combinedMeshParent;</div><div class="line"></div><div class="line">		combinedWoodList.Add(newMeshHolderWood);</div><div class="line"></div><div class="line">		<span class="comment">//Leaf</span></div><div class="line">		GameObject newMeshHolderLeaf = Instantiate(TutorialCreateForest.current.combinedLeafObj) <span class="keyword">as</span> GameObject;</div><div class="line"></div><div class="line">		newMeshHolderLeaf.transform.parent = TutorialCreateForest.current.combinedMeshParent;</div><div class="line"></div><div class="line">		combinedLeafList.Add(newMeshHolderLeaf);</div><div class="line"></div><div class="line"></div><div class="line">		<span class="comment">//Add the current wood and leaf to the new combined meshes we just created</span></div><div class="line">		AddMeshToCombinedMesh(leafObj, newMeshHolderLeaf);</div><div class="line">		AddMeshToCombinedMesh(woodObj, newMeshHolderWood);</div><div class="line"></div><div class="line">		<span class="comment">//Add the list number to the tree object</span></div><div class="line">		newTree.GetComponent&lt;TreeData&gt;().listPos = combinedLeafList.Count - <span class="number">1</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	newTree.SetActive(<span class="literal">false</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Adds one mesh to a combined mesh </span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddMeshToCombinedMesh</span>(<span class="params">Transform objToAdd, GameObject combinedMesh</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//Create a new array that will hold the mesh data</span></div><div class="line">	CombineInstance[] combined = <span class="keyword">new</span> CombineInstance[<span class="number">2</span>];</div><div class="line"></div><div class="line">	combined[<span class="number">0</span>].mesh = objToAdd.GetComponent&lt;MeshFilter&gt;().mesh;</div><div class="line">	combined[<span class="number">0</span>].transform = objToAdd.transform.localToWorldMatrix;</div><div class="line"></div><div class="line">	combined[<span class="number">1</span>].mesh = combinedMesh.GetComponent&lt;MeshFilter&gt;().mesh;</div><div class="line">	combined[<span class="number">1</span>].transform = combinedMesh.transform.localToWorldMatrix;</div><div class="line"></div><div class="line">	<span class="comment">//Create the new mesh</span></div><div class="line">	Mesh newMesh = <span class="keyword">new</span> Mesh();</div><div class="line">	newMesh.CombineMeshes(combined);</div><div class="line"></div><div class="line">	<span class="comment">//Add it to the combined mesh holder</span></div><div class="line">	combinedMesh.GetComponent&lt;MeshFilter&gt;().mesh = newMesh;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In a similar way as when we added the trees from the randomly generated forest, we are searching through the list of all combined meshes and see if the tree we want to add fit into that mesh (rememeber that our vertice limit is 30000). If not any combined mesh has any room for it, we have to create a new combined mesh and add the tree to it.</p>
<p>That’s it! You have now created a fantastic Tree Brush tool like in Cities: Skylines! If you press Play you should be able to add and remove trees and you can also notice that the number of batches is constantly around 200. You will notice that the number of batches increase when we add more trees, but decreases over time as the new trees are being combined into a mesh.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tospan.me/2017/02/05/Unity-Dynamic-Mesh-Combining/" data-id="ciyu4ntf600172tvw7afczkgf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unity/">Unity</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/02/05/Unity-Game-programming-patterns/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Game programming patterns
        
      </div>
    </a>
  
  
    <a href="/2017/02/05/Unity-Make-a-realistic-bullets/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Unity Make a realistic bullets</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unity/">Unity</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Basics/">Basics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Games/">Games</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Geometry/">Geometry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linear-Algebra/">Linear Algebra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Numerical-Analysis/">Numerical Analysis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/default/">default</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Basics/" style="font-size: 15px;">Basics</a> <a href="/tags/C/" style="font-size: 13.33px;">C#</a> <a href="/tags/Games/" style="font-size: 10px;">Games</a> <a href="/tags/Geometry/" style="font-size: 11.67px;">Geometry</a> <a href="/tags/Linear-Algebra/" style="font-size: 16.67px;">Linear Algebra</a> <a href="/tags/Math/" style="font-size: 18.33px;">Math</a> <a href="/tags/Numerical-Analysis/" style="font-size: 10px;">Numerical Analysis</a> <a href="/tags/Unity/" style="font-size: 20px;">Unity</a> <a href="/tags/default/" style="font-size: 10px;">default</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/06/Math-3D/">3D数学</a>
          </li>
        
          <li>
            <a href="/2017/02/06/Unity-Engine-Core-Concept/">Unity引擎重要概念</a>
          </li>
        
          <li>
            <a href="/2017/02/06/Unity-Scripting-2D-Code-Snippet/">Unity编程 2D脚本常用代码集合</a>
          </li>
        
          <li>
            <a href="/2017/02/06/Unity-Scripting-Core/">Unity编程要点</a>
          </li>
        
          <li>
            <a href="/2017/02/06/C-Sharp-Essential/">C#要点</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 To Span<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>